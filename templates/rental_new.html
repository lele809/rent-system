{% extends "base_new.html" %}

{% block title %}å…­æ¥¼ç®¡ç† - ç§Ÿæˆ¿ç®¡ç† - ç§Ÿæˆ¿ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block page_title %}å…­æ¥¼ç®¡ç† - ç§Ÿæˆ¿ç®¡ç†{% endblock %}

{% block breadcrumb %}
    <div class="breadcrumb-container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index6') }}"><i class="fas fa-home"></i> ä¸»é¡µ</a></li>
                <li class="breadcrumb-item active">ç§Ÿæˆ¿ç®¡ç†</li>
            </ol>
        </nav>
    </div>
{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/rental.css') }}">
{% endblock %}

{% block content %}
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="rental-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h2><i class="fas fa-building me-3"></i> ç§Ÿæˆ¿ç®¡ç†</h2>
                <p><i class="fas fa-info-circle me-2"></i>ç®¡ç†äº”æ¥¼æ‰€æœ‰æˆ¿é—´çš„ç§Ÿèµä¿¡æ¯å’Œç¼´è´¹çŠ¶æ€</p>
            </div>
            <div class="col-md-4 text-end">
                <div class="header-stats">
                    <div class="stat-item">
                        <i class="fas fa-calendar-alt"></i>
                        <span>{{ moment().format('YYYYå¹´MMæœˆDDæ—¥') if moment else 'ä»Šæ—¥' }}</span>
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-clock"></i>
                        <span id="currentTime"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
    <div class="row stats-row">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card">
                <div class="stats-icon total">
                    <i class="fas fa-home"></i>
                </div>
                <div class="stats-number">{{ rental_list|length }}</div>
                <div class="stats-label">æ€»æˆ¿é—´æ•°</div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card">
                <div class="stats-icon occupied">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stats-number">{{ rental_list|selectattr('check_out_date', 'none')|list|length }}</div>
                <div class="stats-label">å·²å…¥ä½æˆ¿é—´</div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card">
                <div class="stats-icon paid">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stats-number">{{ rental_list|selectattr('payment_status', 'equalto', 1)|list|length }}</div>
                <div class="stats-label">å·²ç¼´è´¹æˆ¿é—´</div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card">
                <div class="stats-icon unpaid">
                    <i class="fas fa-exclamation-circle"></i>
                </div>
                <div class="stats-number">{{ rental_list|selectattr('payment_status', 'equalto', 2)|list|length }}</div>
                <div class="stats-label">æœªç¼´è´¹æˆ¿é—´</div>
            </div>
        </div>
    </div>

    <!-- æœç´¢å’Œç­›é€‰åŒºåŸŸ -->
    <div class="search-section">
        <div class="row align-items-center mb-4">
            <div class="col-lg-4 col-md-6 mb-3">
                <div class="search-wrapper">
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" class="form-control search-input"
                               placeholder="ğŸ” æœç´¢æˆ¿é—´å·ã€ç§Ÿå®¢å§“å..."
                               id="searchInput"
                               autocomplete="off">
                        <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()"
                                title="æ¸…é™¤æœç´¢">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="search-suggestions" id="searchSuggestions" style="display: none;">
                        <!-- æœç´¢å»ºè®®å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                    </div>
                </div>
            </div>

            <!-- æ—¥æœŸç­›é€‰ -->
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="date-filter-wrapper">
                    <label class="form-label small text-muted mb-1">
                        <i class="fas fa-calendar-alt"></i> æŒ‰æœˆä»½ç­›é€‰
                    </label>
                    <div class="input-group">
                        <select class="form-select" id="yearFilter">
                            <option value="">é€‰æ‹©å¹´ä»½</option>
                        </select>
                        <select class="form-select" id="monthFilter">
                            <option value="">é€‰æ‹©æœˆä»½</option>
                            <option value="1">1æœˆ</option>
                            <option value="2">2æœˆ</option>
                            <option value="3">3æœˆ</option>
                            <option value="4">4æœˆ</option>
                            <option value="5">5æœˆ</option>
                            <option value="6">6æœˆ</option>
                            <option value="7">7æœˆ</option>
                            <option value="8">8æœˆ</option>
                            <option value="9">9æœˆ</option>
                            <option value="10">10æœˆ</option>
                            <option value="11">11æœˆ</option>
                            <option value="12">12æœˆ</option>
                        </select>
                        <button class="btn btn-outline-primary" type="button" onclick="clearDateFilter()"
                                title="æ¸…é™¤æ—¥æœŸç­›é€‰">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-lg-5 col-md-12">
                <div class="action-buttons d-flex flex-wrap gap-2 justify-content-end">
                    <div class="btn-group" role="group">
                        <button class="btn btn-success" onclick="exportBills('all')" title="å¯¼å‡ºæ‰€æœ‰è´¦å•">
                            <i class="fas fa-file-excel me-1"></i> å¯¼å‡ºè´¦å•
                        </button>
                        <button type="button" class="btn btn-success dropdown-toggle dropdown-toggle-split"
                                data-bs-toggle="dropdown" aria-expanded="false">
                            <span class="visually-hidden">æ›´å¤šé€‰é¡¹</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" onclick="exportBills('paid')">
                                <i class="fas fa-check text-success me-2"></i> å¯¼å‡ºå·²ç¼´è´¹è´¦å•</a></li>
                            <li><a class="dropdown-item" href="#" onclick="exportBills('unpaid')">
                                <i class="fas fa-times text-danger me-2"></i> å¯¼å‡ºæœªç¼´è´¹è´¦å•</a></li>
                            <li><a class="dropdown-item" href="#" onclick="exportBills('current_month')">
                                <i class="fas fa-calendar text-info me-2"></i> å¯¼å‡ºæœ¬æœˆè´¦å•</a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item" href="#" onclick="showBillSummary()">
                                <i class="fas fa-chart-bar text-primary me-2"></i> è´¦å•æ±‡æ€»æŠ¥è¡¨</a></li>
                        </ul>
                    </div>
                    <button class="btn btn-primary add-rental-btn" onclick="addRental()">
                        <i class="fas fa-plus me-1"></i> æ·»åŠ æ”¶è´¹è®°å½•
                    </button>
                </div>
            </div>
        </div>

        <!-- æ—¥æœŸç­›é€‰ä¿¡æ¯ -->
        <div id="dateFilterInfo" class="date-filter-info" style="display: none;">
            <i class="fas fa-calendar-check"></i>
            <span id="dateFilterText">æ­£åœ¨æ˜¾ç¤ºå…¨éƒ¨æ•°æ®</span>
        </div>

        <!-- ç­›é€‰æŒ‰é’® -->
        <div class="filter-buttons">
            <button class="btn btn-outline-primary filter-btn active" data-filter="all">
                <i class="fas fa-list"></i> å…¨éƒ¨
            </button>
            <button class="btn btn-outline-success filter-btn" data-filter="paid">
                <i class="fas fa-check"></i> å·²ç¼´è´¹
            </button>
            <button class="btn btn-outline-danger filter-btn" data-filter="unpaid">
                <i class="fas fa-times"></i> æœªç¼´è´¹
            </button>
            <button class="btn btn-outline-warning filter-btn" data-filter="occupied">
                <i class="fas fa-user"></i> å·²å…¥ä½
            </button>
            <button class="btn btn-outline-secondary filter-btn" data-filter="vacant">
                <i class="fas fa-door-open"></i> å·²é€€æˆ¿
            </button>
        </div>
    </div>

    <!-- ç§Ÿæˆ¿ä¿¡æ¯åˆ—è¡¨ -->
    <div class="rental-table">
        {% if rental_list %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                    <tr>
                        <th>åºå·</th>
                        <th>æˆ¿é—´å·</th>
                        <th>ç§Ÿå®¢å§“å</th>
                        <th>æŠ¼é‡‘</th>
                        <th>æœˆç§Ÿé‡‘</th>
                        <th>æ°´ç”µè´¹</th>
                        <th>åº”ç¼´è´¹</th>
                        <th>ç¼´è´¹çŠ¶æ€</th>
                        <th>åˆ›å»ºæ—¶é—´</th>
                        <th>å¤‡æ³¨</th>
                        <th>æ“ä½œ</th>
                    </tr>
                    </thead>
                    <tbody id="rentalTableBody">
                    {% for rental in rental_list %}
                        <tr class="rental-row"
                            data-search="{{ rental.room_number }}{{ rental.tenant_name }}"
                            data-status="{{ 'paid' if rental.payment_status == 1 else 'unpaid' }}"
                            data-occupancy="{{ 'occupied' if not rental.check_out_date else 'vacant' }}">
                            <td>{{ loop.index }}</td>
                            <td>
                                <span class="room-badge">
                                    <i class="fas fa-door-open me-1"></i>{{ rental.room_number }}
                                </span>
                            </td>
                            <td class="tenant-name">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-user me-2 text-muted"></i>
                                    <span>{{ rental.tenant_name }}</span>
                                </div>
                            </td>
                            <td class="money-amount amount-positive">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-piggy-bank me-2 text-muted"></i>
                                    <span>Â¥{{ "%.2f"|format(rental.deposit|float) }}</span>
                                </div>
                            </td>
                            <td class="money-amount amount-positive">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-home me-2 text-muted"></i>
                                    <span>Â¥{{ "%.2f"|format(rental.monthly_rent|float) }}</span>
                                </div>
                            </td>
                            <td class="money-amount">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-bolt me-2 text-muted"></i>
                                    <span>Â¥{{ "%.2f"|format(rental.utilities_fee|float) }}</span>
                                </div>
                            </td>
                            <td class="money-amount amount-positive">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-calculator me-2 text-muted"></i>
                                    <span>Â¥{{ "%.2f"|format(rental.total_due|float) }}</span>
                                </div>
                            </td>
                            <td>
                                {% if rental.payment_status == 1 %}
                                    <span class="payment-status status-paid">
                                <i class="fas fa-check"></i> å·²ç¼´è´¹
                            </span>
                                {% else %}
                                    <span class="payment-status status-unpaid">
                                <i class="fas fa-times"></i> æœªç¼´è´¹
                            </span>
                                {% endif %}
                            </td>
                            <td class="created-time">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-clock me-2 text-muted"></i>
                                    <div class="time-info">
                                        <div class="date-text">{{ rental.created_at.strftime('%Y-%m-%d') if rental.created_at else '-' }}</div>
                                        <small class="time-text text-muted">{{ rental.created_at.strftime('%H:%M:%S') if rental.created_at else '' }}</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                {% if rental.remarks %}
                                    <span class="remarks-text" title="{{ rental.remarks }}">{{ rental.remarks }}</span>
                                {% else %}
                                    <span class="text-muted">æ— </span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group-vertical btn-group-sm" role="group">
                                    <button class="btn btn-primary btn-action btn-sm mb-1"
                                            onclick="viewRental({{ rental.id }})"
                                            title="æŸ¥çœ‹è¯¦æƒ…">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-info btn-action btn-sm mb-1"
                                            onclick="viewBill({{ rental.id }}, '{{ rental.room_number }}')"
                                            title="æŸ¥çœ‹è´¦å•">
                                        <i class="fas fa-file-invoice"></i>
                                    </button>
                                    <button class="btn btn-warning btn-action btn-sm mb-1"
                                            onclick="editRental({{ rental.id }})"
                                            title="ç¼–è¾‘">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    {% if rental.payment_status == 2 %}
                                        <button class="btn btn-success btn-action btn-sm mb-1"
                                                onclick="showMarkAsPaidModal({{ rental.id }}, '{{ rental.room_number }}', '{{ rental.tenant_name }}', {{ rental.total_due }})"
                                                title="æ ‡è®°å·²ç¼´è´¹">
                                            <i class="fas fa-money-bill"></i>
                                        </button>
                                    {% endif %}
                                    <button class="btn btn-danger btn-action btn-sm"
                                            onclick="deleteRental({{ rental.id }}, '{{ rental.room_number }}')"
                                            title="åˆ é™¤">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="empty-state">
                <i class="fas fa-building"></i>
                <h4>æš‚æ— ç§Ÿæˆ¿è®°å½•</h4>
                <p>è¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•ç§Ÿæˆ¿è®°å½•ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æ·»åŠ </p>
                <button class="btn btn-primary add-rental-btn" onclick="addRental()">
                    <i class="fas fa-plus"></i> æ·»åŠ ç¬¬ä¸€ä¸ªç§Ÿæˆ¿è®°å½•
                </button>
            </div>
        {% endif %}
    </div>

    <!-- è´¦å•æŸ¥çœ‹æ¨¡æ€æ¡† -->
    <div class="modal fade" id="billModal" tabindex="-1" aria-labelledby="billModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="billModalLabel">
                        <i class="fas fa-file-invoice"></i> ç¼´è´¹è´¦å•è¯¦æƒ…
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <div class="modal-body" id="billModalBody">
                    <!-- è´¦å•å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">åŠ è½½ä¸­...</span>
                        </div>
                        <p class="mt-2">æ­£åœ¨åŠ è½½è´¦å•ä¿¡æ¯...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> å…³é—­
                    </button>
                    <button type="button" class="btn btn-success" onclick="printBill()">
                        <i class="fas fa-print"></i> æ‰“å°è´¦å•
                    </button>
                    <button type="button" class="btn btn-primary" onclick="downloadBillPDF()">
                        <i class="fas fa-download"></i> ä¸‹è½½PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- è´¦å•æ±‡æ€»æŠ¥è¡¨æ¨¡æ€æ¡† -->
    <div class="modal fade" id="billSummaryModal" tabindex="-1" aria-labelledby="billSummaryModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="billSummaryModalLabel">
                        <i class="fas fa-chart-bar"></i> è´¦å•æ±‡æ€»æŠ¥è¡¨
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <div class="modal-body" id="billSummaryModalBody">
                    <!-- æ±‡æ€»æŠ¥è¡¨å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                    <div class="text-center">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">åŠ è½½ä¸­...</span>
                        </div>
                        <p class="mt-2">æ­£åœ¨ç”Ÿæˆæ±‡æ€»æŠ¥è¡¨...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> å…³é—­
                    </button>
                    <button type="button" class="btn btn-primary" onclick="exportSummaryExcel()">
                        <i class="fas fa-file-excel"></i> å¯¼å‡ºExcel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ ‡è®°å·²ç¼´è´¹ç¡®è®¤æ¨¡æ€æ¡† -->
    <div class="modal fade" id="markAsPaidModal" tabindex="-1" aria-labelledby="markAsPaidModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="markAsPaidModalLabel">
                        <i class="fas fa-money-bill"></i> æ ‡è®°å·²ç¼´è´¹
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <div class="modal-body" id="markAsPaidModalBody">
                    <!-- å†…å®¹å°†é€šè¿‡JavaScriptå¡«å…… -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> å–æ¶ˆ
                    </button>
                    <button type="button" class="btn btn-success" id="confirmMarkAsPaidBtn">
                        <i class="fas fa-check"></i> ç¡®è®¤æ ‡è®°å·²ç¼´è´¹
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ ç§Ÿæˆ¿è®°å½•æ¨¡æ€æ¡† -->
    <div class="modal fade" id="addRentalModal" tabindex="-1" aria-labelledby="addRentalModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="addRentalModalLabel">
                        <i class="fas fa-plus"></i> æ·»åŠ æ”¶è´¹è®°å½•
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addRentalForm" novalidate>
                        <div class="row">
                            <!-- åŸºæœ¬ä¿¡æ¯ -->
                            <div class="col-md-6">
                                <h6 class="text-primary mb-3"><i class="fas fa-info-circle"></i> åŸºæœ¬ä¿¡æ¯</h6>
                                <div class="mb-3">
                                    <label for="roomNumber" class="form-label">æˆ¿é—´å· <span class="text-danger">*</span></label>
                                    <select class="form-select" id="roomNumber" name="roomNumber" required>
                                        <option value="">è¯·é€‰æ‹©å·²å‡ºç§Ÿæˆ¿é—´</option>
                                    </select>
                                    <div class="invalid-feedback">è¯·é€‰æ‹©æˆ¿é—´å·</div>
                                    <div class="form-text text-muted">
                                        <i class="fas fa-info-circle"></i> åªæ˜¾ç¤ºå·²å‡ºç§ŸçŠ¶æ€çš„æˆ¿é—´
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="tenantName" class="form-label">ç§Ÿå®¢å§“å <span
                                            class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="tenantName" name="tenantName" required
                                           readonly>
                                    <div class="invalid-feedback">è¯·é€‰æ‹©æˆ¿é—´å·ä»¥è‡ªåŠ¨å¡«å…¥ç§Ÿå®¢å§“å</div>
                                    <div class="form-text text-muted">
                                        <i class="fas fa-info-circle"></i> é€‰æ‹©æˆ¿é—´å·åè‡ªåŠ¨å¡«å…¥å¯¹åº”ç§Ÿå®¢å§“å
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="deposit" class="form-label">æŠ¼é‡‘ (å…ƒ)</label>
                                    <input type="number" class="form-control" id="deposit" name="deposit" min="0"
                                           step="0.01" value="0" readonly>
                                    <div class="form-text text-muted">
                                        <i class="fas fa-lock"></i> æŠ¼é‡‘é‡‘é¢è‡ªåŠ¨ä»ç§Ÿæˆ¿ä¿¡æ¯è·å–ï¼Œä¸å¯ä¿®æ”¹
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="paymentStatus" class="form-label">ç¼´è´¹çŠ¶æ€</label>
                                    <select class="form-select" id="paymentStatus" name="paymentStatus">
                                        <option value="2">æœªç¼´è´¹</option>
                                        <option value="1">å·²ç¼´è´¹</option>
                                    </select>
                                </div>
                            </div>

                            <!-- è´¹ç”¨ä¿¡æ¯ -->
                            <div class="col-md-6">
                                <h6 class="text-success mb-3"><i class="fas fa-money-bill"></i> è´¹ç”¨ä¿¡æ¯</h6>
                                <div class="mb-3">
                                    <label for="monthlyRent" class="form-label">æœˆç§Ÿé‡‘ (å…ƒ) <span
                                            class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="monthlyRent" name="monthlyRent"
                                           min="0" step="0.01" required readonly>
                                    <div class="invalid-feedback">è¯·è¾“å…¥æœˆç§Ÿé‡‘</div>
                                    <div class="form-text text-muted">
                                        <i class="fas fa-lock"></i> æœˆç§Ÿé‡‘è‡ªåŠ¨ä»ç§Ÿæˆ¿ä¿¡æ¯è·å–ï¼Œä¸å¯ä¿®æ”¹
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="waterFee" class="form-label">ç”¨æ°´é‡ (æ–¹)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="waterFee" name="waterFee"
                                               min="0" step="0.1" value="0" placeholder="è¯·è¾“å…¥ç”¨æ°´é‡">
                                        <span class="input-group-text">
                                            <i class="fas fa-tint text-info" data-bs-toggle="tooltip"
                                               title="æ°´è´¹å•ä»·: 3.5å…ƒ/æ–¹ï¼Œè‡ªåŠ¨è®¡ç®—è´¹ç”¨"></i>
                                        </span>
                                    </div>
                                    <small class="form-text text-muted">
                                        <i class="fas fa-tint text-info"></i> è¾“å…¥ç”¨æ°´é‡ï¼Œç³»ç»Ÿå°†æŒ‰3.5å…ƒ/æ–¹è‡ªåŠ¨è®¡ç®—æ°´è´¹
                                    </small>
                                </div>
                                <div class="mb-3">
                                    <label for="electricityFee" class="form-label">ç”¨ç”µé‡ (åº¦)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="electricityFee"
                                               name="electricityFee"
                                               min="0" step="0.1" value="0" placeholder="è¯·è¾“å…¥ç”¨ç”µé‡">
                                        <span class="input-group-text">
                                            <i class="fas fa-bolt text-warning" data-bs-toggle="tooltip"
                                               title="ç”µè´¹å•ä»·: 1.2å…ƒ/åº¦ï¼Œè‡ªåŠ¨è®¡ç®—è´¹ç”¨"></i>
                                        </span>
                                    </div>
                                    <small class="form-text text-muted">
                                        <i class="fas fa-bolt text-warning"></i> è¾“å…¥ç”¨ç”µé‡ï¼Œç³»ç»Ÿå°†æŒ‰1.2å…ƒ/åº¦è‡ªåŠ¨è®¡ç®—ç”µè´¹
                                    </small>
                                </div>
                                <div class="mb-3">
                                    <label for="totalDue" class="form-label">åº”ç¼´è´¹æ€»é¢ (å…ƒ)</label>
                                    <input type="number" class="form-control" id="totalDue" name="totalDue" readonly>
                                    <small class="form-text text-muted">è‡ªåŠ¨è®¡ç®—ï¼šæœˆç§Ÿé‡‘ + (ç”¨æ°´é‡Ã—3.5) +
                                        (ç”¨ç”µé‡Ã—1.2)</small>
                                </div>
                            </div>
                        </div>

                        <!-- æ—¥æœŸä¿¡æ¯ -->
                        <div class="row">
                            <div class="col-12">
                                <h6 class="text-info mb-3"><i class="fas fa-calendar"></i> æ—¥æœŸä¿¡æ¯</h6>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="checkInDate" class="form-label">å…¥ä½æ—¥æœŸ</label>
                                    <input type="date" class="form-control" id="checkInDate" name="checkInDate"
                                           readonly>
                                    <div class="form-text text-muted">
                                        <i class="fas fa-lock"></i> å…¥ä½æ—¥æœŸè‡ªåŠ¨ä»ç§Ÿæˆ¿ä¿¡æ¯è·å–ï¼Œä¸å¯ä¿®æ”¹
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- å¤‡æ³¨ -->
                        <div class="row">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label for="remarks" class="form-label">å¤‡æ³¨</label>
                                    <textarea class="form-control" id="remarks" name="remarks" rows="3"
                                              placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯..."></textarea>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> å–æ¶ˆ
                    </button>
                    <button type="button" class="btn btn-primary" id="saveRentalBtn">
                        <i class="fas fa-save"></i> ä¿å­˜
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function () {
            // åˆå§‹åŒ–æ—¶é—´æ˜¾ç¤º
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);

            // æ·»åŠ è¡¨æ ¼è¡Œçš„äº¤é”™åŠ¨ç”»
            setTimeout(() => {
                const rows = document.querySelectorAll('.rental-row');
                rows.forEach((row, index) => {
                    row.style.animationDelay = `${index * 0.1}s`;
                    row.style.animation = 'fadeInUp 0.6s ease-out both';
                });
            }, 100);

            // åˆå§‹åŒ–æœç´¢å»ºè®®
            initSearchSuggestions();

            // æ·»åŠ ç»Ÿè®¡å¡ç‰‡åŠ¨ç”»
            setTimeout(() => {
                const statsCards = document.querySelectorAll('.stats-card');
                statsCards.forEach((card, index) => {
                    card.style.animationDelay = `${index * 0.2}s`;
                    card.style.animation = 'fadeInUp 0.6s ease-out both';
                });
            }, 200);

            // åˆå§‹åŒ–æ·»åŠ ç§Ÿæˆ¿è®°å½•è¡¨å•
            initAddRentalForm();

            // åˆå§‹åŒ–æˆ¿é—´é€‰æ‹©äº‹ä»¶å¤„ç†å™¨
            setupRoomSelectHandler();

            // åˆå§‹åŒ–æ—¥æœŸç­›é€‰å™¨
            initDateFilter();

            // åˆå§‹åŒ–Bootstrap tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });

        // åˆå§‹åŒ–æ·»åŠ ç§Ÿæˆ¿è®°å½•è¡¨å•
        function initAddRentalForm() {
            const monthlyRentInput = document.getElementById('monthlyRent');
            const waterFeeInput = document.getElementById('waterFee');
            const electricityFeeInput = document.getElementById('electricityFee');
            const totalDueInput = document.getElementById('totalDue');
            const saveBtn = document.getElementById('saveRentalBtn');

            // è‡ªåŠ¨è®¡ç®—æ€»è´¹ç”¨
            function calculateTotalDue() {
                const monthlyRent = parseFloat(monthlyRentInput.value) || 0;
                const waterUsage = parseFloat(waterFeeInput.value) || 0;
                const electricityUsage = parseFloat(electricityFeeInput.value) || 0;

                // æ ¹æ®ç”¨é‡å’Œå•ä»·è®¡ç®—è´¹ç”¨
                const waterFee = waterUsage * 3.5; // æ°´è´¹ï¼š3.5å…ƒ/æ–¹
                const electricityFee = electricityUsage * 1.2; // ç”µè´¹ï¼š1.2å…ƒ/åº¦
                const totalUtilitiesFee = waterFee + electricityFee;

                const totalDue = monthlyRent + totalUtilitiesFee;
                totalDueInput.value = totalDue.toFixed(2);
            }

            // ç›‘å¬è´¹ç”¨è¾“å…¥å˜åŒ–
            monthlyRentInput.addEventListener('input', calculateTotalDue);
            waterFeeInput.addEventListener('input', calculateTotalDue);
            electricityFeeInput.addEventListener('input', calculateTotalDue);

            // ä¿å­˜æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            saveBtn.addEventListener('click', function () {
                const form = document.getElementById('addRentalForm');

                // éªŒè¯è¡¨å•
                if (!form.checkValidity()) {
                    form.classList.add('was-validated');
                    return;
                }

                // æ”¶é›†è¡¨å•æ•°æ®
                const formData = new FormData(form);

                // è®¡ç®—å®é™…è´¹ç”¨
                const waterUsage = parseFloat(formData.get('waterFee')) || 0;
                const electricityUsage = parseFloat(formData.get('electricityFee')) || 0;
                const waterFee = waterUsage * 3.5; // æ°´è´¹ï¼š3.5å…ƒ/æ–¹
                const electricityFee = electricityUsage * 1.2; // ç”µè´¹ï¼š1.2å…ƒ/åº¦

                const data = {
                    room_number: formData.get('roomNumber'),
                    tenant_name: formData.get('tenantName'),
                    deposit: formData.get('deposit'),
                    monthly_rent: formData.get('monthlyRent'),
                    water_fee: waterFee.toFixed(2),
                    electricity_fee: electricityFee.toFixed(2),
                    utilities_fee: (waterFee + electricityFee).toFixed(2),
                    payment_status: formData.get('paymentStatus'),
                    check_in_date: formData.get('checkInDate') || null,
                    check_out_date: formData.get('checkOutDate') || null,
                    contract_start_date: formData.get('contractStartDate') || null,
                    contract_end_date: formData.get('contractEndDate') || null,
                    remarks: formData.get('remarks')
                };

                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const loading = showLoading();
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ä¿å­˜ä¸­...';

                // å‘é€è¯·æ±‚
                fetch('/api/rental_new', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                })
                    .then(response => response.json())
                    .then(result => {
                        hideLoading(loading);
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = '<i class="fas fa-save"></i> ä¿å­˜';

                        if (result.success) {
                            showMessage('ç§Ÿæˆ¿è®°å½•æ·»åŠ æˆåŠŸ', 'success');
                            // å…³é—­æ¨¡æ€æ¡†
                            const modal = bootstrap.Modal.getInstance(document.getElementById('addRentalModal'));
                            modal.hide();
                            // åˆ·æ–°é¡µé¢
                            setTimeout(() => location.reload(), 1500);
                        } else {
                            showMessage('æ·»åŠ å¤±è´¥ï¼š' + result.message, 'error');
                        }
                    })
                    .catch(error => {
                        hideLoading(loading);
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = '<i class="fas fa-save"></i> ä¿å­˜';
                        console.error('Error:', error);
                        showMessage('æ·»åŠ å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                    });
            });
        }

        // æ›´æ–°å½“å‰æ—¶é—´
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            const timeElement = document.getElementById('currentTime');
            if (timeElement) {
                timeElement.textContent = timeString;
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯æç¤º
        function showMessage(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `message-toast ${type}`;
            toast.innerHTML = `
                <i class="fas ${getMessageIcon(type)} me-2"></i>
                ${message}
            `;
            document.body.appendChild(toast);

            // æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => toast.classList.add('show'), 100);

            // è‡ªåŠ¨éšè—
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        // è·å–æ¶ˆæ¯å›¾æ ‡
        function getMessageIcon(type) {
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };
            return icons[type] || icons.info;
        }

        // é«˜äº®è¡¨æ ¼è¡Œ
        function highlightRow(rowElement) {
            rowElement.classList.add('highlight');
            setTimeout(() => rowElement.classList.remove('highlight'), 2000);
        }

        // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
        function showLoading() {
            const overlay = document.createElement('div');
            overlay.className = 'loading-overlay';
            overlay.innerHTML = `
                <div class="loading-spinner"></div>
            `;
            document.body.appendChild(overlay);
            return overlay;
        }

        // éšè—åŠ è½½åŠ¨ç”»
        function hideLoading(overlay) {
            if (overlay && overlay.parentNode) {
                overlay.parentNode.removeChild(overlay);
            }
        }

        // åˆå§‹åŒ–æœç´¢å»ºè®®
        function initSearchSuggestions() {
            const searchInput = document.getElementById('searchInput');
            const suggestionsContainer = document.getElementById('searchSuggestions');

            // è·å–æ‰€æœ‰æˆ¿é—´å·å’Œç§Ÿå®¢å§“åç”¨äºå»ºè®®
            const allData = Array.from(document.querySelectorAll('.rental-row')).map(row => {
                const searchData = row.getAttribute('data-search');
                const roomNumber = row.querySelector('.room-badge').textContent.trim();
                const tenantName = row.querySelector('.tenant-name span').textContent.trim();
                return {roomNumber, tenantName, searchData};
            });

            searchInput.addEventListener('input', function () {
                const value = this.value.toLowerCase().trim();
                if (value.length > 0) {
                    showSearchSuggestions(value, allData, suggestionsContainer);
                } else {
                    hideSuggestions(suggestionsContainer);
                }
                filterTable();
            });

            // ç‚¹å‡»å¤–éƒ¨éšè—å»ºè®®
            document.addEventListener('click', function (e) {
                if (!searchInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                    hideSuggestions(suggestionsContainer);
                }
            });
        }

        // æ˜¾ç¤ºæœç´¢å»ºè®®
        function showSearchSuggestions(query, allData, container) {
            const suggestions = allData.filter(item =>
                item.searchData.toLowerCase().includes(query)
            ).slice(0, 5); // æœ€å¤šæ˜¾ç¤º5ä¸ªå»ºè®®

            if (suggestions.length > 0) {
                container.innerHTML = suggestions.map(item => `
                    <div class="search-suggestion-item" onclick="selectSuggestion('${item.roomNumber}')">
                        <i class="fas fa-search"></i>
                        <span>${item.roomNumber} - ${item.tenantName}</span>
                    </div>
                `).join('');
                container.style.display = 'block';
            } else {
                hideSuggestions(container);
            }
        }

        // éšè—å»ºè®®
        function hideSuggestions(container) {
            container.style.display = 'none';
        }

        // é€‰æ‹©å»ºè®®
        function selectSuggestion(value) {
            const searchInput = document.getElementById('searchInput');
            const suggestionsContainer = document.getElementById('searchSuggestions');
            searchInput.value = value;
            hideSuggestions(suggestionsContainer);
            filterTable();
            searchInput.focus();
        }

        // æ¸…é™¤æœç´¢
        function clearSearch() {
            const searchInput = document.getElementById('searchInput');
            const suggestionsContainer = document.getElementById('searchSuggestions');
            searchInput.value = '';
            hideSuggestions(suggestionsContainer);
            searchInput.focus();
            filterTable();
        }

        // æœç´¢åŠŸèƒ½
        document.getElementById('searchInput').addEventListener('input', function () {
            const searchTerm = this.value.toLowerCase();
            filterTable();
        });

        // ç­›é€‰åŠŸèƒ½
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeç±»
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                // æ·»åŠ å½“å‰æŒ‰é’®çš„activeç±»
                this.classList.add('active');

                filterTable();
            });
        });

        // è¡¨æ ¼ç­›é€‰å‡½æ•°
        function filterTable() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const activeFilter = document.querySelector('.filter-btn.active').getAttribute('data-filter');
            const rows = document.querySelectorAll('.rental-row');

            rows.forEach(row => {
                const searchData = row.getAttribute('data-search').toLowerCase();
                const status = row.getAttribute('data-status');
                const occupancy = row.getAttribute('data-occupancy');

                let showRow = true;

                // æœç´¢ç­›é€‰
                if (searchTerm && !searchData.includes(searchTerm)) {
                    showRow = false;
                }

                // çŠ¶æ€ç­›é€‰
                if (activeFilter !== 'all') {
                    if (activeFilter === 'paid' && status !== 'paid') showRow = false;
                    if (activeFilter === 'unpaid' && status !== 'unpaid') showRow = false;
                    if (activeFilter === 'occupied' && occupancy !== 'occupied') showRow = false;
                    if (activeFilter === 'vacant' && occupancy !== 'vacant') showRow = false;
                }

                row.style.display = showRow ? '' : 'none';
            });

            // æ›´æ–°åºå·
            updateRowNumbers();
        }

        // æ›´æ–°è¡Œå·
        function updateRowNumbers() {
            const visibleRows = document.querySelectorAll('.rental-row[style=""], .rental-row:not([style])');
            visibleRows.forEach((row, index) => {
                row.querySelector('td:first-child').textContent = index + 1;
            });
        }

        // æ·»åŠ ç§Ÿæˆ¿è®°å½•
        function addRental() {
            // é‡ç½®è¡¨å•
            const form = document.getElementById('addRentalForm');
            form.reset();
            form.classList.remove('was-validated');

            // è®¾ç½®é»˜è®¤å€¼
            document.getElementById('deposit').value = '0';
            document.getElementById('waterFee').value = '0';
            document.getElementById('electricityFee').value = '0';
            document.getElementById('paymentStatus').value = '2';

            // åŠ è½½å·²å‡ºç§Ÿæˆ¿é—´åˆ—è¡¨
            loadRentedRooms();

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            const modal = new bootstrap.Modal(document.getElementById('addRentalModal'));
            modal.show();
        }

        // åŠ è½½å·²å‡ºç§Ÿæˆ¿é—´åˆ—è¡¨
        function loadRentedRooms() {
            const roomSelect = document.getElementById('roomNumber');

            // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼Œä¿ç•™é»˜è®¤é€‰é¡¹
            roomSelect.innerHTML = '<option value="">è¯·é€‰æ‹©å·²å‡ºç§Ÿæˆ¿é—´</option>';

            fetch('/api/rented_rooms_new')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.rooms) {
                        data.rooms.forEach(room => {
                            const option = document.createElement('option');
                            option.value = room.room_number;
                            option.textContent = `${room.room_number} - ${room.room_type} (åŸºç¡€ç§Ÿé‡‘: Â¥${room.base_rent})`;
                            option.dataset.roomId = room.id;
                            option.dataset.baseRent = room.base_rent;
                            option.dataset.roomType = room.room_type;
                            option.dataset.tenantName = room.tenant_name || '';
                            option.dataset.deposit = room.deposit || 0;
                            option.dataset.checkInDate = room.check_in_date || '';
                            roomSelect.appendChild(option);
                        });

                        if (data.rooms.length === 0) {
                            const option = document.createElement('option');
                            option.value = '';
                            option.textContent = 'æš‚æ— å·²å‡ºç§Ÿæˆ¿é—´';
                            option.disabled = true;
                            roomSelect.appendChild(option);
                        }
                    } else {
                        showMessage('åŠ è½½æˆ¿é—´åˆ—è¡¨å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                    }
                })
                .catch(error => {
                    console.error('Error loading rented rooms:', error);
                    showMessage('åŠ è½½æˆ¿é—´åˆ—è¡¨å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                });
        }

        // æˆ¿é—´é€‰æ‹©å˜åŒ–äº‹ä»¶
        function setupRoomSelectHandler() {
            const roomSelect = document.getElementById('roomNumber');
            const monthlyRentInput = document.getElementById('monthlyRent');
            const tenantNameInput = document.getElementById('tenantName');
            const depositInput = document.getElementById('deposit');
            const checkInDateInput = document.getElementById('checkInDate');

            roomSelect.addEventListener('change', function () {
                const selectedOption = this.options[this.selectedIndex];

                if (selectedOption.value && selectedOption.dataset.baseRent) {
                    // è‡ªåŠ¨å¡«å……åŸºç¡€ç§Ÿé‡‘
                    monthlyRentInput.value = selectedOption.dataset.baseRent;

                    // è‡ªåŠ¨å¡«å……ç§Ÿå®¢å§“å
                    if (selectedOption.dataset.tenantName) {
                        tenantNameInput.value = selectedOption.dataset.tenantName;
                    }

                    // è‡ªåŠ¨å¡«å……æŠ¼é‡‘
                    if (selectedOption.dataset.deposit) {
                        depositInput.value = selectedOption.dataset.deposit;
                    }

                    // è‡ªåŠ¨å¡«å……å…¥ä½æ—¥æœŸ
                    if (selectedOption.dataset.checkInDate) {
                        checkInDateInput.value = selectedOption.dataset.checkInDate;
                    }

                    // è§¦å‘æ€»è´¹ç”¨è®¡ç®—
                    const event = new Event('input', {bubbles: true});
                    monthlyRentInput.dispatchEvent(event);
                } else {
                    monthlyRentInput.value = '';
                    tenantNameInput.value = '';
                    depositInput.value = '0';
                    checkInDateInput.value = '';
                }
            });
        }

        // æŸ¥çœ‹ç§Ÿæˆ¿è¯¦æƒ…
        function viewRental(rentalId) {
            const loading = showLoading();

            // è·å–ç§Ÿæˆ¿è¯¦æƒ…
            fetch(`/api/rental_new/${rentalId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => response.json())
                .then(data => {
                    hideLoading(loading);
                    if (data.error) {
                        showMessage('è·å–è¯¦æƒ…å¤±è´¥ï¼š' + data.error, 'error');
                    } else {
                        showRentalDetailModal(data);
                    }
                })
                .catch(error => {
                    hideLoading(loading);
                    console.error('Error:', error);
                    showMessage('è·å–è¯¦æƒ…å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                });
        }

        // æŸ¥çœ‹è´¦å•è¯¦æƒ…
        function viewBill(rentalId, roomNumber) {
            const modal = new bootstrap.Modal(document.getElementById('billModal'));
            const modalBody = document.getElementById('billModalBody');
            const modalTitle = document.getElementById('billModalLabel');

            // æ›´æ–°æ¨¡æ€æ¡†æ ‡é¢˜
            modalTitle.innerHTML = `<i class="fas fa-file-invoice"></i> ${roomNumber} æˆ¿é—´ç¼´è´¹è´¦å•`;

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            modalBody.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">åŠ è½½ä¸­...</span>
                    </div>
                    <p class="mt-2">æ­£åœ¨åŠ è½½è´¦å•ä¿¡æ¯...</p>
                </div>
            `;

            modal.show();

            // æ¨¡æ‹Ÿè·å–è´¦å•æ•°æ®ï¼ˆå®é™…åº”è¯¥ä»åç«¯APIè·å–ï¼‰
            setTimeout(() => {
                loadBillContent(rentalId, roomNumber);
            }, 1000);
        }

        // åŠ è½½è´¦å•å†…å®¹
        function loadBillContent(rentalId, roomNumber) {
            // ä»åç«¯APIè·å–çœŸå®æ•°æ®
            fetch(`/api/rental_new/${rentalId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        const modalBody = document.getElementById('billModalBody');
                        modalBody.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i> è·å–è´¦å•æ•°æ®å¤±è´¥ï¼š${data.error}
                        </div>
                    `;
                    } else {
                        const billData = generateBillDataFromAPI(data);
                        const modalBody = document.getElementById('billModalBody');
                        modalBody.innerHTML = generateBillHTML(billData);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    const modalBody = document.getElementById('billModalBody');
                    modalBody.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i> è·å–è´¦å•æ•°æ®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•
                    </div>
                `;
                });
        }

        // ä»APIæ•°æ®ç”Ÿæˆè´¦å•æ•°æ®
        function generateBillDataFromAPI(apiData) {
            const currentDate = new Date();
            const billMonth = currentDate.toLocaleDateString('zh-CN', {year: 'numeric', month: 'long'});

            return {
                rentalId: apiData.id,
                roomNumber: apiData.room_number,
                tenantName: apiData.tenant_name,
                billMonth: billMonth,
                billDate: currentDate.toLocaleDateString('zh-CN'),
                monthlyRent: apiData.monthly_rent,
                utilities: {
                    water: apiData.water_fee || 0,
                    electricity: apiData.electricity_fee || 0,
                    waterUsage: apiData.water_usage || 0,
                    electricityUsage: apiData.electricity_usage || 0,
                    total: apiData.utilities_fee || 0
                },
                totalAmount: apiData.total_due,
                paymentStatus: apiData.payment_status_text,
                dueDate: new Date(currentDate.getTime() + 7 * 24 * 60 * 60 * 1000).toLocaleDateString('zh-CN'),
                remarks: apiData.remarks,
                createdAt: apiData.created_at,
                updatedAt: apiData.updated_at
            };
        }

        // ç”Ÿæˆè´¦å•HTML
        function generateBillHTML(billData) {
            return `
                <div class="bill-container" id="billContent">
                    <!-- è´¦å•å¤´éƒ¨ -->
                    <div class="bill-header text-center mb-4">
                        <h3 class="text-primary mb-1">
                            <i class="fas fa-building"></i> ç§Ÿæˆ¿ç®¡ç†ç³»ç»Ÿ
                        </h3>
                        <h4 class="mb-3">ç¼´è´¹è´¦å•</h4>
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-1"><strong>æˆ¿é—´å·ï¼š</strong>${billData.roomNumber}</p>
                                <p class="mb-1"><strong>ç§Ÿå®¢å§“åï¼š</strong>${billData.tenantName}</p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1"><strong>è´¦å•æœˆä»½ï¼š</strong>${billData.billMonth}</p>
                                <p class="mb-1"><strong>ç”Ÿæˆæ—¥æœŸï¼š</strong>${billData.billDate}</p>
                            </div>
                        </div>
                    </div>

                    <!-- è´¹ç”¨æ˜ç»† -->
                    <div class="bill-details">
                        <h5 class="border-bottom pb-2 mb-3">
                            <i class="fas fa-list"></i> è´¹ç”¨æ˜ç»†
                        </h5>

                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>è´¹ç”¨é¡¹ç›®</th>
                                        <th class="text-end">é‡‘é¢ï¼ˆå…ƒï¼‰</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><i class="fas fa-home text-primary"></i> æœˆç§Ÿé‡‘</td>
                                        <td class="text-end">Â¥${billData.monthlyRent.toFixed(2)}</td>
                                    </tr>
                                    ${billData.utilities.water > 0 ? `
                                    <tr>
                                        <td><i class="fas fa-tint text-info"></i> æ°´è´¹ (${billData.utilities.waterUsage.toFixed(2)}æ–¹)</td>
                                        <td class="text-end">Â¥${billData.utilities.water.toFixed(2)}</td>
                                    </tr>
                                    ` : ''}
                                    ${billData.utilities.electricity > 0 ? `
                                    <tr>
                                        <td><i class="fas fa-bolt text-warning"></i> ç”µè´¹ (${billData.utilities.electricityUsage.toFixed(2)}åº¦)</td>
                                        <td class="text-end">Â¥${billData.utilities.electricity.toFixed(2)}</td>
                                    </tr>
                                    ` : ''}
                                    ${(billData.utilities.total > 0 && billData.utilities.total !== (billData.utilities.water + billData.utilities.electricity)) ? `
                                    <tr>
                                        <td><i class="fas fa-bolt text-secondary"></i> å…¶ä»–æ°´ç”µè´¹</td>
                                        <td class="text-end">Â¥${(billData.utilities.total - billData.utilities.water - billData.utilities.electricity).toFixed(2)}</td>
                                    </tr>
                                    ` : ''}
                                    ${billData.deposit > 0 ? `
                                    <tr class="table-info">
                                        <td><i class="fas fa-piggy-bank text-info"></i> æŠ¼é‡‘</td>
                                        <td class="text-end">Â¥${billData.deposit.toFixed(2)}</td>
                                    </tr>
                                    ` : ''}
                                </tbody>
                                <tfoot class="table-primary">
                                    <tr>
                                        <th><i class="fas fa-calculator"></i> åº”ç¼´æ€»é¢</th>
                                        <th class="text-end">Â¥${billData.totalAmount.toFixed(2)}</th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    <!-- ç¼´è´¹ä¿¡æ¯ -->
                    <div class="bill-payment-info mt-4">
                        <h5 class="border-bottom pb-2 mb-3">
                            <i class="fas fa-credit-card"></i> ç¼´è´¹ä¿¡æ¯
                        </h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="alert ${billData.paymentStatus === 'å·²ç¼´è´¹' ? 'alert-success' : 'alert-warning'}" role="alert">
                                    <i class="fas ${billData.paymentStatus === 'å·²ç¼´è´¹' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                                    <strong>ç¼´è´¹çŠ¶æ€ï¼š</strong>${billData.paymentStatus}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="alert alert-info" role="alert">
                                    <i class="fas fa-calendar-alt"></i>
                                    <strong>ç¼´è´¹æˆªæ­¢æ—¥æœŸï¼š</strong>${billData.dueDate}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å¤‡æ³¨ä¿¡æ¯ -->
                    ${billData.remarks ? `
                    <div class="bill-remarks mt-4">
                        <h6 class="text-muted">
                            <i class="fas fa-sticky-note"></i> å¤‡æ³¨ä¿¡æ¯
                        </h6>
                        <div class="alert alert-light">
                            ${billData.remarks}
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- è®°å½•ä¿¡æ¯ -->
                    <div class="bill-record-info mt-4">
                        <h6 class="text-muted">
                            <i class="fas fa-clock"></i> è®°å½•ä¿¡æ¯
                        </h6>
                        <div class="row text-muted small">
                            <div class="col-md-6">
                                <p class="mb-1"><strong>åˆ›å»ºæ—¶é—´ï¼š</strong>${billData.createdAt}</p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1"><strong>æ›´æ–°æ—¶é—´ï¼š</strong>${billData.updatedAt}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ¸©é¦¨æç¤º -->
                    <div class="bill-notes mt-4">
                        <h6 class="text-muted">
                            <i class="fas fa-info-circle"></i> æ¸©é¦¨æç¤º
                        </h6>
                        <ul class="text-muted small">
                            <li>è¯·åœ¨æˆªæ­¢æ—¥æœŸå‰å®Œæˆç¼´è´¹ï¼Œé€¾æœŸå¯èƒ½äº§ç”Ÿæ»çº³é‡‘</li>
                            <li>å¦‚æœ‰ç–‘é—®ï¼Œè¯·åŠæ—¶è”ç³»æˆ¿ä¸œæˆ–ç®¡ç†å‘˜</li>
                            <li>ç¼´è´¹åè¯·ä¿ç•™ç›¸å…³å‡­è¯</li>
                            <li>æ°´è´¹å•ä»·ï¼š3.5å…ƒ/æ–¹ï¼Œç”µè´¹å•ä»·ï¼š1.2å…ƒ/åº¦</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        // ç¼–è¾‘ç§Ÿæˆ¿è®°å½•
        function editRental(rentalId) {
            const loading = showLoading();

            // è·å–ç§Ÿæˆ¿è®°å½•è¯¦æƒ…
            fetch(`/api/rental_new/${rentalId}`)
                .then(response => response.json())
                .then(data => {
                    hideLoading(loading);
                    if (data.error) {
                        showMessage('è·å–ç§Ÿæˆ¿ä¿¡æ¯å¤±è´¥ï¼š' + data.error, 'error');
                        return;
                    }
                    showEditRentalModal(data);
                })
                .catch(error => {
                    hideLoading(loading);
                    console.error('Error:', error);
                    showMessage('è·å–ç§Ÿæˆ¿ä¿¡æ¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                });
        }

        // æ˜¾ç¤ºç¼–è¾‘ç§Ÿæˆ¿è®°å½•æ¨¡æ€æ¡†
        function showEditRentalModal(data) {
            // åˆ›å»ºç¼–è¾‘æ¨¡æ€æ¡†ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            let editModal = document.getElementById('editRentalModal');
            if (!editModal) {
                editModal = document.createElement('div');
                editModal.className = 'modal fade';
                editModal.id = 'editRentalModal';
                editModal.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-warning text-dark">
                                <h5 class="modal-title">
                                    <i class="fas fa-edit"></i> ç¼–è¾‘ç§Ÿæˆ¿è®°å½•
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="editRentalForm">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="editRoomNumber" class="form-label">æˆ¿é—´å· <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="editRoomNumber" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="editTenantName" class="form-label">ç§Ÿå®¢å§“å <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="editTenantName" required>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="editDeposit" class="form-label">æŠ¼é‡‘ (å…ƒ) <span class="text-danger">*</span></label>
                                            <input type="number" class="form-control" id="editDeposit" step="0.01" min="0" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="editMonthlyRent" class="form-label">æœˆç§Ÿé‡‘ (å…ƒ) <span class="text-danger">*</span></label>
                                            <input type="number" class="form-control" id="editMonthlyRent" step="0.01" min="0" required>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="editWaterUsage" class="form-label">ç”¨æ°´é‡ (æ–¹)</label>
                                            <input type="number" class="form-control" id="editWaterUsage" step="0.1" min="0" placeholder="è¾“å…¥ç”¨æ°´é‡">
                                            <small class="form-text text-muted">æ°´è´¹å•ä»·ï¼š3.5å…ƒ/æ–¹ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è®¡ç®—è´¹ç”¨</small>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="editElectricityUsage" class="form-label">ç”¨ç”µé‡ (åº¦)</label>
                                            <input type="number" class="form-control" id="editElectricityUsage" step="0.1" min="0" placeholder="è¾“å…¥ç”¨ç”µé‡">
                                            <small class="form-text text-muted">ç”µè´¹å•ä»·ï¼š1.2å…ƒ/åº¦ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è®¡ç®—è´¹ç”¨</small>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="editPaymentStatus" class="form-label">ç¼´è´¹çŠ¶æ€</label>
                                            <select class="form-select" id="editPaymentStatus">
                                                <option value="1">å·²ç¼´è´¹</option>
                                                <option value="2">æœªç¼´è´¹</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="editTotalDue" class="form-label">åº”ç¼´è´¹æ€»é¢ (å…ƒ)</label>
                                            <input type="number" class="form-control" id="editTotalDue" step="0.01" min="0" readonly>
                                            <small class="form-text text-muted">è‡ªåŠ¨è®¡ç®—ï¼šæœˆç§Ÿé‡‘ + (ç”¨æ°´é‡Ã—3.5) + (ç”¨ç”µé‡Ã—1.2)</small>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="editRemarks" class="form-label">å¤‡æ³¨</label>
                                        <textarea class="form-control" id="editRemarks" rows="3" placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰"></textarea>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times"></i> å–æ¶ˆ
                                </button>
                                <button type="button" class="btn btn-warning" onclick="updateRental()">
                                    <i class="fas fa-save"></i> ä¿å­˜ä¿®æ”¹
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(editModal);

                // æ·»åŠ å®æ—¶è®¡ç®—åŠŸèƒ½
                const monthlyRentInput = document.getElementById('editMonthlyRent');
                const waterUsageInput = document.getElementById('editWaterUsage');
                const electricityUsageInput = document.getElementById('editElectricityUsage');
                const totalDueInput = document.getElementById('editTotalDue');

                function calculateEditTotalDue() {
                    const monthlyRent = parseFloat(monthlyRentInput.value) || 0;
                    const waterUsage = parseFloat(waterUsageInput.value) || 0;
                    const electricityUsage = parseFloat(electricityUsageInput.value) || 0;

                    const waterFee = waterUsage * 3.5;
                    const electricityFee = electricityUsage * 1.2;
                    const totalDue = monthlyRent + waterFee + electricityFee;

                    totalDueInput.value = totalDue.toFixed(2);
                }

                monthlyRentInput.addEventListener('input', calculateEditTotalDue);
                waterUsageInput.addEventListener('input', calculateEditTotalDue);
                electricityUsageInput.addEventListener('input', calculateEditTotalDue);
            }

            // å¡«å……è¡¨å•æ•°æ®
            document.getElementById('editRoomNumber').value = data.room_number;
            document.getElementById('editTenantName').value = data.tenant_name;
            document.getElementById('editDeposit').value = data.deposit;
            document.getElementById('editMonthlyRent').value = data.monthly_rent;

            // æ ¹æ®å½“å‰æ°´è´¹å’Œç”µè´¹åæ¨ç”¨é‡
            const waterUsage = data.water_fee / 3.5;
            const electricityUsage = data.electricity_fee / 1.2;
            document.getElementById('editWaterUsage').value = waterUsage > 0 ? waterUsage.toFixed(1) : '';
            document.getElementById('editElectricityUsage').value = electricityUsage > 0 ? electricityUsage.toFixed(1) : '';

            document.getElementById('editPaymentStatus').value = data.payment_status;
            document.getElementById('editTotalDue').value = data.total_due;
            document.getElementById('editRemarks').value = data.remarks || '';

            // ä¿å­˜å½“å‰ç¼–è¾‘çš„ç§Ÿæˆ¿è®°å½•ID
            editModal.setAttribute('data-rental-id', data.id);

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            const modal = new bootstrap.Modal(editModal);
            modal.show();
        }

        // æ›´æ–°ç§Ÿæˆ¿è®°å½•
        function updateRental() {
            const editModal = document.getElementById('editRentalModal');
            const rentalId = editModal.getAttribute('data-rental-id');

            // è·å–è¡¨å•æ•°æ®
            const formData = {
                room_number: document.getElementById('editRoomNumber').value.trim(),
                tenant_name: document.getElementById('editTenantName').value.trim(),
                deposit: parseFloat(document.getElementById('editDeposit').value) || 0,
                monthly_rent: parseFloat(document.getElementById('editMonthlyRent').value) || 0,
                payment_status: parseInt(document.getElementById('editPaymentStatus').value),
                remarks: document.getElementById('editRemarks').value.trim()
            };

            // è®¡ç®—æ°´è´¹å’Œç”µè´¹
            const waterUsage = parseFloat(document.getElementById('editWaterUsage').value) || 0;
            const electricityUsage = parseFloat(document.getElementById('editElectricityUsage').value) || 0;

            formData.water_fee = waterUsage * 3.5;
            formData.electricity_fee = electricityUsage * 1.2;
            formData.utilities_fee = formData.water_fee + formData.electricity_fee;
            formData.total_due = formData.monthly_rent + formData.utilities_fee;

            // è¡¨å•éªŒè¯
            if (!formData.room_number) {
                showMessage('è¯·è¾“å…¥æˆ¿é—´å·', 'warning');
                return;
            }
            if (!formData.tenant_name) {
                showMessage('è¯·è¾“å…¥ç§Ÿå®¢å§“å', 'warning');
                return;
            }
            if (formData.deposit < 0) {
                showMessage('æŠ¼é‡‘ä¸èƒ½ä¸ºè´Ÿæ•°', 'warning');
                return;
            }
            if (formData.monthly_rent <= 0) {
                showMessage('æœˆç§Ÿé‡‘å¿…é¡»å¤§äº0', 'warning');
                return;
            }

            const loading = showLoading();

            // å‘é€æ›´æ–°è¯·æ±‚
            fetch(`/api/rental_new/${rentalId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
                .then(response => response.json())
                .then(data => {
                    hideLoading(loading);
                    if (data.success) {
                        showMessage(`æˆ¿é—´ ${formData.room_number} çš„ç§Ÿæˆ¿è®°å½•å·²æ›´æ–°`, 'success');

                        // å…³é—­æ¨¡æ€æ¡†
                        const modal = bootstrap.Modal.getInstance(editModal);
                        modal.hide();

                        // åˆ·æ–°é¡µé¢
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showMessage('æ›´æ–°å¤±è´¥ï¼š' + data.message, 'error');
                    }
                })
                .catch(error => {
                    hideLoading(loading);
                    console.error('Error:', error);
                    showMessage('æ›´æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                });
        }

        // æ˜¾ç¤ºæ ‡è®°å·²ç¼´è´¹æ¨¡æ€æ¡†
        function showMarkAsPaidModal(rentalId, roomNumber, tenantName, totalDue) {
            const modal = new bootstrap.Modal(document.getElementById('markAsPaidModal'));
            const modalBody = document.getElementById('markAsPaidModalBody');
            const confirmBtn = document.getElementById('confirmMarkAsPaidBtn');

            // å¡«å……æ¨¡æ€æ¡†å†…å®¹
            modalBody.innerHTML = `
                <div class="text-center mb-4">
                    <i class="fas fa-money-bill-wave text-success" style="font-size: 3rem;"></i>
                </div>
                <div class="payment-info">
                    <div class="row mb-3">
                        <div class="col-sm-4"><strong>æˆ¿é—´å·ï¼š</strong></div>
                        <div class="col-sm-8">${roomNumber}</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-4"><strong>ç§Ÿå®¢å§“åï¼š</strong></div>
                        <div class="col-sm-8">${tenantName}</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-4"><strong>åº”ç¼´è´¹ç”¨ï¼š</strong></div>
                        <div class="col-sm-8 text-success"><strong>Â¥${parseFloat(totalDue).toFixed(2)}</strong></div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-4"><strong>ç¼´è´¹æ—¥æœŸï¼š</strong></div>
                        <div class="col-sm-8">${new Date().toLocaleDateString('zh-CN')}</div>
                    </div>
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> ç¡®è®¤åå°†æ ‡è®°è¯¥æˆ¿é—´ä¸ºå·²ç¼´è´¹çŠ¶æ€ï¼Œæ­¤æ“ä½œå¯ä»¥æ’¤é”€ã€‚
                </div>
            `;

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            modal.show();

            // è®¾ç½®ç¡®è®¤æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
            confirmBtn.onclick = function () {
                markAsPaid(rentalId, roomNumber, modal);
            };
        }

        // æ ‡è®°ä¸ºå·²ç¼´è´¹
        function markAsPaid(rentalId, roomNumber, modal = null) {
            const loading = showLoading();

            // å¦‚æœæœ‰æ¨¡æ€æ¡†ï¼Œå…ˆå…³é—­å®ƒ
            if (modal) {
                modal.hide();
            }

            // å‘é€æ›´æ–°è¯·æ±‚
            fetch(`/rental_new/${rentalId}/mark_paid`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => response.json())
                .then(data => {
                    hideLoading(loading);
                    if (data.success) {
                        showMessage(`æˆ¿é—´ ${roomNumber} å·²æˆåŠŸæ ‡è®°ä¸ºå·²ç¼´è´¹`, 'success');
                        // æ‰¾åˆ°å¯¹åº”çš„è¡Œå¹¶é«˜äº®æ˜¾ç¤º
                        const row = document.querySelector(`[data-search*="${roomNumber}"]`);
                        if (row) {
                            highlightRow(row);
                        }
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showMessage('æ ‡è®°å¤±è´¥ï¼š' + data.message, 'error');
                    }
                })
                .catch(error => {
                    hideLoading(loading);
                    console.error('Error:', error);
                    showMessage('æ ‡è®°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                });
        }

        // åˆ é™¤ç§Ÿæˆ¿è®°å½•
        function deleteRental(rentalId, roomNumber) {
            // åˆ›å»ºåˆ é™¤ç¡®è®¤æ¨¡æ€æ¡†ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            let deleteModal = document.getElementById('deleteRentalModal');
            if (!deleteModal) {
                deleteModal = document.createElement('div');
                deleteModal.className = 'modal fade';
                deleteModal.id = 'deleteRentalModal';
                deleteModal.innerHTML = `
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-danger text-white">
                                <h5 class="modal-title">
                                    <i class="fas fa-exclamation-triangle"></i> åˆ é™¤ç¡®è®¤
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body" id="deleteRentalModalBody">
                                <!-- å†…å®¹å°†é€šè¿‡JavaScriptå¡«å…… -->
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times"></i> å–æ¶ˆ
                                </button>
                                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                                    <i class="fas fa-trash"></i> ç¡®è®¤åˆ é™¤
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(deleteModal);
            }

            // å¡«å……åˆ é™¤ç¡®è®¤å†…å®¹
            const deleteModalBody = document.getElementById('deleteRentalModalBody');
            deleteModalBody.innerHTML = `
                <div class="text-center mb-4">
                    <i class="fas fa-trash text-danger" style="font-size: 3rem;"></i>
                </div>
                <p class="text-center">æ‚¨ç¡®å®šè¦åˆ é™¤æˆ¿é—´ <strong class="text-danger">${roomNumber}</strong> çš„ç§Ÿæˆ¿è®°å½•å—ï¼Ÿ</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-circle"></i> è­¦å‘Šï¼šæ­¤æ“ä½œä¸å¯æ¢å¤ï¼æ‰€æœ‰ç›¸å…³çš„ç§Ÿæˆ¿ä¿¡æ¯å°†è¢«æ°¸ä¹…åˆ é™¤ã€‚
                </div>
            `;

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            const modal = new bootstrap.Modal(deleteModal);
            modal.show();

            // è®¾ç½®ç¡®è®¤åˆ é™¤æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            confirmDeleteBtn.onclick = function () {
                // å…³é—­æ¨¡æ€æ¡†
                const modal = bootstrap.Modal.getInstance(deleteModal);
                modal.hide();

                const loading = showLoading();

                // å‘é€åˆ é™¤è¯·æ±‚
                fetch(`/api/rental_new/${rentalId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        hideLoading(loading);
                        if (data.success) {
                            showMessage(`æˆ¿é—´ ${roomNumber} çš„ç§Ÿæˆ¿è®°å½•å·²åˆ é™¤`, 'success');
                            // æ‰¾åˆ°å¯¹åº”çš„è¡Œå¹¶æ·»åŠ åˆ é™¤åŠ¨ç”»
                            const row = document.querySelector(`[data-search*="${roomNumber}"]`);
                            if (row) {
                                row.style.animation = 'fadeOut 0.5s ease-out forwards';
                                setTimeout(() => location.reload(), 500);
                            } else {
                                setTimeout(() => location.reload(), 1000);
                            }
                        } else {
                            showMessage('åˆ é™¤å¤±è´¥ï¼š' + data.message, 'error');
                        }
                    })
                    .catch(error => {
                        hideLoading(loading);
                        console.error('Error:', error);
                        showMessage('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                    });
            }
        }

        // å½“å‰æŸ¥çœ‹çš„ç§Ÿæˆ¿è®°å½•ID
        let currentRentalId = null;

        // æ˜¾ç¤ºç§Ÿæˆ¿è¯¦æƒ…æ¨¡æ€æ¡†
        function showRentalDetailModal(data) {
            // ä¿å­˜å½“å‰æŸ¥çœ‹çš„ç§Ÿæˆ¿è®°å½•ID
            currentRentalId = data.id;

            // åˆ›å»ºè¯¦æƒ…æ¨¡æ€æ¡†ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            let detailModal = document.getElementById('rentalDetailModal');
            if (!detailModal) {
                detailModal = document.createElement('div');
                detailModal.className = 'modal fade';
                detailModal.id = 'rentalDetailModal';
                detailModal.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-info text-white">
                                <h5 class="modal-title">
                                    <i class="fas fa-info-circle"></i> ç§Ÿæˆ¿è¯¦æƒ…
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body" id="rentalDetailBody">
                                <!-- å†…å®¹å°†é€šè¿‡JavaScriptå¡«å…… -->
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times"></i> å…³é—­
                                </button>
                                <button type="button" class="btn btn-warning" onclick="editRentalFromDetail()">
                                    <i class="fas fa-edit"></i> ç¼–è¾‘
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(detailModal);
            }

            // å¡«å……è¯¦æƒ…å†…å®¹
            const detailBody = document.getElementById('rentalDetailBody');
            detailBody.innerHTML = generateRentalDetailHTML(data);

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            const modal = new bootstrap.Modal(detailModal);
            modal.show();
        }

        // ä»è¯¦æƒ…é¡µé¢ç¼–è¾‘ç§Ÿæˆ¿è®°å½•
        function editRentalFromDetail() {
            if (currentRentalId) {
                editRental(currentRentalId);
            }
        }

        // ç”Ÿæˆç§Ÿæˆ¿è¯¦æƒ…HTML
        function generateRentalDetailHTML(data) {
            return `
                <div class="rental-detail-container">
                    <div class="row">
                        <!-- åŸºæœ¬ä¿¡æ¯ -->
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header bg-primary text-white">
                                    <i class="fas fa-info-circle"></i> åŸºæœ¬ä¿¡æ¯
                                </div>
                                <div class="card-body">
                                    <table class="table table-borderless">
                                        <tr>
                                            <td><strong>æˆ¿é—´å·ï¼š</strong></td>
                                            <td><span class="badge bg-primary">${data.room_number}</span></td>
                                        </tr>
                                        <tr>
                                            <td><strong>ç§Ÿå®¢å§“åï¼š</strong></td>
                                            <td>${data.tenant_name}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>ç¼´è´¹çŠ¶æ€ï¼š</strong></td>
                                            <td>
                                                <span class="badge ${data.payment_status === 1 ? 'bg-success' : 'bg-danger'}">
                                                    <i class="fas ${data.payment_status === 1 ? 'fa-check' : 'fa-times'}"></i>
                                                    ${data.payment_status_text}
                                                </span>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- è´¹ç”¨ä¿¡æ¯ -->
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header bg-success text-white">
                                    <i class="fas fa-money-bill"></i> è´¹ç”¨ä¿¡æ¯
                                </div>
                                <div class="card-body">
                                    <table class="table table-borderless">
                                        <tr>
                                            <td><strong>æŠ¼é‡‘ï¼š</strong></td>
                                            <td class="text-success">Â¥${data.deposit.toFixed(2)}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>æœˆç§Ÿé‡‘ï¼š</strong></td>
                                            <td class="text-info">Â¥${data.monthly_rent.toFixed(2)}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>æ°´ç”µè´¹ï¼š</strong></td>
                                            <td class="text-warning">Â¥${data.utilities_fee.toFixed(2)}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>åº”ç¼´è´¹ï¼š</strong></td>
                                            <td class="text-danger"><strong>Â¥${data.total_due.toFixed(2)}</strong></td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <!-- å…¶ä»–ä¿¡æ¯ -->
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header bg-secondary text-white">
                                    <i class="fas fa-sticky-note"></i> å…¶ä»–ä¿¡æ¯
                                </div>
                                <div class="card-body">
                                    <table class="table table-borderless">
                                        <tr>
                                            <td><strong>å¤‡æ³¨ï¼š</strong></td>
                                            <td>${data.remarks || 'æ— '}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>åˆ›å»ºæ—¶é—´ï¼š</strong></td>
                                            <td>${data.created_at}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>æ›´æ–°æ—¶é—´ï¼š</strong></td>
                                            <td>${data.updated_at}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // æ‰“å°è´¦å•
        function printBill() {
            const billContent = document.getElementById('billContent');
            if (!billContent) {
                alert('è¯·å…ˆæŸ¥çœ‹è´¦å•å†…å®¹');
                return;
            }

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>ç¼´è´¹è´¦å•</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
            <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
            <style>
                @media print {
                    body { margin: 0; }
                    .bill-container { padding: 20px; }
                }
            </style>
        </head>
        <body>
            ${billContent.outerHTML}
            <script>
                window.onload = function() {
                    window.print();
                    window.close();
                }
            <\/script>
        </body>
        </html>
    `);
            printWindow.document.close();
        }

        // ä¸‹è½½è´¦å•PDF
        function downloadBillPDF() {
            const billContent = document.getElementById('billContent');
            if (!billContent) {
                showMessage('è¯·å…ˆæŸ¥çœ‹è´¦å•å†…å®¹', 'warning');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½æç¤º
            const loading = showLoading();
            showMessage('æ­£åœ¨ç”ŸæˆPDFï¼Œè¯·ç¨å€™...', 'info');

            // ä½¿ç”¨html2canvas + jsPDFçš„æ–¹æ¡ˆæ¥æ”¯æŒä¸­æ–‡
            loadLibrariesAndGenerate();

            function loadLibrariesAndGenerate() {
                let scriptsLoaded = 0;
                const totalScripts = 2;

                function checkAllLoaded() {
                    scriptsLoaded++;
                    if (scriptsLoaded === totalScripts) {
                        generatePDFFromHTML();
                    }
                }

                // åŠ è½½html2canvas
                if (typeof window.html2canvas === 'undefined') {
                    const html2canvasScript = document.createElement('script');
                    html2canvasScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                    html2canvasScript.onload = checkAllLoaded;
                    html2canvasScript.onerror = function () {
                        hideLoading(loading);
                        showMessage('html2canvasåº“åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ', 'warning');
                        fallbackToPrint();
                    };
                    document.head.appendChild(html2canvasScript);
                } else {
                    checkAllLoaded();
                }

                // åŠ è½½jsPDF
                if (typeof window.jsPDF === 'undefined') {
                    const jsPDFScript = document.createElement('script');
                    jsPDFScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                    jsPDFScript.onload = checkAllLoaded;
                    jsPDFScript.onerror = function () {
                        hideLoading(loading);
                        showMessage('jsPDFåº“åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ', 'warning');
                        fallbackToPrint();
                    };
                    document.head.appendChild(jsPDFScript);
                } else {
                    checkAllLoaded();
                }
            }

            function generatePDFFromHTML() {
                try {
                    // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„æ‰“å°æ ·å¼å®¹å™¨
                    const printContainer = document.createElement('div');
                    printContainer.style.cssText = `
                        position: absolute;
                        top: -9999px;
                        left: -9999px;
                        width: 210mm;
                        background: white;
                        padding: 20px;
                        font-family: 'Microsoft YaHei', 'SimSun', sans-serif;
                        font-size: 14px;
                        line-height: 1.6;
                        color: #333;
                    `;

                    // å¤åˆ¶è´¦å•å†…å®¹å¹¶ä¼˜åŒ–æ ·å¼
                    const billClone = billContent.cloneNode(true);

                    // ç§»é™¤ä¸éœ€è¦çš„æŒ‰é’®
                    const buttons = billClone.querySelectorAll('button');
                    buttons.forEach(btn => btn.remove());

                    // ä¼˜åŒ–æ ·å¼
                    billClone.style.cssText = `
                        background: white;
                        padding: 0;
                        margin: 0;
                        box-shadow: none;
                        border: none;
                        font-family: 'Microsoft YaHei', 'SimSun', sans-serif;
                    `;

                    // è®¾ç½®æ ‡é¢˜æ ·å¼
                    const headers = billClone.querySelectorAll('h3, h4, h5');
                    headers.forEach(h => {
                        h.style.cssText = 'color: #333; margin: 10px 0; font-weight: bold;';
                    });

                    // è®¾ç½®è¡¨æ ¼æ ·å¼
                    const tables = billClone.querySelectorAll('table');
                    tables.forEach(table => {
                        table.style.cssText = 'width: 100%; border-collapse: collapse; margin: 10px 0;';
                        const cells = table.querySelectorAll('td, th');
                        cells.forEach(cell => {
                            cell.style.cssText = 'padding: 8px; border: 1px solid #ddd; text-align: left;';
                        });
                    });

                    printContainer.appendChild(billClone);
                    document.body.appendChild(printContainer);

                    // ä½¿ç”¨html2canvasè½¬æ¢ä¸ºå›¾ç‰‡
                    html2canvas(printContainer, {
                        scale: 2,
                        useCORS: true,
                        allowTaint: true,
                        backgroundColor: '#ffffff',
                        width: printContainer.scrollWidth,
                        height: printContainer.scrollHeight
                    }).then(canvas => {
                        // ç§»é™¤ä¸´æ—¶å®¹å™¨
                        document.body.removeChild(printContainer);

                        const {jsPDF} = window.jspdf;
                        const pdf = new jsPDF({
                            orientation: 'portrait',
                            unit: 'mm',
                            format: 'a4'
                        });

                        // è®¡ç®—å›¾ç‰‡å°ºå¯¸
                        const imgWidth = 210; // A4å®½åº¦
                        const imgHeight = (canvas.height * imgWidth) / canvas.width;

                        // æ·»åŠ å›¾ç‰‡åˆ°PDF
                        const imgData = canvas.toDataURL('image/png');
                        pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);

                        // ç”Ÿæˆæ–‡ä»¶å
                        const roomNumber = document.querySelector('.bill-header .room-info')?.textContent?.match(/æˆ¿é—´å·ï¼š(\S+)/)?.[1] || 'unknown';
                        const billDate = new Date().toLocaleDateString('zh-CN').replace(/\//g, '');
                        const fileName = `ç§Ÿæˆ¿è´¦å•_${roomNumber}_${billDate}.pdf`;

                        // ä¸‹è½½PDF
                        pdf.save(fileName);

                        hideLoading(loading);
                        showMessage('PDFä¸‹è½½æˆåŠŸï¼', 'success');

                    }).catch(error => {
                        document.body.removeChild(printContainer);
                        console.error('Canvasç”Ÿæˆå¤±è´¥:', error);
                        hideLoading(loading);
                        showMessage('PDFç”Ÿæˆå¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ', 'warning');
                        fallbackToPrint();
                    });

                } catch (error) {
                    hideLoading(loading);
                    console.error('PDFç”Ÿæˆå¤±è´¥:', error);
                    showMessage('PDFç”Ÿæˆå¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ', 'warning');
                    fallbackToPrint();
                }
            }

            function fallbackToPrint() {
                setTimeout(() => {
                    printBill();
                }, 1000);
            }
        }

        // åˆå§‹åŒ–æ—¥æœŸç­›é€‰å™¨
        function initDateFilter() {
            const yearFilter = document.getElementById('yearFilter');
            const monthFilter = document.getElementById('monthFilter');

            // ä»åç«¯ä¼ é€’çš„æ•°æ®ä¸­è·å–æœ€æ—©æ—¥æœŸ
            const earliestDate = new Date('{{ earliest_date.strftime("%Y-%m-%d") if earliest_date else "2020-01-01" }}');
            const currentDate = new Date();

            // å¡«å……å¹´ä»½é€‰é¡¹
            populateYearOptions(yearFilter, earliestDate.getFullYear(), currentDate.getFullYear());

            // è®¾ç½®å½“å‰é€‰ä¸­çš„å¹´æœˆï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
            const currentYear = {{ current_year if current_year else 'null' }};
            const currentMonth = {{ current_month if current_month else 'null' }};

            if (currentYear) {
                yearFilter.value = currentYear;
                yearFilter.classList.add('date-filter-active');
            }
            if (currentMonth) {
                monthFilter.value = currentMonth;
                monthFilter.classList.add('date-filter-active');
            }

            // æ˜¾ç¤ºå½“å‰ç­›é€‰ä¿¡æ¯
            updateDateFilterInfo(currentYear, currentMonth);

            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            yearFilter.addEventListener('change', handleDateFilterChange);
            monthFilter.addEventListener('change', handleDateFilterChange);
        }

        // å¡«å……å¹´ä»½é€‰é¡¹
        function populateYearOptions(yearSelect, startYear, endYear) {
            for (let year = endYear; year >= startYear; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year + 'å¹´';
                yearSelect.appendChild(option);
            }
        }

        // å¤„ç†æ—¥æœŸç­›é€‰å˜åŒ–
        function handleDateFilterChange() {
            const yearFilter = document.getElementById('yearFilter');
            const monthFilter = document.getElementById('monthFilter');
            const year = yearFilter.value;
            const month = monthFilter.value;

            // æ›´æ–°ç­›é€‰å™¨æ ·å¼
            updateFilterStyle(yearFilter, year);
            updateFilterStyle(monthFilter, month);

            // å¦‚æœå¹´ä»½å’Œæœˆä»½éƒ½é€‰æ‹©äº†ï¼Œåˆ™è¿›è¡Œç­›é€‰
            if (year && month) {
                applyDateFilter(year, month);
            } else if (!year && !month) {
                // å¦‚æœéƒ½æ¸…ç©ºäº†ï¼Œåˆ™æ˜¾ç¤ºå…¨éƒ¨æ•°æ®
                clearDateFilter();
            }
        }

        // æ›´æ–°ç­›é€‰å™¨æ ·å¼
        function updateFilterStyle(element, value) {
            if (value) {
                element.classList.add('date-filter-active');
            } else {
                element.classList.remove('date-filter-active');
            }
        }

        // åº”ç”¨æ—¥æœŸç­›é€‰
        function applyDateFilter(year, month) {
            showMessage('æ­£åœ¨ç­›é€‰æ•°æ®...', 'info');

            // æ„å»ºURLå‚æ•°
            const url = new URL(window.location.href);
            url.searchParams.set('year', year);
            url.searchParams.set('month', month);

            // é‡æ–°åŠ è½½é¡µé¢
            window.location.href = url.toString();
        }

        // æ¸…é™¤æ—¥æœŸç­›é€‰
        function clearDateFilter() {
            const yearFilter = document.getElementById('yearFilter');
            const monthFilter = document.getElementById('monthFilter');

            // æ¸…ç©ºé€‰æ‹©
            yearFilter.value = '';
            monthFilter.value = '';

            // ç§»é™¤æ ·å¼
            yearFilter.classList.remove('date-filter-active');
            monthFilter.classList.remove('date-filter-active');

            // ç§»é™¤URLå‚æ•°
            const url = new URL(window.location.href);
            url.searchParams.delete('year');
            url.searchParams.delete('month');

            showMessage('æ­£åœ¨æ˜¾ç¤ºå…¨éƒ¨æ•°æ®...', 'info');

            // é‡æ–°åŠ è½½é¡µé¢
            window.location.href = url.toString();
        }

        // æ›´æ–°æ—¥æœŸç­›é€‰ä¿¡æ¯æ˜¾ç¤º
        function updateDateFilterInfo(year, month) {
            const dateFilterInfo = document.getElementById('dateFilterInfo');
            const dateFilterText = document.getElementById('dateFilterText');

            if (year && month) {
                const monthNames = ['', 'ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ',
                    'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ'];
                dateFilterText.textContent = `æ­£åœ¨æ˜¾ç¤º ${year}å¹´${monthNames[month]} çš„æ•°æ®`;
                dateFilterInfo.style.display = 'block';
            } else {
                dateFilterInfo.style.display = 'none';
            }
        }

        // å¯¼å‡ºå½“å‰ç­›é€‰çš„æ•°æ®ï¼ˆå¯ä»¥æ‰©å±•ç°æœ‰çš„å¯¼å‡ºåŠŸèƒ½ï¼‰
        function exportFilteredData() {
            const currentYear = {{ current_year if current_year else 'null' }};
            const currentMonth = {{ current_month if current_month else 'null' }};

            if (currentYear && currentMonth) {
                const monthNames = ['', 'ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ',
                    'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ'];
                showMessage(`æ­£åœ¨å¯¼å‡º ${currentYear}å¹´${monthNames[currentMonth]} çš„æ•°æ®...`, 'info');
                // è¿™é‡Œå¯ä»¥æ·»åŠ å…·ä½“çš„å¯¼å‡ºé€»è¾‘
                exportBills('filtered');
            } else {
                showMessage('è¯·å…ˆé€‰æ‹©è¦å¯¼å‡ºçš„å¹´æœˆ', 'warning');
            }
        }

        // å¿«é€Ÿè·³è½¬åˆ°ç‰¹å®šæœˆä»½
        function jumpToMonth(year, month) {
            const yearFilter = document.getElementById('yearFilter');
            const monthFilter = document.getElementById('monthFilter');

            yearFilter.value = year;
            monthFilter.value = month;

            applyDateFilter(year, month);
        }

        // è·³è½¬åˆ°å½“å‰æœˆä»½
        function jumpToCurrentMonth() {
            const now = new Date();
            jumpToMonth(now.getFullYear(), now.getMonth() + 1);
        }

        // è·³è½¬åˆ°ä¸Šä¸ªæœˆ
        function jumpToPreviousMonth() {
            const currentYear = {{ current_year if current_year else 'null' }};
            const currentMonth = {{ current_month if current_month else 'null' }};

            if (currentYear && currentMonth) {
                let prevYear = currentYear;
                let prevMonth = currentMonth - 1;

                if (prevMonth === 0) {
                    prevMonth = 12;
                    prevYear = prevYear - 1;
                }

                jumpToMonth(prevYear, prevMonth);
            } else {
                showMessage('è¯·å…ˆé€‰æ‹©å½“å‰æœˆä»½', 'warning');
            }
        }

        // è·³è½¬åˆ°ä¸‹ä¸ªæœˆ
        function jumpToNextMonth() {
            const currentYear = {{ current_year if current_year else 'null' }};
            const currentMonth = {{ current_month if current_month else 'null' }};

            if (currentYear && currentMonth) {
                let nextYear = currentYear;
                let nextMonth = currentMonth + 1;

                if (nextMonth === 13) {
                    nextMonth = 1;
                    nextYear = nextYear + 1;
                }

                jumpToMonth(nextYear, nextMonth);
            } else {
                showMessage('è¯·å…ˆé€‰æ‹©å½“å‰æœˆä»½', 'warning');
            }
        }
    </script>
{% endblock %}