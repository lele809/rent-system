{% extends "base_new.html" %}

{% block title %}管理员列表 - 租房管理系统{% endblock %}

{% block page_title %}系统管理 - 管理员列表{% endblock %}

{% block breadcrumb %}
    <div class="breadcrumb-container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}"><i class="fas fa-home"></i> 主页</a>
                </li>
                <li class="breadcrumb-item"><a href="{{ url_for('system_setting_new') }}"><i class="fas fa-cog"></i>
                    系统设置</a></li>
                <li class="breadcrumb-item active">管理员列表</li>
            </ol>
        </nav>
    </div>
{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/system-settings.css') }}">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
{% endblock %}

{% block content %}
    <div class="container-fluid">
        <!-- 页面标题 -->
        <div class="admin-header" data-aos="fade-up">
            <div class="row align-items-center position-relative">
                <div class="col-md-8">
                    <div class="d-flex align-items-center gap-3">
                        <div class="header-icon">
                            <i class="fas fa-users-cog"></i>
                        </div>
                        <div>
                            <h2 class="mb-0">管理员管理中心</h2>
                            <p class="mb-0 mt-2 opacity-75">
                                <i class="fas fa-shield-alt me-2"></i>系统管理员账户管理与权限控制
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-add-admin" onclick="addAdmin()">
                        <i class="fas fa-user-plus me-2"></i>添加管理员
                    </button>
                </div>
            </div>
        </div>

        <!-- 统计信息 -->
        <div class="admin-stats" data-aos="fade-up" data-aos-delay="100">
            <div class="stat-card stat-primary">
                <div class="stat-icon">
                    <i class="fas fa-users"></i>
                </div>
                <h3 class="mb-1">{{ admin_list|length }}</h3>
                <p class="text-muted mb-0">总管理员数</p>
            </div>
            <div class="stat-card stat-success">
                <div class="stat-icon">
                    <i class="fas fa-user-check"></i>
                </div>
                <h3 class="mb-1">{{ admin_list|selectattr('last_login')|list|length }}</h3>
                <p class="text-muted mb-0">活跃管理员</p>
            </div>
            <div class="stat-card stat-warning">
                <div class="stat-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <h3 class="mb-1">
                    {% if admin_list %}
                        {% set recent_logins = admin_list|selectattr('last_login')|list %}
                        {% if recent_logins %}
                            {{ recent_logins|length }}
                        {% else %}
                            0
                        {% endif %}
                    {% else %}
                        0
                    {% endif %}
                </h3>
                <p class="text-muted mb-0">最近活跃</p>
            </div>
        </div>

        <!-- 管理员列表 -->
        <div class="admin-table" data-aos="fade-up" data-aos-delay="200">
            <div class="table-header">
                <h5 class="table-title">管理员列表</h5>
                <p class="table-subtitle mb-0">管理系统中的所有管理员账户</p>
            </div>

            <div class="admin-table-content">
                {% if admin_list %}
                    {% for admin in admin_list %}
                        <div class="admin-item" data-aos="fade-up" data-aos-delay="{{ 100 + (loop.index * 50) }}">
                            <div class="admin-info">
                                <div class="admin-avatar">
                                    {{ admin.admin_name[0].upper() }}
                                </div>
                                <div class="admin-details">
                                    <h6>{{ admin.admin_name }}</h6>
                                    <div class="admin-meta">
                                        <div class="meta-item">
                                            <i class="fas fa-key"></i>
                                            <span>ID: {{ admin.id }}</span>
                                        </div>
                                        {% if admin.last_login %}
                                            <div class="meta-item">
                                                <i class="fas fa-clock"></i>
                                                <span>最后登录: {{ admin.last_login.strftime('%Y-%m-%d %H:%M') }}</span>
                                            </div>
                                        {% else %}
                                            <div class="meta-item">
                                                <i class="fas fa-clock"></i>
                                                <span>从未登录</span>
                                            </div>
                                        {% endif %}
                                        <div class="meta-item">
                                            <i class="fas fa-shield-check"></i>
                                            <span class="badge bg-success">活跃</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="admin-actions">
                                <button class="btn-action btn-edit"
                                        onclick="editAdmin({{ admin.id }}, '{{ admin.admin_name }}')"
                                        title="编辑管理员">
                                    <i class="fas fa-edit"></i>
                                </button>
                                {% if admin_list|length > 1 %}
                                    <button class="btn-action btn-delete"
                                            onclick="deleteAdmin({{ admin.id }}, '{{ admin.admin_name }}')"
                                            title="删除管理员">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-users-slash"></i>
                        </div>
                        <h4>暂无管理员</h4>
                        <p class="mb-3">系统中还没有任何管理员账户</p>
                        <button class="btn btn-add-admin" onclick="addAdmin()">
                            <i class="fas fa-user-plus me-2"></i>添加第一个管理员
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- 添加管理员模态框 -->
    <div class="modal fade" id="addAdminModal" tabindex="-1" aria-labelledby="addAdminModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addAdminModalLabel">
                        <i class="fas fa-user-plus me-2"></i>添加新管理员
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addAdminForm">
                        <div class="mb-3">
                            <label for="adminName" class="form-label">
                                <i class="fas fa-user me-1"></i>管理员用户名 <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="adminName" name="admin_name" required>
                            <div class="form-text">用户名将用于登录系统</div>
                        </div>
                        <div class="mb-3">
                            <label for="adminPassword" class="form-label">
                                <i class="fas fa-lock me-1"></i>密码 <span class="text-danger">*</span>
                            </label>
                            <input type="password" class="form-control" id="adminPassword" name="password" required>
                            <div class="form-text">密码长度至少6位，建议包含字母和数字</div>
                        </div>
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">
                                <i class="fas fa-lock me-1"></i>确认密码 <span class="text-danger">*</span>
                            </label>
                            <input type="password" class="form-control" id="confirmPassword" name="confirm_password"
                                   required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>取消
                    </button>
                    <button type="button" class="btn btn-primary" onclick="submitAddAdmin()">
                        <i class="fas fa-save me-1"></i>创建管理员
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑管理员模态框 -->
    <div class="modal fade" id="editAdminModal" tabindex="-1" aria-labelledby="editAdminModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editAdminModalLabel">
                        <i class="fas fa-edit me-2"></i>编辑管理员
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editAdminForm">
                        <input type="hidden" id="editAdminId" name="admin_id">
                        <div class="mb-3">
                            <label for="editAdminName" class="form-label">
                                <i class="fas fa-user me-1"></i>管理员用户名 <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="editAdminName" name="admin_name" required>
                        </div>
                        <div class="mb-3">
                            <label for="editAdminPassword" class="form-label">
                                <i class="fas fa-lock me-1"></i>新密码
                            </label>
                            <input type="password" class="form-control" id="editAdminPassword" name="password">
                            <div class="form-text">留空则不修改密码</div>
                        </div>
                        <div class="mb-3">
                            <label for="editConfirmPassword" class="form-label">
                                <i class="fas fa-lock me-1"></i>确认新密码
                            </label>
                            <input type="password" class="form-control" id="editConfirmPassword"
                                   name="confirm_password">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>取消
                    </button>
                    <button type="button" class="btn btn-primary" onclick="submitEditAdmin()">
                        <i class="fas fa-save me-1"></i>保存修改
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 删除确认模态框 -->
    <div class="modal fade" id="deleteAdminModal" tabindex="-1" aria-labelledby="deleteAdminModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteAdminModalLabel">
                        <i class="fas fa-exclamation-triangle me-2"></i>确认删除
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center">
                        <div class="mb-3">
                            <i class="fas fa-user-times text-danger" style="font-size: 3rem;"></i>
                        </div>
                        <h6>您确定要删除这个管理员吗？</h6>
                        <p class="text-muted">
                            您即将删除管理员 <strong id="deleteAdminName" class="text-danger"></strong>，
                            此操作将永久删除该管理员账户，且无法恢复。
                        </p>
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>警告：</strong>删除管理员账户后，该账户将无法再登录系统。
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>取消
                    </button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn" onclick="confirmDeleteAdmin()">
                        <i class="fas fa-trash me-1"></i>确认删除
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        // 初始化AOS动画
        AOS.init({
            duration: 800,
            easing: 'ease-in-out',
            once: true,
            offset: 100
        });

        // 添加管理员
        function addAdmin() {
            document.getElementById('addAdminForm').reset();
            const modal = new bootstrap.Modal(document.getElementById('addAdminModal'));
            modal.show();
        }

        // 提交添加管理员
        function submitAddAdmin() {
            const form = document.getElementById('addAdminForm');
            const formData = new FormData(form);

            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const password = formData.get('password');
            const confirmPassword = formData.get('confirm_password');

            if (password !== confirmPassword) {
                showToast('两次输入的密码不匹配！', 'error');
                return;
            }

            if (password.length < 6) {
                showToast('密码长度至少6位！', 'error');
                return;
            }

            const data = {
                admin_name: formData.get('admin_name'),
                password: password
            };

            // 显示加载状态
            const submitBtn = document.querySelector('#addAdminModal .btn-primary');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>创建中...';
            submitBtn.disabled = true;

            fetch('/api/admin', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('管理员创建成功！', 'success');
                        bootstrap.Modal.getInstance(document.getElementById('addAdminModal')).hide();
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showToast('创建失败：' + data.message, 'error');
                        // 恢复按钮状态
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('创建失败，请稍后重试', 'error');
                    // 恢复按钮状态
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                });
        }

        // 编辑管理员
        function editAdmin(adminId, adminName) {
            document.getElementById('editAdminId').value = adminId;
            document.getElementById('editAdminName').value = adminName;
            document.getElementById('editAdminPassword').value = '';
            document.getElementById('editConfirmPassword').value = '';

            const modal = new bootstrap.Modal(document.getElementById('editAdminModal'));
            modal.show();
        }

        // 提交编辑管理员
        function submitEditAdmin() {
            const form = document.getElementById('editAdminForm');
            const formData = new FormData(form);

            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const password = formData.get('password');
            const confirmPassword = formData.get('confirm_password');

            if (password && password !== confirmPassword) {
                showToast('两次输入的密码不匹配！', 'error');
                return;
            }

            if (password && password.length < 6) {
                showToast('密码长度至少6位！', 'error');
                return;
            }

            const data = {
                admin_name: formData.get('admin_name')
            };

            if (password) {
                data.password = password;
            }

            const adminId = formData.get('admin_id');

            // 显示加载状态
            const submitBtn = document.querySelector('#editAdminModal .btn-primary');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>保存中...';
            submitBtn.disabled = true;

            fetch(`/api/admin/${adminId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('管理员信息更新成功！', 'success');
                        bootstrap.Modal.getInstance(document.getElementById('editAdminModal')).hide();
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showToast('更新失败：' + data.message, 'error');
                        // 恢复按钮状态
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('更新失败，请稍后重试', 'error');
                    // 恢复按钮状态
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                });
        }

        // 删除管理员
        function deleteAdmin(adminId, adminName) {
            document.getElementById('deleteAdminName').textContent = adminName;
            document.getElementById('confirmDeleteBtn').setAttribute('data-admin-id', adminId);

            const modal = new bootstrap.Modal(document.getElementById('deleteAdminModal'));
            modal.show();
        }

        // 确认删除管理员
        function confirmDeleteAdmin() {
            const adminId = document.getElementById('confirmDeleteBtn').getAttribute('data-admin-id');
            const adminName = document.getElementById('deleteAdminName').textContent;

            // 显示加载状态
            const deleteBtn = document.getElementById('confirmDeleteBtn');
            const originalText = deleteBtn.innerHTML;
            deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>删除中...';
            deleteBtn.disabled = true;

            fetch(`/api/admin/${adminId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast(`管理员 "${adminName}" 删除成功！`, 'success');
                        bootstrap.Modal.getInstance(document.getElementById('deleteAdminModal')).hide();
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showToast('删除失败：' + data.message, 'error');
                        // 恢复按钮状态
                        deleteBtn.innerHTML = originalText;
                        deleteBtn.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('删除失败，请稍后重试', 'error');
                    // 恢复按钮状态
                    deleteBtn.innerHTML = originalText;
                    deleteBtn.disabled = false;
                });
        }

        // 显示提示消息
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(toast);

            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 5000);
        }

        // 设置当前页面导航为活跃状态
        document.addEventListener('DOMContentLoaded', function () {
            const adminLink = document.querySelector('a[href*="admin"]');
            if (adminLink) {
                adminLink.classList.add('active');
            }
        });
    </script>
{% endblock %}