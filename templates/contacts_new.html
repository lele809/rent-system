{% extends "base_new.html" %}

{% block title %}ÂÖ≠Ê•ºÁÆ°ÁêÜ - ËÅîÁ≥ª‰∫∫ÂàóË°® - ÁßüÊàøÁÆ°ÁêÜÁ≥ªÁªü{% endblock %}

{% block page_title %}ÂÖ≠Ê•ºÁÆ°ÁêÜ - ËÅîÁ≥ª‰∫∫ÂàóË°®{% endblock %}

{% block breadcrumb %}
    <div class="breadcrumb-container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index6') }}"><i class="fas fa-home"></i> ‰∏ªÈ°µ</a></li>
                <li class="breadcrumb-item active">ËÅîÁ≥ª‰∫∫ÂàóË°®</li>
            </ol>
        </nav>
    </div>
{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/contacts.css') }}">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
{% endblock %}

{% block content %}
    <div class="container-fluid">
        <!-- È°µÈù¢Ê†áÈ¢ò -->
        <div class="contacts-header">
            <div class="header-background"></div>
            <div class="header-pattern"></div>
            <div class="row align-items-center position-relative">
                <div class="col-md-8">
                    <div class="header-content">
                        <div class="header-icon">
                            <i class="fas fa-address-book"></i>
                        </div>
                        <div class="header-text">
                            <h2 class="header-title">ËÅîÁ≥ª‰∫∫ÁÆ°ÁêÜ‰∏≠ÂøÉ</h2>
                            <p class="header-subtitle mb-0">
                                <i class="fas fa-users me-2"></i>ÁÆ°ÁêÜÂÖ≠Ê•ºÊâÄÊúâÁßüÂÆ¢ÁöÑËÅîÁ≥ª‰ø°ÊÅØÔºåÂø´ÈÄüÊü•ÊâæÂíåËÅîÁ≥ªÁßüÊà∑
                            </p>
                            <div class="header-badges mt-2">
                            <span class="badge bg-light text-dark me-2">
                                <i class="fas fa-shield-alt me-1"></i>ÂÆâÂÖ®ÁÆ°ÁêÜ
                            </span>
                                <span class="badge bg-light text-dark">
                                <i class="fas fa-clock me-1"></i>ÂÆûÊó∂Êõ¥Êñ∞
                            </span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <div class="header-actions">
                        <button class="btn btn-glass btn-sm me-2" onclick="exportContacts()" title="ÂØºÂá∫ËÅîÁ≥ª‰∫∫">
                            <i class="fas fa-download me-1"></i> ÂØºÂá∫Êï∞ÊçÆ
                        </button>
                        <button class="btn btn-glass btn-sm me-2" onclick="importContacts()" title="ÂØºÂÖ•ËÅîÁ≥ª‰∫∫">
                            <i class="fas fa-upload me-1"></i> ÂØºÂÖ•
                        </button>
                        <button class="btn btn-glass btn-sm" onclick="refreshContacts()" title="Âà∑Êñ∞Êï∞ÊçÆ">
                            <i class="fas fa-sync-alt me-1"></i> Âà∑Êñ∞
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÁªüËÆ°‰ø°ÊÅØÂç°Áâá -->
        <div class="stats-section">
            <div class="row">
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="stats-card stats-primary" data-aos="fade-up" data-aos-delay="100">
                        <div class="stats-background"></div>
                        <div class="stats-icon">
                            <div class="icon-wrapper">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                        <div class="stats-content">
                            <div class="stats-number"
                                 data-count="{{ pagination.total if pagination else contacts_list|length }}">0
                            </div>
                            <div class="stats-label">ÊÄªËÅîÁ≥ª‰∫∫Êï∞</div>
                            <div class="stats-trend">
                                <i class="fas fa-arrow-up text-success"></i>
                                <span class="text-success">+12%</span>
                            </div>
                        </div>
                        <div class="stats-decoration">
                            <div class="decoration-circle"></div>
                            <div class="decoration-circle"></div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="stats-card stats-success" data-aos="fade-up" data-aos-delay="200">
                        <div class="stats-background"></div>
                        <div class="stats-icon">
                            <div class="icon-wrapper">
                                <i class="fas fa-phone"></i>
                            </div>
                        </div>
                        <div class="stats-content">
                            <div class="stats-number" data-count="{{ contacts_list|selectattr('phone')|list|length }}">
                                0
                            </div>
                            <div class="stats-label">ÊúâÊïàÁîµËØù</div>
                            <div class="stats-trend">
                                <i class="fas fa-arrow-up text-success"></i>
                                <span class="text-success">+8%</span>
                            </div>
                        </div>
                        <div class="stats-decoration">
                            <div class="decoration-circle"></div>
                            <div class="decoration-circle"></div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="stats-card stats-warning" data-aos="fade-up" data-aos-delay="300">
                        <div class="stats-background"></div>
                        <div class="stats-icon">
                            <div class="icon-wrapper">
                                <i class="fas fa-home"></i>
                            </div>
                        </div>
                        <div class="stats-content">
                            <div class="stats-number"
                                 data-count="{{ contacts_list|map(attribute='roomId')|unique|list|length }}">0
                            </div>
                            <div class="stats-label">Â∑≤ÂÖ•‰ΩèÊàøÈó¥</div>
                            <div class="stats-trend">
                                <i class="fas fa-arrow-up text-success"></i>
                                <span class="text-success">+5%</span>
                            </div>
                        </div>
                        <div class="stats-decoration">
                            <div class="decoration-circle"></div>
                            <div class="decoration-circle"></div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="stats-card stats-info" data-aos="fade-up" data-aos-delay="400">
                        <div class="stats-background"></div>
                        <div class="stats-icon">
                            <div class="icon-wrapper">
                                <i class="fas fa-clock"></i>
                            </div>
                        </div>
                        <div class="stats-content">
                            <div class="stats-number" data-count="3">0</div>
                            <div class="stats-label">Êú¨Âë®Êñ∞Â¢û</div>
                            <div class="stats-trend">
                                <i class="fas fa-arrow-up text-success"></i>
                                <span class="text-success">+25%</span>
                            </div>
                        </div>
                        <div class="stats-decoration">
                            <div class="decoration-circle"></div>
                            <div class="decoration-circle"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÊêúÁ¥¢ÂíåÊìç‰ΩúÂå∫Âüü -->
        <div class="search-section" data-aos="fade-up" data-aos-delay="500">
            <div class="search-background"></div>
            <div class="row align-items-center">
                <div class="col-lg-6 col-md-12 mb-3 mb-lg-0">
                    <div class="search-container">
                        <div class="search-wrapper">
                            <div class="search-icon">
                                <i class="fas fa-search"></i>
                            </div>
                            <input type="text" class="form-control search-input"
                                   placeholder="üîç ÊêúÁ¥¢ËÅîÁ≥ª‰∫∫ÂßìÂêç„ÄÅÊàøÈó¥Âè∑„ÄÅÁîµËØùÊàñË∫´‰ªΩËØÅ..."
                                   id="searchInput">
                            <button class="btn search-clear-btn" type="button" onclick="clearSearch()" title="Ê∏ÖÁ©∫ÊêúÁ¥¢">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3 mb-lg-0">
                    <div class="filter-container">
                        <div class="filter-wrapper">
                            <i class="fas fa-filter filter-icon"></i>
                            <select class="form-select custom-select" id="roomFilter" onchange="filterByRoom()">
                                <option value="">üè† ÊâÄÊúâÊàøÈó¥</option>
                                {% for room in contacts_list|map(attribute='roomId')|unique|sort %}
                                    <option value="{{ room }}">ÊàøÈó¥ {{ room }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="action-buttons">
                        <button class="btn btn-gradient-primary add-contact-btn w-100" onclick="addContact()">
                        <span class="btn-content">
                            <i class="fas fa-user-plus me-2"></i>
                            <span>Ê∑ªÂä†ËÅîÁ≥ª‰∫∫</span>
                        </span>
                            <div class="btn-shine"></div>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Âø´ÈÄüÁ≠õÈÄâÊ†áÁ≠æ -->
            <div class="quick-filters mt-3">
                <div class="filter-tags">
                <span class="filter-tag active" onclick="quickFilter('all')">
                    <i class="fas fa-users me-1"></i>ÂÖ®ÈÉ®
                </span>
                    <span class="filter-tag" onclick="quickFilter('recent')">
                    <i class="fas fa-clock me-1"></i>ÊúÄËøëÊ∑ªÂä†
                </span>
                    <span class="filter-tag" onclick="quickFilter('phone')">
                    <i class="fas fa-phone me-1"></i>ÊúâÁîµËØù
                </span>
                    <span class="filter-tag" onclick="quickFilter('no-phone')">
                    <i class="fas fa-phone-slash me-1"></i>Êó†ÁîµËØù
                </span>
                </div>
            </div>
        </div>

        <!-- ËÅîÁ≥ª‰∫∫ÂàóË°® -->
        <div class="contacts-table" data-aos="fade-up" data-aos-delay="600">
            <div class="table-header">
                <div class="table-header-background"></div>
                <div class="row align-items-center position-relative">
                    <div class="col-md-6">
                        <div class="table-title-section">
                            <div class="title-icon">
                                <i class="fas fa-address-card"></i>
                            </div>
                            <div class="title-content">
                                <h5 class="table-title mb-0">ËÅîÁ≥ª‰∫∫ËØ¶ÁªÜÂàóË°®</h5>
                                <div class="table-subtitle">
                                    <span class="contact-count-badge"
                                          id="contactCount">{{ contacts_list|length }}</span>
                                    <span class="count-text">‰ΩçÁßüÊà∑‰ø°ÊÅØ</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 text-end">
                        <div class="table-actions">
                            <div class="action-group">
                                <button class="btn btn-glass-secondary btn-sm me-2" onclick="selectAll()" title="ÂÖ®ÈÄâ">
                                    <i class="fas fa-check-square me-1"></i>
                                    <span>ÂÖ®ÈÄâ</span>
                                </button>
                                <button class="btn btn-glass-danger btn-sm" onclick="batchDelete()" title="ÊâπÈáèÂà†Èô§"
                                        disabled id="batchDeleteBtn">
                                    <i class="fas fa-trash me-1"></i>
                                    <span>ÊâπÈáèÂà†Èô§</span>
                                </button>
                            </div>
                            <div class="view-options ms-3">
                                <button class="btn btn-view-option" onclick="switchView('table')"
                                        title="Ë°®Ê†ºËßÜÂõæ">
                                    <i class="fas fa-table"></i>
                                </button>
                                <button class="btn btn-view-option active" onclick="switchView('card')"
                                        title="Âç°ÁâáËßÜÂõæ">
                                    <i class="fas fa-th-large"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {% if contacts_list %}
                <!-- Ë°®Ê†ºËßÜÂõæ -->
                <div class="table-view" id="tableView" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-hover modern-table">
                            <thead>
                            <tr>
                                <th width="5%" class="checkbox-column">
                                    <div class="custom-checkbox">
                                        <input type="checkbox" class="form-check-input" id="selectAllCheckbox"
                                               onchange="toggleSelectAll()">
                                        <label for="selectAllCheckbox" class="checkbox-label"></label>
                                    </div>
                                </th>
                                <th width="8%" class="sortable" onclick="sortTable('index')">
                                    <div class="th-content">
                                        <span>Â∫èÂè∑</span>
                                        <i class="fas fa-sort sort-icon"></i>
                                    </div>
                                </th>
                                <th width="12%" class="sortable" onclick="sortTable('room')">
                                    <div class="th-content">
                                        <i class="fas fa-home me-1"></i>
                                        <span>ÊàøÈó¥Âè∑</span>
                                        <i class="fas fa-sort sort-icon"></i>
                                    </div>
                                </th>
                                <th width="15%" class="sortable" onclick="sortTable('name')">
                                    <div class="th-content">
                                        <i class="fas fa-user me-1"></i>
                                        <span>ÂßìÂêç</span>
                                        <i class="fas fa-sort sort-icon"></i>
                                    </div>
                                </th>
                                <th width="15%" class="sortable" onclick="sortTable('phone')">
                                    <div class="th-content">
                                        <i class="fas fa-phone me-1"></i>
                                        <span>ÁîµËØù</span>
                                        <i class="fas fa-sort sort-icon"></i>
                                    </div>
                                </th>
                                <th width="20%">
                                    <div class="th-content">
                                        <i class="fas fa-id-card me-1"></i>
                                        <span>Ë∫´‰ªΩËØÅÂè∑</span>
                                    </div>
                                </th>
                                <th width="12%" class="sortable" onclick="sortTable('date')">
                                    <div class="th-content">
                                        <i class="fas fa-calendar me-1"></i>
                                        <span>ÂàõÂª∫Êó∂Èó¥</span>
                                        <i class="fas fa-sort sort-icon"></i>
                                    </div>
                                </th>
                                <th width="13%">
                                    <div class="th-content">
                                        <i class="fas fa-cogs me-1"></i>
                                        <span>Êìç‰Ωú</span>
                                    </div>
                                </th>
                            </tr>
                            </thead>
                            <tbody id="contactsTableBody" class="table-body">
                            {% for contact in contacts_list %}
                                <tr class="contact-row modern-row"
                                    data-search="


                                            {{ contact.name }}{{ contact.roomId }}{{ contact.phone }}{{ contact.id_card }}"
                                    data-room="{{ contact.roomId }}"
                                    data-aos="fade-up"
                                    data-aos-delay="{{ 100 + (loop.index * 50) }}">
                                    <td class="checkbox-cell">
                                        <div class="custom-checkbox">
                                            <input type="checkbox" class="form-check-input contact-checkbox"
                                                   id="contact-{{ contact.id }}"
                                                   value="{{ contact.id }}"
                                                   onchange="updateBatchActions()">
                                            <label for="contact-{{ contact.id }}" class="checkbox-label"></label>
                                        </div>
                                    </td>
                                    <td class="row-number-cell">
                                        <div class="row-number-badge">{{ loop.index }}</div>
                                    </td>
                                    <td class="room-cell">
                                        <div class="room-info">
                                        <span class="room-badge-modern">
                                            <i class="fas fa-home"></i>
                                            <span class="room-number">{{ contact.roomId }}</span>
                                        </span>
                                        </div>
                                    </td>
                                    <td class="name-cell">
                                        <div class="contact-profile">
                                            <div class="profile-avatar">
                                                <i class="fas fa-user"></i>
                                            </div>
                                            <div class="profile-info">
                                                <div class="contact-name-modern">{{ contact.name }}</div>
                                                <div class="contact-role">ÁßüÊà∑</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="phone-cell">
                                        <div class="phone-container">
                                            <div class="phone-info">
                                                <i class="fas fa-phone phone-icon"></i>
                                                <span class="phone-number">{{ contact.phone }}</span>
                                            </div>
                                            <div class="phone-actions">
                                                <button class="btn-copy"
                                                        onclick="copyToClipboard('{{ contact.phone }}')"
                                                        title="Â§çÂà∂ÁîµËØù">
                                                    <i class="fas fa-copy"></i>
                                                </button>
                                                <button class="btn-call" onclick="callContact('{{ contact.phone }}')"
                                                        title="Êã®ÊâìÁîµËØù">
                                                    <i class="fas fa-phone-alt"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="id-cell">
                                        <div class="id-container">
                                            <div class="id-info">
                                                <i class="fas fa-id-card id-icon"></i>
                                                <span class="id-number">{{ contact.id_card[:6] }}****{{ contact.id_card[-4:] if contact.id_card|length > 10 else contact.id_card }}</span>
                                            </div>
                                            <button class="btn-copy" onclick="copyToClipboard('{{ contact.id_card }}')"
                                                    title="Â§çÂà∂Ë∫´‰ªΩËØÅ">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </div>
                                    </td>
                                    <td class="date-cell">
                                        <div class="date-info">
                                            <i class="fas fa-calendar-alt date-icon"></i>
                                            <div class="date-content">
                                                <div class="date-main">{{ contact.created_at.strftime('%m-%d') if contact.created_at else '--' }}</div>
                                                <div class="date-year">{{ contact.created_at.strftime('%Y') if contact.created_at else 'Êú™Áü•' }}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="actions-cell">
                                        <div class="action-buttons-modern">
                                            <button class="btn-action-modern btn-view"
                                                    onclick="viewContact({{ contact.id }})"
                                                    title="Êü•ÁúãËØ¶ÊÉÖ">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn-action-modern btn-edit"
                                                    onclick="editContact({{ contact.id }})"
                                                    title="ÁºñËæë">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn-action-modern btn-delete"
                                                    onclick="deleteContact({{ contact.id }}, '{{ contact.name }}')"
                                                    title="Âà†Èô§">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Âç°ÁâáËßÜÂõæ -->
                <div class="card-view" id="cardView">
                    <div class="contacts-grid">
                        {% for contact in contacts_list %}
                            <div class="contact-card"
                                 data-search="
                                         {{ contact.name }}{{ contact.roomId }}{{ contact.phone }}{{ contact.id_card }}"
                                 data-room="{{ contact.roomId }}"
                                 data-aos="zoom-in"
                                 data-aos-delay="{{ 100 + (loop.index * 30) }}">
                                <div class="card-header">
                                    <div class="card-checkbox">
                                        <input type="checkbox" class="form-check-input contact-checkbox"
                                               value="{{ contact.id }}"
                                               onchange="updateBatchActions()">
                                    </div>
                                    <div class="card-room">
                                        <span class="room-badge-card">{{ contact.roomId }}</span>
                                    </div>
                                </div>

                                <div class="card-body">
                                    <div class="contact-avatar-large">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    <h6 class="contact-name-card">{{ contact.name }}</h6>
                                    <p class="contact-role-card">ÁßüÊà∑</p>

                                    <div class="contact-details">
                                        <div class="detail-item">
                                            <i class="fas fa-phone"></i>
                                            <span>{{ contact.phone }}</span>
                                            <button class="btn-copy-small"
                                                    onclick="copyToClipboard('{{ contact.phone }}')">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </div>
                                        <div class="detail-item">
                                            <i class="fas fa-id-card"></i>
                                            <span>{{ contact.id_card[:6] }}****{{ contact.id_card[-4:] if contact.id_card|length > 10 else contact.id_card }}</span>
                                            <button class="btn-copy-small"
                                                    onclick="copyToClipboard('{{ contact.id_card }}')">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </div>
                                        <div class="detail-item">
                                            <i class="fas fa-calendar"></i>
                                            <span>{{ contact.created_at.strftime('%Y-%m-%d') if contact.created_at else 'Êú™Áü•' }}</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="card-footer">
                                    <div class="card-actions">
                                        <button class="btn-card-action btn-primary"
                                                onclick="viewContact({{ contact.id }})" title="Êü•Áúã">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn-card-action btn-warning"
                                                onclick="editContact({{ contact.id }})" title="ÁºñËæë">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn-card-action btn-success"
                                                onclick="callContact('{{ contact.phone }}')" title="Êã®Êâì">
                                            <i class="fas fa-phone"></i>
                                        </button>
                                        <button class="btn-card-action btn-danger"
                                                onclick="deleteContact({{ contact.id }}, '{{ contact.name }}')"
                                                title="Âà†Èô§">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% else %}
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-address-book"></i>
                    </div>
                    <h4>ÊöÇÊó†ËÅîÁ≥ª‰∫∫Êï∞ÊçÆ</h4>
                    <p class="text-muted mb-4">ËøòÊ≤°ÊúâÊ∑ªÂä†‰ªª‰ΩïËÅîÁ≥ª‰∫∫‰ø°ÊÅØÔºåÁÇπÂáª‰∏ãÊñπÊåâÈíÆÂºÄÂßãÊ∑ªÂä†Á¨¨‰∏Ä‰∏™ËÅîÁ≥ª‰∫∫</p>
                    <div class="empty-actions">
                        <button class="btn btn-primary add-contact-btn me-2" onclick="addContact()">
                            <i class="fas fa-user-plus me-2"></i> Ê∑ªÂä†Á¨¨‰∏Ä‰∏™ËÅîÁ≥ª‰∫∫
                        </button>
                        <button class="btn btn-outline-secondary" onclick="importContacts()">
                            <i class="fas fa-upload me-2"></i> ÊâπÈáèÂØºÂÖ•
                        </button>
                    </div>
                </div>
            {% endif %}

            <!-- ÂàÜÈ°µÂØºËà™ - ÂßãÁªàÊòæÁ§∫ÔºåÂ±Ö‰∏≠ÂØπÈΩê -->
            <div class="pagination-section" data-aos="fade-up" data-aos-delay="700">
                <div class="pagination-background"></div>
                <div class="row justify-content-center position-relative">
                    <div class="col-12">
                        <div class="d-flex justify-content-center align-items-center flex-column">
                            <!-- ÂàÜÈ°µ‰ø°ÊÅØ -->
                            <div class="pagination-info mb-3">
                                <div class="info-content text-center">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <span class="pagination-text">
                                        {% if pagination %}
                                            ÂÖ± {{ pagination.total }} Êù°ËÅîÁ≥ª‰∫∫ËÆ∞ÂΩïÔºåÂΩìÂâçÁ¨¨ {{ pagination.page }} È°µÔºåÂÖ±
                                            {{ pagination.pages }} È°µ
                                        {% elif contacts_list %}
                                            ÂÖ± {{ contacts_list|length }} Êù°ËÅîÁ≥ª‰∫∫ËÆ∞ÂΩï
                                        {% else %}
                                            ÊöÇÊó†ËÅîÁ≥ª‰∫∫ËÆ∞ÂΩï
                                        {% endif %}
                                    </span>
                                </div>
                            </div>

                            <!-- ÂàÜÈ°µÂØºËà™ -->
                            {% if pagination and pagination.pages > 1 %}
                                <nav aria-label="ËÅîÁ≥ª‰∫∫ÂàÜÈ°µÂØºËà™" class="d-flex justify-content-center">
                                    <ul class="pagination pagination-modern mb-0">
                                        <!-- È¶ñÈ°µ -->
                                        <li class="page-item {{ 'disabled' if not pagination.has_prev else '' }}">
                                            {% if pagination.has_prev %}
                                                <a class="page-link page-link-modern"
                                                   href="{{ url_for('contacts_new', page=1) }}">
                                                    <i class="fas fa-angle-double-left"></i>
                                                </a>
                                            {% else %}
                                                <span class="page-link page-link-modern">
                                                <i class="fas fa-angle-double-left"></i>
                                            </span>
                                            {% endif %}
                                        </li>
                                        <!-- ‰∏ä‰∏ÄÈ°µ -->
                                        <li class="page-item {{ 'disabled' if not pagination.has_prev else '' }}">
                                            {% if pagination.has_prev %}
                                                <a class="page-link page-link-modern"
                                                   href="{{ url_for('contacts_new', page=pagination.prev_num) }}">
                                                    <i class="fas fa-angle-left"></i>
                                                </a>
                                            {% else %}
                                                <span class="page-link page-link-modern">
                                                <i class="fas fa-angle-left"></i>
                                            </span>
                                            {% endif %}
                                        </li>

                                        <!-- È°µÁ†Å -->
                                        {% for page_num in pagination.iter_pages() %}
                                            {% if page_num %}
                                                {% if page_num != pagination.page %}
                                                    <li class="page-item">
                                                        <a class="page-link page-link-modern"
                                                           href="{{ url_for('contacts_new', page=page_num) }}">{{ page_num }}</a>
                                                    </li>
                                                {% else %}
                                                    <li class="page-item active">
                                                        <span class="page-link page-link-modern page-link-active">{{ page_num }}</span>
                                                    </li>
                                                {% endif %}
                                            {% else %}
                                                <li class="page-item disabled">
                                                    <span class="page-link page-link-modern">‚Ä¶</span>
                                                </li>
                                            {% endif %}
                                        {% endfor %}

                                        <!-- ‰∏ã‰∏ÄÈ°µ -->
                                        <li class="page-item {{ 'disabled' if not pagination.has_next else '' }}">
                                            {% if pagination.has_next %}
                                                <a class="page-link page-link-modern"
                                                   href="{{ url_for('contacts_new', page=pagination.next_num) }}">
                                                    <i class="fas fa-angle-right"></i>
                                                </a>
                                            {% else %}
                                                <span class="page-link page-link-modern">
                                                <i class="fas fa-angle-right"></i>
                                            </span>
                                            {% endif %}
                                        </li>
                                        <!-- Êú´È°µ -->
                                        <li class="page-item {{ 'disabled' if not pagination.has_next else '' }}">
                                            {% if pagination.has_next %}
                                                <a class="page-link page-link-modern"
                                                   href="{{ url_for('contacts_new', page=pagination.pages) }}">
                                                    <i class="fas fa-angle-double-right"></i>
                                                </a>
                                            {% else %}
                                                <span class="page-link page-link-modern">
                                                <i class="fas fa-angle-double-right"></i>
                                            </span>
                                            {% endif %}
                                        </li>
                                    </ul>
                                </nav>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ê∑ªÂä†ËÅîÁ≥ª‰∫∫Ê®°ÊÄÅÊ°Ü -->
    <div class="modal fade" id="addContactModal" tabindex="-1" aria-labelledby="addContactModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addContactModalLabel">
                        <i class="fas fa-user-plus me-2"></i>Ê∑ªÂä†Êñ∞ËÅîÁ≥ª‰∫∫
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addContactForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="addName" class="form-label">
                                        <i class="fas fa-user me-1"></i>ÂßìÂêç <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="addName" name="name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="addRoomId" class="form-label">
                                        <i class="fas fa-home me-1"></i>ÊàøÈó¥Âè∑ <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="addRoomId" name="roomId" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="addPhone" class="form-label">
                                        <i class="fas fa-phone me-1"></i>ÁîµËØùÂè∑Á†Å <span class="text-danger">*</span>
                                    </label>
                                    <input type="tel" class="form-control" id="addPhone" name="phone" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="addIdCard" class="form-label">
                                        <i class="fas fa-id-card me-1"></i>Ë∫´‰ªΩËØÅÂè∑ <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="addIdCard" name="id_card" required>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>ÂèñÊ∂à
                    </button>
                    <button type="button" class="btn btn-primary" onclick="submitAddContact()">
                        <i class="fas fa-save me-1"></i>‰øùÂ≠òËÅîÁ≥ª‰∫∫
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Êü•ÁúãËÅîÁ≥ª‰∫∫ËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü -->
    <div class="modal fade" id="viewContactModal" tabindex="-1" aria-labelledby="viewContactModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewContactModalLabel">
                        <i class="fas fa-eye me-2"></i>ËÅîÁ≥ª‰∫∫ËØ¶ÊÉÖ
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="contact-details-view">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="detail-item">
                                    <label><i class="fas fa-user me-2"></i>ÂßìÂêç</label>
                                    <div class="detail-value" id="viewName">-</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="detail-item">
                                    <label><i class="fas fa-home me-2"></i>ÊàøÈó¥Âè∑</label>
                                    <div class="detail-value" id="viewRoomId">-</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="detail-item">
                                    <label><i class="fas fa-phone me-2"></i>ÁîµËØùÂè∑Á†Å</label>
                                    <div class="detail-value" id="viewPhone">-</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="detail-item">
                                    <label><i class="fas fa-id-card me-2"></i>Ë∫´‰ªΩËØÅÂè∑</label>
                                    <div class="detail-value" id="viewIdCard">-</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="detail-item">
                                    <label><i class="fas fa-calendar me-2"></i>ÂàõÂª∫Êó∂Èó¥</label>
                                    <div class="detail-value" id="viewCreatedAt">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>ÂÖ≥Èó≠
                    </button>
                    <button type="button" class="btn btn-warning" onclick="editContactFromView()">
                        <i class="fas fa-edit me-1"></i>ÁºñËæë
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ÁºñËæëËÅîÁ≥ª‰∫∫Ê®°ÊÄÅÊ°Ü -->
    <div class="modal fade" id="editContactModal" tabindex="-1" aria-labelledby="editContactModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editContactModalLabel">
                        <i class="fas fa-edit me-2"></i>ÁºñËæëËÅîÁ≥ª‰∫∫
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editContactForm">
                        <input type="hidden" id="editContactId" name="id">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editName" class="form-label">
                                        <i class="fas fa-user me-1"></i>ÂßìÂêç <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="editName" name="name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editRoomId" class="form-label">
                                        <i class="fas fa-home me-1"></i>ÊàøÈó¥Âè∑ <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="editRoomId" name="roomId" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editPhone" class="form-label">
                                        <i class="fas fa-phone me-1"></i>ÁîµËØùÂè∑Á†Å <span class="text-danger">*</span>
                                    </label>
                                    <input type="tel" class="form-control" id="editPhone" name="phone" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editIdCard" class="form-label">
                                        <i class="fas fa-id-card me-1"></i>Ë∫´‰ªΩËØÅÂè∑ <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="editIdCard" name="id_card" required>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>ÂèñÊ∂à
                    </button>
                    <button type="button" class="btn btn-primary" onclick="submitEditContact()">
                        <i class="fas fa-save me-1"></i>‰øùÂ≠ò‰øÆÊîπ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Âà†Èô§ËÅîÁ≥ª‰∫∫Á°ÆËÆ§Ê®°ÊÄÅÊ°Ü -->
    <div class="modal fade" id="deleteContactModal" tabindex="-1" aria-labelledby="deleteContactModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteContactModalLabel">
                        <i class="fas fa-exclamation-triangle me-2"></i>Á°ÆËÆ§Âà†Èô§
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="delete-warning">
                        <div class="warning-icon">
                            <i class="fas fa-trash-alt"></i>
                        </div>
                        <div class="warning-content">
                            <h6 class="warning-title">ÊÇ®Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ËÅîÁ≥ª‰∫∫ÂêóÔºü</h6>
                            <p class="warning-message">
                                ÊÇ®Âç≥Â∞ÜÂà†Èô§ËÅîÁ≥ª‰∫∫ <strong id="deleteContactName" class="text-danger"></strong>Ôºå
                                Ê≠§Êìç‰ΩúÂ∞ÜÊ∞∏‰πÖÂà†Èô§ËØ•ËÅîÁ≥ª‰∫∫ÁöÑÊâÄÊúâ‰ø°ÊÅØÔºå‰∏îÊó†Ê≥ïÊÅ¢Â§ç„ÄÇ
                            </p>
                            <div class="contact-info-preview">
                                <div class="info-item">
                                    <i class="fas fa-user me-2"></i>
                                    <span>ÂßìÂêçÔºö</span>
                                    <span id="deletePreviewName" class="fw-bold"></span>
                                </div>
                                <div class="info-item">
                                    <i class="fas fa-home me-2"></i>
                                    <span>ÊàøÈó¥Ôºö</span>
                                    <span id="deletePreviewRoom" class="fw-bold"></span>
                                </div>
                                <div class="info-item">
                                    <i class="fas fa-phone me-2"></i>
                                    <span>ÁîµËØùÔºö</span>
                                    <span id="deletePreviewPhone" class="fw-bold"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>ÂèñÊ∂à
                    </button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn"
                            onclick="showFinalConfirmation()">
                        <i class="fas fa-trash me-1"></i>Á°ÆËÆ§Âà†Èô§
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ÊúÄÁªàÁ°ÆËÆ§Âà†Èô§ÂØπËØùÊ°Ü -->
    <div class="modal fade" id="finalConfirmModal" tabindex="-1" aria-labelledby="finalConfirmModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="finalConfirmModalLabel">
                        <i class="fas fa-exclamation-triangle me-2"></i>Á°ÆËÆ§Âà†Èô§
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <div class="final-confirm-content">
                        <div class="confirm-icon">
                            <i class="fas fa-trash-alt"></i>
                        </div>
                        <h6 class="confirm-title">ÊÇ®Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ËÅîÁ≥ª‰∫∫ÂêóÔºü</h6>
                        <p class="confirm-message">
                            ÊÇ®Âç≥Â∞ÜÂà†Èô§ËÅîÁ≥ª‰∫∫ <strong id="finalContactName" class="text-danger"></strong>Ôºå
                            Ê≠§Êìç‰Ωú‰ΩúÂ∞ÜÊ∞∏‰πÖÂà†Èô§ËØ•ËÅîÁ≥ª‰∫∫ÁöÑÊâÄÊúâ‰ø°ÊÅØÔºå‰∏îÊó†Ê≥ïÊÅ¢Â§ç„ÄÇ
                        </p>
                        <div class="contact-summary">
                            <div class="summary-item">
                                <i class="fas fa-user me-2"></i>
                                <span>ÂßìÂêçÔºö</span>
                                <span id="finalPreviewName" class="fw-bold"></span>
                            </div>
                            <div class="summary-item">
                                <i class="fas fa-home me-2"></i>
                                <span>ÊàøÈó¥Ôºö</span>
                                <span id="finalPreviewRoom" class="fw-bold"></span>
                            </div>
                            <div class="summary-item">
                                <i class="fas fa-phone me-2"></i>
                                <span>ÁîµËØùÔºö</span>
                                <span id="finalPreviewPhone" class="fw-bold"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>ÂèñÊ∂à
                    </button>
                    <button type="button" class="btn btn-danger" id="finalConfirmBtn" onclick="confirmDeleteContact()">
                        <i class="fas fa-trash me-1"></i>Á°ÆËÆ§Âà†Èô§
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ÊâπÈáèÂà†Èô§Á°ÆËÆ§Ê®°ÊÄÅÊ°Ü -->
    <div class="modal fade" id="batchDeleteModal" tabindex="-1" aria-labelledby="batchDeleteModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="batchDeleteModalLabel">
                        <i class="fas fa-exclamation-triangle me-2"></i>ÊâπÈáèÂà†Èô§Á°ÆËÆ§
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="batch-delete-warning">
                        <div class="warning-icon">
                            <i class="fas fa-users-slash"></i>
                        </div>
                        <div class="warning-content">
                            <h6 class="warning-title">ÊÇ®Á°ÆÂÆöË¶ÅÊâπÈáèÂà†Èô§ÈÄâ‰∏≠ÁöÑËÅîÁ≥ª‰∫∫ÂêóÔºü</h6>
                            <p class="warning-message">
                                ÊÇ®Âç≥Â∞ÜÂà†Èô§ <strong id="batchDeleteCount" class="text-danger"></strong> ‰∏™ËÅîÁ≥ª‰∫∫Ôºå
                                Ê≠§Êìç‰ΩúÂ∞ÜÊ∞∏‰πÖÂà†Èô§Ëøô‰∫õËÅîÁ≥ª‰∫∫ÁöÑÊâÄÊúâ‰ø°ÊÅØÔºå‰∏îÊó†Ê≥ïÊÅ¢Â§ç„ÄÇ
                            </p>
                            <div class="selected-contacts-preview">
                                <h6 class="preview-title">
                                    <i class="fas fa-list me-2"></i>Âç≥Â∞ÜÂà†Èô§ÁöÑËÅîÁ≥ª‰∫∫Ôºö
                                </h6>
                                <div id="batchDeleteList" class="contacts-list">
                                    <!-- Âä®ÊÄÅÂ°´ÂÖÖÈÄâ‰∏≠ÁöÑËÅîÁ≥ª‰∫∫ÂàóË°® -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>ÂèñÊ∂à
                    </button>
                    <button type="button" class="btn btn-danger" id="confirmBatchDeleteBtn"
                            onclick="showBatchFinalConfirmation()">
                        <i class="fas fa-trash me-1"></i>Á°ÆËÆ§ÊâπÈáèÂà†Èô§
                    </button>
                </div>
            </div>
        </div>
    </div>


{% endblock %}

{% block extra_js %}
    <script>
        // ÊêúÁ¥¢ÂäüËÉΩ
        document.getElementById('searchInput').addEventListener('input', function () {
            filterContacts();
        });

        // ÁªºÂêàÁ≠õÈÄâÂäüËÉΩ
        function filterContacts() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const roomFilter = document.getElementById('roomFilter').value;

            // Á≠õÈÄâËÅîÁ≥ª‰∫∫Êï∞ÊçÆ
            filteredContacts = allContacts.filter(contact => {
                const searchData = contact.searchData.toLowerCase();
                const roomData = contact.roomData;

                let showContact = true;

                // ÊêúÁ¥¢Á≠õÈÄâ
                if (searchTerm && !searchData.includes(searchTerm)) {
                    showContact = false;
                }

                // ÊàøÈó¥Á≠õÈÄâ
                if (roomFilter && roomData !== roomFilter) {
                    showContact = false;
                }

                return showContact;
            });

            // ÈáçÁΩÆÂà∞Á¨¨‰∏ÄÈ°µ
            currentPage = 1;

            // Êõ¥Êñ∞ÂàÜÈ°µÊòæÁ§∫
            updatePagination();

            // Êõ¥Êñ∞ËÅîÁ≥ª‰∫∫ËÆ°Êï∞
            updateContactCount(filteredContacts.length);
        }

        // ÊàøÈó¥Á≠õÈÄâ
        function filterByRoom() {
            filterContacts();
        }

        // Ê∏ÖÁ©∫ÊêúÁ¥¢
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('roomFilter').value = '';

            // ÈáçÁΩÆÁ≠õÈÄâÁªìÊûú
            filteredContacts = [...allContacts];
            currentPage = 1;
            updatePagination();
            updateContactCount(filteredContacts.length);
        }

        // Êõ¥Êñ∞Ë°åÂè∑
        function updateRowNumbers() {
            const visibleRows = document.querySelectorAll('.contact-row[style=""], .contact-row:not([style])');
            visibleRows.forEach((row, index) => {
                row.querySelector('.row-number').textContent = index + 1;
            });
        }

        // Êõ¥Êñ∞ËÅîÁ≥ª‰∫∫ËÆ°Êï∞
        function updateContactCount(count) {
            const countBadge = document.getElementById('contactCount');
            if (countBadge) {
                countBadge.textContent = count;
            }
        }

        // Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(function () {
                showToast('Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø', 'success');
            }).catch(function () {
                // ÈôçÁ∫ßÊñπÊ°à
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast('Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø', 'success');
            });
        }

        // ÊòæÁ§∫ÊèêÁ§∫Ê∂àÊÅØ
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(toast);

            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 3000);
        }

        // ÂÖ®ÈÄâ/ÂèñÊ∂àÂÖ®ÈÄâ
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const contactCheckboxes = document.querySelectorAll('.contact-checkbox');

            // Âè™ÂÖÅËÆ∏ÈÄâÊã©Ôºå‰∏çÂÖÅËÆ∏ÂèñÊ∂à
            if (selectAllCheckbox.checked) {
                contactCheckboxes.forEach(checkbox => {
                    checkbox.checked = true;
                });
            } else {
                // Â¶ÇÊûúËØïÂõæÂèñÊ∂àÂÖ®ÈÄâÔºåÈáçÊñ∞ÈÄâ‰∏≠
                selectAllCheckbox.checked = true;
                contactCheckboxes.forEach(checkbox => {
                    checkbox.checked = true;
                });
            }

            updateBatchActions();
        }

        // ÈÄâÊã©ÊâÄÊúâÂèØËßÅÈ°π
        function selectAll() {
            // Ëé∑ÂèñÂΩìÂâçÊòæÁ§∫ÁöÑËßÜÂõæ
            const tableView = document.getElementById('tableView');
            const cardView = document.getElementById('cardView');
            const isTableView = tableView.style.display !== 'none';

            let visibleCheckboxes;
            if (isTableView) {
                visibleCheckboxes = document.querySelectorAll('.contact-row:not([style*="none"]) .contact-checkbox');
            } else {
                visibleCheckboxes = document.querySelectorAll('.contact-card:not([style*="none"]) .contact-checkbox');
            }

            const selectAllCheckbox = document.getElementById('selectAllCheckbox');

            visibleCheckboxes.forEach(checkbox => {
                checkbox.checked = true;
            });

            selectAllCheckbox.checked = visibleCheckboxes.length > 0;
            updateBatchActions();
        }

        // Êõ¥Êñ∞ÊâπÈáèÊìç‰ΩúÊåâÈíÆÁä∂ÊÄÅ
        function updateBatchActions() {
            const checkedBoxes = document.querySelectorAll('.contact-checkbox:checked');
            const batchDeleteBtn = document.getElementById('batchDeleteBtn');

            if (checkedBoxes.length > 0) {
                batchDeleteBtn.disabled = false;
                batchDeleteBtn.innerHTML = `<i class="fas fa-trash"></i> ÊâπÈáèÂà†Èô§ (${checkedBoxes.length})`;
            } else {
                batchDeleteBtn.disabled = true;
                batchDeleteBtn.innerHTML = '<i class="fas fa-trash"></i> ÊâπÈáèÂà†Èô§';
            }
        }

        // ÊâπÈáèÂà†Èô§ - ÊòæÁ§∫Á°ÆËÆ§Ê®°ÊÄÅÊ°Ü
        function batchDelete() {
            const checkedBoxes = document.querySelectorAll('.contact-checkbox:checked');
            if (checkedBoxes.length === 0) {
                showToast('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑËÅîÁ≥ª‰∫∫', 'warning');
                return;
            }

            // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑËÅîÁ≥ª‰∫∫‰ø°ÊÅØ
            const selectedContacts = [];
            checkedBoxes.forEach(checkbox => {
                const row = checkbox.closest('.contact-row') || checkbox.closest('.contact-card');
                if (row) {
                    const name = row.querySelector('.contact-name-modern, .contact-name-card')?.textContent?.trim() || 'Êú™Áü•';
                    const room = row.getAttribute('data-room') || 'Êú™Áü•';
                    let phone = 'Êú™Áü•';

                    // Â∞ùËØïÂ§öÁßçÊñπÂºèËé∑ÂèñÁîµËØùÂè∑Á†Å
                    const phoneElement = row.querySelector('.phone-number');
                    if (phoneElement) {
                        phone = phoneElement.textContent?.trim() || 'Êú™Áü•';
                    } else {
                        // Âú®Âç°ÁâáËßÜÂõæ‰∏≠Êü•ÊâæÁîµËØù
                        const phoneSpans = row.querySelectorAll('.detail-item span');
                        phoneSpans.forEach(span => {
                            const text = span.textContent?.trim();
                            if (text && /^1[3-9]\d{9}$/.test(text)) {
                                phone = text;
                            }
                        });
                    }

                    selectedContacts.push({
                        id: checkbox.value,
                        name: name,
                        room: room,
                        phone: phone
                    });
                }
            });

            // Â°´ÂÖÖÊâπÈáèÂà†Èô§Ê®°ÊÄÅÊ°Ü‰ø°ÊÅØ
            document.getElementById('batchDeleteCount').textContent = selectedContacts.length;

            const contactsList = document.getElementById('batchDeleteList');
            contactsList.innerHTML = selectedContacts.map(contact => `
                <div class="contact-item">
                    <div class="contact-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="contact-details">
                        <div class="contact-name">${contact.name}</div>
                        <div class="contact-meta">
                            <span class="room-info">
                                <i class="fas fa-home me-1"></i>ÊàøÈó¥ ${contact.room}
                            </span>
                            <span class="phone-info">
                                <i class="fas fa-phone me-1"></i>${contact.phone}
                            </span>
                        </div>
                    </div>
                </div>
            `).join('');

            // Â≠òÂÇ®Ë¶ÅÂà†Èô§ÁöÑËÅîÁ≥ª‰∫∫IDÂàóË°®
            document.getElementById('confirmBatchDeleteBtn').setAttribute('data-contact-ids',
                selectedContacts.map(c => c.id).join(','));

            // ÊòæÁ§∫ÊâπÈáèÂà†Èô§Á°ÆËÆ§Ê®°ÊÄÅÊ°Ü
            const modal = new bootstrap.Modal(document.getElementById('batchDeleteModal'));
            modal.show();
        }

        // ÊòæÁ§∫ÊâπÈáèÂà†Èô§ÊúÄÁªàÁ°ÆËÆ§ÂØπËØùÊ°Ü
        function showBatchFinalConfirmation() {
            const contactCount = document.getElementById('batchDeleteCount').textContent;
            const contactsList = document.getElementById('batchDeleteList').innerHTML;

            // Â°´ÂÖÖÊâπÈáèÂà†Èô§ÊúÄÁªàÁ°ÆËÆ§ÂØπËØùÊ°Ü‰ø°ÊÅØ
            document.getElementById('finalBatchCount').textContent = contactCount;
            document.getElementById('finalBatchList').innerHTML = contactsList;

            // ÂÖ≥Èó≠Á¨¨‰∏Ä‰∏™Ê®°ÊÄÅÊ°Ü
            bootstrap.Modal.getInstance(document.getElementById('batchDeleteModal')).hide();

            // ÊòæÁ§∫ÊúÄÁªàÁ°ÆËÆ§ÂØπËØùÊ°Ü
            setTimeout(() => {
                const modal = new bootstrap.Modal(document.getElementById('batchFinalConfirmModal'));
                modal.show();
            }, 300);
        }

        // Á°ÆËÆ§ÊâπÈáèÂà†Èô§
        function confirmBatchDelete() {
            const contactIdsStr = document.getElementById('confirmBatchDeleteBtn').getAttribute('data-contact-ids');
            const contactIds = contactIdsStr.split(',');

            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            const finalBtn = document.getElementById('batchFinalConfirmBtn');
            const originalText = finalBtn.innerHTML;
            finalBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Âà†Èô§‰∏≠...';
            finalBtn.disabled = true;

            // ÊâπÈáèÂà†Èô§ËØ∑Ê±Ç
            Promise.all(contactIds.map(id =>
                fetch(`/api/contacts_new/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
            ))
                .then(responses => Promise.all(responses.map(r => r.json())))
                .then(results => {
                    const successCount = results.filter(r => r.success).length;
                    const failCount = results.length - successCount;

                    if (failCount === 0) {
                        showToast(`ÊàêÂäüÂà†Èô§ ${successCount} ‰∏™ËÅîÁ≥ª‰∫∫ÔºÅ`, 'success');
                    } else if (successCount === 0) {
                        showToast(`Âà†Èô§Â§±Ë¥•Ôºå${failCount} ‰∏™ËÅîÁ≥ª‰∫∫Âà†Èô§Â§±Ë¥•`, 'error');
                    } else {
                        showToast(`ÈÉ®ÂàÜÂà†Èô§ÊàêÂäüÔºö${successCount} ‰∏™ÊàêÂäüÔºå${failCount} ‰∏™Â§±Ë¥•`, 'warning');
                    }

                    // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
                    bootstrap.Modal.getInstance(document.getElementById('batchFinalConfirmModal')).hide();
                    // Âà∑Êñ∞È°µÈù¢
                    setTimeout(() => location.reload(), 1000);
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('ÊâπÈáèÂà†Èô§Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï', 'error');
                    // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                    finalBtn.innerHTML = originalText;
                    finalBtn.disabled = false;
                });
        }

        // Ê∑ªÂä†ËÅîÁ≥ª‰∫∫
        function addContact() {
            // Ê∏ÖÁ©∫Ë°®Âçï
            document.getElementById('addContactForm').reset();
            // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
            const modal = new bootstrap.Modal(document.getElementById('addContactModal'));
            modal.show();
        }

        // Êèê‰∫§Ê∑ªÂä†ËÅîÁ≥ª‰∫∫
        function submitAddContact() {
            const form = document.getElementById('addContactForm');
            const formData = new FormData(form);

            // È™åËØÅË°®Âçï
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const data = {
                name: formData.get('name'),
                roomId: formData.get('roomId'),
                phone: formData.get('phone'),
                id_card: formData.get('id_card')
            };

            // ÂèëÈÄÅÊ∑ªÂä†ËØ∑Ê±Ç
            fetch('/api/contacts_new', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('ËÅîÁ≥ª‰∫∫Ê∑ªÂä†ÊàêÂäüÔºÅ', 'success');
                        // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
                        bootstrap.Modal.getInstance(document.getElementById('addContactModal')).hide();
                        // Âº∫Âà∂Âà∑Êñ∞È°µÈù¢ÔºåÈÅøÂÖçÁºìÂ≠òÈóÆÈ¢ò
                        setTimeout(() => location.reload(true), 1500);
                    } else {
                        showToast('Ê∑ªÂä†Â§±Ë¥•Ôºö' + data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Ê∑ªÂä†Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï', 'error');
                });
        }

        // Êü•ÁúãËÅîÁ≥ª‰∫∫ËØ¶ÊÉÖ
        function viewContact(contactId) {
            // Ëé∑ÂèñËÅîÁ≥ª‰∫∫ËØ¶ÊÉÖ
            fetch(`/api/contacts_new/${contactId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showToast('Ëé∑ÂèñËÅîÁ≥ª‰∫∫‰ø°ÊÅØÂ§±Ë¥•Ôºö' + data.error, 'error');
                        return;
                    }

                    // Â°´ÂÖÖËØ¶ÊÉÖÊï∞ÊçÆ
                    document.getElementById('viewName').textContent = data.name;
                    document.getElementById('viewRoomId').textContent = data.roomId;
                    document.getElementById('viewPhone').textContent = data.phone;
                    document.getElementById('viewIdCard').textContent = data.id_card;
                    document.getElementById('viewCreatedAt').textContent = data.created_at;

                    // Â≠òÂÇ®ÂΩìÂâçËÅîÁ≥ª‰∫∫IDÁî®‰∫éÁºñËæë
                    document.getElementById('viewContactModal').setAttribute('data-contact-id', contactId);

                    // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
                    const modal = new bootstrap.Modal(document.getElementById('viewContactModal'));
                    modal.show();
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Ëé∑ÂèñËÅîÁ≥ª‰∫∫‰ø°ÊÅØÂ§±Ë¥•', 'error');
                });
        }

        // ‰ªéÊü•ÁúãÊ®°ÊÄÅÊ°ÜÂàáÊç¢Âà∞ÁºñËæëÊ®°ÊÄÅÊ°Ü
        function editContactFromView() {
            const contactId = document.getElementById('viewContactModal').getAttribute('data-contact-id');
            // ÂÖ≥Èó≠Êü•ÁúãÊ®°ÊÄÅÊ°Ü
            bootstrap.Modal.getInstance(document.getElementById('viewContactModal')).hide();
            // ÊâìÂºÄÁºñËæëÊ®°ÊÄÅÊ°Ü
            setTimeout(() => editContact(contactId), 300);
        }

        // ÁºñËæëËÅîÁ≥ª‰∫∫
        function editContact(contactId) {
            // Ëé∑ÂèñËÅîÁ≥ª‰∫∫ËØ¶ÊÉÖ
            fetch(`/api/contacts_new/${contactId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showToast('Ëé∑ÂèñËÅîÁ≥ª‰∫∫‰ø°ÊÅØÂ§±Ë¥•Ôºö' + data.error, 'error');
                        return;
                    }

                    // Â°´ÂÖÖÁºñËæëË°®Âçï
                    document.getElementById('editContactId').value = data.id;
                    document.getElementById('editName').value = data.name;
                    document.getElementById('editRoomId').value = data.roomId;
                    document.getElementById('editPhone').value = data.phone;
                    document.getElementById('editIdCard').value = data.id_card;

                    // ÊòæÁ§∫ÁºñËæëÊ®°ÊÄÅÊ°Ü
                    const modal = new bootstrap.Modal(document.getElementById('editContactModal'));
                    modal.show();
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Ëé∑ÂèñËÅîÁ≥ª‰∫∫‰ø°ÊÅØÂ§±Ë¥•', 'error');
                });
        }

        // Êèê‰∫§ÁºñËæëËÅîÁ≥ª‰∫∫
        function submitEditContact() {
            const form = document.getElementById('editContactForm');
            const formData = new FormData(form);

            // È™åËØÅË°®Âçï
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const contactId = formData.get('id');
            const data = {
                name: formData.get('name'),
                roomId: formData.get('roomId'),
                phone: formData.get('phone'),
                id_card: formData.get('id_card')
            };

            // ÂèëÈÄÅÊõ¥Êñ∞ËØ∑Ê±Ç
            fetch(`/api/contacts_new/${contactId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('ËÅîÁ≥ª‰∫∫Êõ¥Êñ∞ÊàêÂäüÔºÅ', 'success');
                        // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
                        bootstrap.Modal.getInstance(document.getElementById('editContactModal')).hide();
                        // Âà∑Êñ∞È°µÈù¢
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showToast('Êõ¥Êñ∞Â§±Ë¥•Ôºö' + data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Êõ¥Êñ∞Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï', 'error');
                });
        }

        // Êã®ÊâìÁîµËØù
        function callContact(phone) {
            if (confirm(`Á°ÆÂÆöË¶ÅÊã®ÊâìÁîµËØù ${phone} ÂêóÔºü`)) {
                window.location.href = `tel:${phone}`;
            }
        }

        // ÂØºÂá∫ËÅîÁ≥ª‰∫∫
        function exportContacts() {
            showToast('ÂØºÂá∫ËÅîÁ≥ª‰∫∫ÂäüËÉΩÂºÄÂèë‰∏≠...', 'info');
        }

        // ÂØºÂÖ•ËÅîÁ≥ª‰∫∫
        function importContacts() {
            showToast('ÊâπÈáèÂØºÂÖ•ËÅîÁ≥ª‰∫∫ÂäüËÉΩÂºÄÂèë‰∏≠...', 'info');
        }

        // Âà∑Êñ∞ËÅîÁ≥ª‰∫∫ÂàóË°®
        function refreshContacts() {
            showToast('Ê≠£Âú®Âà∑Êñ∞Êï∞ÊçÆ...', 'info');
            setTimeout(() => {
                location.reload();
            }, 1000);
        }

        // ËßÜÂõæÂàáÊç¢ÂäüËÉΩ
        function switchView(viewType) {
            const tableView = document.getElementById('tableView');
            const cardView = document.getElementById('cardView');
            const viewButtons = document.querySelectorAll('.btn-view-option');

            // ÁßªÈô§ÊâÄÊúâÊ¥ªË∑ÉÁä∂ÊÄÅ
            viewButtons.forEach(btn => btn.classList.remove('active'));

            if (viewType === 'table') {
                tableView.style.display = 'block';
                cardView.style.display = 'none';
                document.querySelector('[onclick="switchView(\'table\')"]').classList.add('active');
                itemsPerPage = 10; // Ë°®Ê†ºËßÜÂõæÊØèÈ°µ10Êù°
            } else {
                tableView.style.display = 'none';
                cardView.style.display = 'block';
                document.querySelector('[onclick="switchView(\'card\')"]').classList.add('active');
                itemsPerPage = 12; // Âç°ÁâáËßÜÂõæÊØèÈ°µ12Êù°
            }

            // ÈáçÁΩÆÂà∞Á¨¨‰∏ÄÈ°µ
            currentPage = 1;

            // ÈáçÊñ∞Â∫îÁî®Á≠õÈÄâÂíåÂàÜÈ°µ
            if (typeof filteredContacts !== 'undefined') {
                updatePagination();
            }
        }

        // Ë°®Ê†ºÊéíÂ∫èÂäüËÉΩ
        let sortDirection = {};

        function sortTable(column) {
            const tbody = document.getElementById('contactsTableBody');
            const rows = Array.from(tbody.querySelectorAll('.contact-row'));

            // ÂàáÊç¢ÊéíÂ∫èÊñπÂêë
            sortDirection[column] = sortDirection[column] === 'asc' ? 'desc' : 'asc';

            // Êõ¥Êñ∞ÊéíÂ∫èÂõæÊ†á
            document.querySelectorAll('.sort-icon').forEach(icon => {
                icon.className = 'fas fa-sort sort-icon';
            });

            const currentIcon = document.querySelector(`[onclick="sortTable('${column}')"] .sort-icon`);
            if (sortDirection[column] === 'asc') {
                currentIcon.className = 'fas fa-sort-up sort-icon';
            } else {
                currentIcon.className = 'fas fa-sort-down sort-icon';
            }

            // ÊéíÂ∫èÈÄªËæë
            rows.sort((a, b) => {
                let aValue, bValue;

                switch (column) {
                    case 'index':
                        aValue = parseInt(a.querySelector('.row-number-badge').textContent);
                        bValue = parseInt(b.querySelector('.row-number-badge').textContent);
                        break;
                    case 'room':
                        aValue = a.getAttribute('data-room');
                        bValue = b.getAttribute('data-room');
                        break;
                    case 'name':
                        aValue = a.querySelector('.contact-name-modern').textContent;
                        bValue = b.querySelector('.contact-name-modern').textContent;
                        break;
                    case 'phone':
                        aValue = a.querySelector('.phone-number').textContent;
                        bValue = b.querySelector('.phone-number').textContent;
                        break;
                    case 'date':
                        aValue = a.querySelector('.date-main').textContent;
                        bValue = b.querySelector('.date-main').textContent;
                        break;
                    default:
                        return 0;
                }

                if (sortDirection[column] === 'asc') {
                    return aValue > bValue ? 1 : -1;
                } else {
                    return aValue < bValue ? 1 : -1;
                }
            });

            // ÈáçÊñ∞ÊèíÂÖ•ÊéíÂ∫èÂêéÁöÑË°å
            rows.forEach(row => tbody.appendChild(row));

            // Êõ¥Êñ∞Ë°åÂè∑
            updateRowNumbers();
        }

        // Âà†Èô§ËÅîÁ≥ª‰∫∫ - ÊòæÁ§∫Á°ÆËÆ§Ê®°ÊÄÅÊ°Ü
        function deleteContact(contactId, contactName) {
            // ÂÖàËé∑ÂèñËÅîÁ≥ª‰∫∫ËØ¶ÁªÜ‰ø°ÊÅØ
            fetch(`/api/contacts_new/${contactId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showToast('Ëé∑ÂèñËÅîÁ≥ª‰∫∫‰ø°ÊÅØÂ§±Ë¥•Ôºö' + data.error, 'error');
                        return;
                    }

                    // Â°´ÂÖÖÂà†Èô§Á°ÆËÆ§Ê®°ÊÄÅÊ°ÜÁöÑ‰ø°ÊÅØ
                    document.getElementById('deleteContactName').textContent = data.name;
                    document.getElementById('deletePreviewName').textContent = data.name;
                    document.getElementById('deletePreviewRoom').textContent = data.roomId;
                    document.getElementById('deletePreviewPhone').textContent = data.phone;

                    // Â≠òÂÇ®Ë¶ÅÂà†Èô§ÁöÑËÅîÁ≥ª‰∫∫ID
                    document.getElementById('confirmDeleteBtn').setAttribute('data-contact-id', contactId);

                    // ÊòæÁ§∫Âà†Èô§Á°ÆËÆ§Ê®°ÊÄÅÊ°Ü
                    const modal = new bootstrap.Modal(document.getElementById('deleteContactModal'));
                    modal.show();
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Ëé∑ÂèñËÅîÁ≥ª‰∫∫‰ø°ÊÅØÂ§±Ë¥•', 'error');
                });
        }

        // ÊòæÁ§∫ÊúÄÁªàÁ°ÆËÆ§ÂØπËØùÊ°Ü
        function showFinalConfirmation() {
            const contactName = document.getElementById('deleteContactName').textContent;
            const contactRoom = document.getElementById('deletePreviewRoom').textContent;
            const contactPhone = document.getElementById('deletePreviewPhone').textContent;

            // Â°´ÂÖÖÊúÄÁªàÁ°ÆËÆ§ÂØπËØùÊ°Ü‰ø°ÊÅØ
            document.getElementById('finalContactName').textContent = contactName;
            document.getElementById('finalPreviewName').textContent = contactName;
            document.getElementById('finalPreviewRoom').textContent = contactRoom;
            document.getElementById('finalPreviewPhone').textContent = contactPhone;

            // ÂÖ≥Èó≠Á¨¨‰∏Ä‰∏™Ê®°ÊÄÅÊ°Ü
            bootstrap.Modal.getInstance(document.getElementById('deleteContactModal')).hide();

            // ÊòæÁ§∫ÊúÄÁªàÁ°ÆËÆ§ÂØπËØùÊ°Ü
            setTimeout(() => {
                const modal = new bootstrap.Modal(document.getElementById('finalConfirmModal'));
                modal.show();
            }, 300);
        }

        // Á°ÆËÆ§Âà†Èô§ËÅîÁ≥ª‰∫∫
        function confirmDeleteContact() {
            const contactId = document.getElementById('confirmDeleteBtn').getAttribute('data-contact-id');
            const contactName = document.getElementById('finalContactName').textContent;

            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            const finalBtn = document.getElementById('finalConfirmBtn');
            const originalText = finalBtn.innerHTML;
            finalBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Âà†Èô§‰∏≠...';
            finalBtn.disabled = true;

            // ÂèëÈÄÅÂà†Èô§ËØ∑Ê±Ç
            fetch(`/api/contacts_new/${contactId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast(`ËÅîÁ≥ª‰∫∫ "${contactName}" Âà†Èô§ÊàêÂäüÔºÅ`, 'success');
                        // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
                        bootstrap.Modal.getInstance(document.getElementById('finalConfirmModal')).hide();
                        // Âà∑Êñ∞È°µÈù¢
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showToast('Âà†Èô§Â§±Ë¥•Ôºö' + data.message, 'error');
                        // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                        finalBtn.innerHTML = originalText;
                        finalBtn.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Âà†Èô§Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï', 'error');
                    // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                    finalBtn.innerHTML = originalText;
                    finalBtn.disabled = false;
                });
        }

        // Êï∞Â≠óÂä®ÁîªÊïàÊûú
        function animateNumbers() {
            const numbers = document.querySelectorAll('.stats-number[data-count]');
            numbers.forEach(number => {
                const target = parseInt(number.getAttribute('data-count'));
                let current = 0;
                const increment = target / 50;
                const timer = setInterval(() => {
                    current += increment;
                    if (current >= target) {
                        current = target;
                        clearInterval(timer);
                    }
                    number.textContent = Math.floor(current);
                }, 30);
            });
        }

        // Âø´ÈÄüÁ≠õÈÄâÂäüËÉΩ
        function quickFilter(type) {
            // ÁßªÈô§ÊâÄÊúâÊ¥ªË∑ÉÁä∂ÊÄÅ
            document.querySelectorAll('.filter-tag').forEach(tag => {
                tag.classList.remove('active');
            });

            // Ê∑ªÂä†ÂΩìÂâçÊ¥ªË∑ÉÁä∂ÊÄÅ
            event.target.classList.add('active');

            const rows = document.querySelectorAll('.contact-row');

            rows.forEach(row => {
                let showRow = true;

                switch (type) {
                    case 'all':
                        showRow = true;
                        break;
                    case 'recent':
                        // ËøôÈáåÂèØ‰ª•Ê†πÊçÆÂàõÂª∫Êó∂Èó¥Á≠õÈÄâ
                        showRow = true; // ÊöÇÊó∂ÊòæÁ§∫ÊâÄÊúâ
                        break;
                    case 'phone':
                        const phone = row.querySelector('.contact-phone').textContent.trim();
                        showRow = phone && phone !== '-';
                        break;
                    case 'no-phone':
                        const noPhone = row.querySelector('.contact-phone').textContent.trim();
                        showRow = !noPhone || noPhone === '-';
                        break;
                }

                row.style.display = showRow ? '' : 'none';
            });

            updateRowNumbers();
            updateContactCount(document.querySelectorAll('.contact-row[style=""], .contact-row:not([style])').length);
        }


        // ÂàÜÈ°µÁõ∏ÂÖ≥ÂèòÈáè
        let currentPage = 1;
        let itemsPerPage = 12; // ÈªòËÆ§Âç°ÁâáËßÜÂõæÊØèÈ°µ12Êù°
        let allContacts = [];
        let filteredContacts = [];

        // ÂàùÂßãÂåñËÅîÁ≥ª‰∫∫Êï∞ÊçÆ
        function initContactsData() {
            allContacts = [];

            // ‰ªéË°®Ê†ºË°å‰∏≠ÊèêÂèñÊï∞ÊçÆ
            const tableRows = document.querySelectorAll('#tableView .contact-row');
            tableRows.forEach((row, index) => {
                const contact = {
                    element: row,
                    cardElement: document.querySelectorAll('#cardView .contact-card')[index],
                    searchData: row.getAttribute('data-search') || '',
                    roomData: row.getAttribute('data-room') || '',
                    index: index
                };
                allContacts.push(contact);
            });

            // ÂàùÂßãÂåñÁ≠õÈÄâÁªìÊûú‰∏∫ÊâÄÊúâËÅîÁ≥ª‰∫∫
            filteredContacts = [...allContacts];
        }

        // ÂàùÂßãÂåñÂàÜÈ°µ
        function initPagination() {
            // Ëé∑ÂèñÊâÄÊúâËÅîÁ≥ª‰∫∫Êï∞ÊçÆ
            const tableRows = document.querySelectorAll('.contact-row');
            const cardItems = document.querySelectorAll('.contact-card');

            allContacts = Array.from(tableRows).map((row, index) => ({
                tableElement: row,
                cardElement: cardItems[index],
                searchData: row.getAttribute('data-search'),
                roomData: row.getAttribute('data-room')
            }));

            filteredContacts = [...allContacts];
            updatePagination();
        }

        // Êõ¥Êñ∞ÂàÜÈ°µÊòæÁ§∫
        function updatePagination() {
            const totalItems = filteredContacts.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);

            // Á°Æ‰øùÂΩìÂâçÈ°µÂú®ÊúâÊïàËåÉÂõ¥ÂÜÖ
            if (currentPage > totalPages) {
                currentPage = Math.max(1, totalPages);
            }

            // ÊòæÁ§∫ÂΩìÂâçÈ°µÁöÑÊï∞ÊçÆ
            displayCurrentPage();

            // Êõ¥Êñ∞ÂàÜÈ°µ‰ø°ÊÅØ
            updatePaginationInfo(totalItems, totalPages);
        }

        // ÊòæÁ§∫ÂΩìÂâçÈ°µÊï∞ÊçÆ
        function displayCurrentPage() {
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;

            // ÈöêËóèÊâÄÊúâÈ°πÁõÆ
            allContacts.forEach(contact => {
                if (contact.element) contact.element.style.display = 'none';
                if (contact.cardElement) contact.cardElement.style.display = 'none';
            });

            // ÊòæÁ§∫ÂΩìÂâçÈ°µÁöÑÈ°πÁõÆ
            filteredContacts.slice(startIndex, endIndex).forEach((contact, index) => {
                const tableView = document.getElementById('tableView');
                const isTableView = tableView.style.display !== 'none';

                if (isTableView && contact.element) {
                    contact.element.style.display = '';
                    // Êõ¥Êñ∞Ë°åÂè∑
                    const rowNumber = contact.element.querySelector('.row-number');
                    if (rowNumber) {
                        rowNumber.textContent = startIndex + index + 1;
                    }
                } else if (!isTableView && contact.cardElement) {
                    contact.cardElement.style.display = '';
                }
            });
        }

        // Êõ¥Êñ∞ÂàÜÈ°µ‰ø°ÊÅØ
        function updatePaginationInfo(totalItems, totalPages) {
            const paginationText = document.querySelector('.pagination-text');
            if (paginationText) {
                paginationText.textContent = `ÂÖ± ${totalItems} Êù°ËÅîÁ≥ª‰∫∫ËÆ∞ÂΩïÔºåÂΩìÂâçÁ¨¨ ${currentPage} È°µÔºåÂÖ± ${totalPages} È°µ`;
            }
        }

        // ÂàáÊç¢È°µÈù¢
        function changePage(page) {
            const totalPages = Math.ceil(filteredContacts.length / itemsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                updatePagination();
            }
        }

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÁöÑÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function () {
            // ÂàùÂßãÂåñAOSÂä®Áîª
            if (typeof AOS !== 'undefined') {
                AOS.init({
                    duration: 800,
                    easing: 'ease-in-out',
                    once: true,
                    offset: 100
                });
            }

            // Êï∞Â≠óÂä®Áîª
            setTimeout(animateNumbers, 800);

            // ËÆæÁΩÆËÅîÁ≥ª‰∫∫ÂàóË°®ÂØºËà™‰∏∫Ê¥ªË∑ÉÁä∂ÊÄÅ
            const contactsLink = document.querySelector('a[href*="contacts_new"]');
            if (contactsLink) {
                contactsLink.classList.add('active');
            }

            // ÂàùÂßãÂåñËÅîÁ≥ª‰∫∫Êï∞ÊçÆ
            initContactsData();

            // ÂàùÂßãÂåñÂàÜÈ°µ
            initPagination();

            // ËÆæÁΩÆÈªòËÆ§‰∏∫Âç°ÁâáËßÜÂõæ
            switchView('card');

            // Ê∑ªÂä†Ë°®Ê†ºË°åÁöÑÊÇ¨ÂÅúÊïàÊûú
            const tableRows = document.querySelectorAll('.contact-row');
            tableRows.forEach(row => {
                row.addEventListener('mouseenter', function () {
                    this.style.transform = 'scale(1.01)';
                    this.style.transition = 'transform 0.2s ease';
                });

                row.addEventListener('mouseleave', function () {
                    this.style.transform = 'scale(1)';
                });
            });

            // Ê∑ªÂä†Âç°ÁâáÊÇ¨ÂÅúÊïàÊûú
            const statsCards = document.querySelectorAll('.stats-card');
            statsCards.forEach(card => {
                card.addEventListener('mouseenter', function () {
                    this.style.transform = 'translateY(-10px) scale(1.02)';
                });

                card.addEventListener('mouseleave', function () {
                    this.style.transform = 'translateY(0) scale(1)';
                });
            });

            // Ê∑ªÂä†ÊêúÁ¥¢Ê°ÜÁÑ¶ÁÇπÊïàÊûú
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('focus', function () {
                    this.parentElement.style.transform = 'scale(1.02)';
                });

                searchInput.addEventListener('blur', function () {
                    this.parentElement.style.transform = 'scale(1)';
                });
            }
        });
    </script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

    <!-- ÊâπÈáèÂà†Èô§ÊúÄÁªàÁ°ÆËÆ§ÂØπËØùÊ°Ü -->
    <div class="modal fade" id="batchFinalConfirmModal" tabindex="-1" aria-labelledby="batchFinalConfirmModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="batchFinalConfirmModalLabel">
                        <i class="fas fa-exclamation-triangle me-2"></i>Á°ÆËÆ§ÊâπÈáèÂà†Èô§
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <div class="batch-final-confirm-content">
                        <div class="confirm-icon">
                            <i class="fas fa-users-slash"></i>
                        </div>
                        <h6 class="confirm-title">ÊÇ®Á°ÆÂÆöË¶ÅÊâπÈáèÂà†Èô§ÈÄâ‰∏≠ÁöÑËÅîÁ≥ª‰∫∫ÂêóÔºü</h6>
                        <p class="confirm-message">
                            ÊÇ®Âç≥Â∞ÜÂà†Èô§ <strong id="finalBatchCount" class="text-danger"></strong> ‰∏™ËÅîÁ≥ª‰∫∫Ôºå
                            Ê≠§Êìç‰ΩúÂ∞ÜÊ∞∏‰πÖÂà†Èô§Ëøô‰∫õËÅîÁ≥ª‰∫∫ÁöÑÊâÄÊúâ‰ø°ÊÅØÔºå‰∏îÊó†Ê≥ïÊÅ¢Â§ç„ÄÇ
                        </p>
                        <div class="batch-summary">
                            <h6 class="summary-title">
                                <i class="fas fa-list me-2"></i>Âç≥Â∞ÜÂà†Èô§ÁöÑËÅîÁ≥ª‰∫∫Ôºö
                            </h6>
                            <div id="finalBatchList" class="final-contacts-list">
                                <!-- Âä®ÊÄÅÂ°´ÂÖÖÈÄâ‰∏≠ÁöÑËÅîÁ≥ª‰∫∫ÂàóË°® -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>ÂèñÊ∂à
                    </button>
                    <button type="button" class="btn btn-danger" id="batchFinalConfirmBtn"
                            onclick="confirmBatchDelete()">
                        <i class="fas fa-trash me-1"></i>Á°ÆËÆ§ÊâπÈáèÂà†Èô§
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

