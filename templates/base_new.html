<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}租房管理系统{% endblock %}</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Base CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <!-- System Settings CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/system-settings.css') }}">

    {% block extra_css %}
        <link rel="stylesheet" href="{{ url_for('static', filename='css/index5.css') }}">
    {% endblock %}
</head>
<body>
<!-- 侧边栏 -->
<nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <h4><i class="fas fa-home"></i> 租房管理系统</h4>
        <div class="subtitle">Property Management</div>
    </div>

    <div class="sidebar-nav">
        <!-- 主页 -->
        <div class="nav-item">
            <a href="{{ url_for('index6') }}" class="nav-link">
                <i class="fas fa-home"></i>
                <span>主页</span>
            </a>
        </div>
        <!-- 联系人管理 -->
        <div class="nav-section">联系人管理</div>

        <div class="nav-item">
            <a href="{{ url_for('contacts_new') }}" class="nav-link">
                <i class="fas fa-address-book"></i>
                <span>联系人列表</span>
            </a>
        </div>

        <!-- 租房管理 -->
        <div class="nav-section">租房管理</div>

        <div class="nav-item">
            <a href="{{ url_for('rooms_new') }}" class="nav-link">
                <i class="fas fa-building"></i>
                <span>房间管理</span>
            </a>
        </div>

        <div class="nav-item">
            <a href="{{ url_for('rental_info_new') }}" class="nav-link">
                <i class="fas fa-home"></i>
                <span>租房信息</span>
            </a>
        </div>

        <div class="nav-item">
            <a href="{{ url_for('contracts_new') }}" class="nav-link">
                <i class="fas fa-file-contract"></i>
                <span>合同管理</span>
            </a>
        </div>

        <!-- 租房记录 -->
        <div class="nav-section">租房记录</div>

        <div class="nav-item">
            <a href="{{ url_for('rental_new') }}" class="nav-link">
                <i class="fas fa-history"></i>
                <span>收费管理</span>
            </a>
        </div>

        <div class="nav-item">
            <a href="{{ url_for('rental_records_new') }}" class="nav-link">
                <i class="fas fa-money-bill-wave"></i>
                <span>缴费记录</span>
            </a>
        </div>
        <!-- 系统设置 -->
        <div class="nav-section">系统设置</div>

        <div class="nav-item">
            <a href="{{ url_for('system_setting_new') if url_for else '#' }}" class="nav-link">
                <i class="fas fa-cog"></i>
                <span>系统设置</span>
            </a>
        </div>

        <div class="nav-item">
            <a href="{{ url_for('out_system') }}" class="nav-link">
                <i class="fas fa-sign-out-alt"></i>
                <span>退出系统</span>
            </a>
        </div>
    </div>
</nav>

<!-- 主内容区域 -->
<div class="main-content" id="mainContent">
    <!-- 顶部导航栏 -->
    <div class="top-navbar">
        <div class="navbar-left">
            <button class="sidebar-toggle" id="sidebarToggle">
                <i class="fas fa-bars"></i>
            </button>
            <h1 class="page-title">{% block page_title %}仪表盘{% endblock %}</h1>
        </div>

        <div class="navbar-right">
            {% if floor %}
                <div class="floor-indicator">
                    <i class="fas fa-building"></i> {{ floor }}楼
                </div>
            {% endif %}

            <div class="user-menu">
                <div class="dropdown">
                    <div class="user-avatar dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false"
                         title="{{ current_admin_name }}">
                        <i class="fas fa-user"></i>
                    </div>
                    <ul class="dropdown-menu dropdown-menu-end admin-dropdown">
                        <li class="dropdown-header">
                            <i class="fas fa-user-shield"></i> {{ current_admin_name }}
                        </li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li>
                            <a class="dropdown-item" href="{{ url_for('system_setting_new') }}">
                                <i class="fas fa-cog"></i> 系统设置
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="#" onclick="showAdminProfile()">
                                <i class="fas fa-user-edit"></i> 个人资料
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="#" onclick="changePassword()">
                                <i class="fas fa-key"></i> 修改密码
                            </a>
                        </li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li>
                            <a class="dropdown-item" href="{{ url_for('admin') }}">
                                <i class="fas fa-tachometer-alt"></i> 管理员列表
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="{{ url_for('dashboard') }}">
                                <i class="fas fa-tachometer-alt"></i> 返回仪表盘
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item text-danger" href="{{ url_for('out_system') }}">
                                <i class="fas fa-sign-out-alt"></i> 退出登录
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- 面包屑导航 -->
    {% block breadcrumb %}
        <div class="breadcrumb-container">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}"><i class="fas fa-home"></i>首页</a>
                    </li>
                    {% if floor %}
                        <li class="breadcrumb-item active">{{ floor }}楼管理</li>
                    {% endif %}
                </ol>
            </nav>
        </div>
    {% endblock %}

    <!-- 主要内容区域 -->
    <div class="content-area">
        {% block content %}
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body text-center">
                            <h3>欢迎使用租房管理系统</h3>
                            <p class="text-muted">请从左侧菜单选择功能模块</p>
                        </div>
                    </div>
                </div>
            </div>
        {% endblock %}
    </div>

    <!-- 页脚 -->
    <footer class="main-footer">
        <div class="footer-content">
            <div class="row">
                <!-- 系统信息 -->
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="footer-section">
                        <h5 class="footer-title">
                            <i class="fas fa-home"></i>
                            租房管理系统
                        </h5>
                        <p class="footer-description">
                            专业的租房管理解决方案，帮助您轻松管理房屋租赁业务，提高工作效率。
                        </p>
                        <div class="footer-stats">
                            <span class="stat-item">
                                <i class="fas fa-building"></i>
                                多楼层管理
                            </span>
                            <span class="stat-item">
                                <i class="fas fa-users"></i>
                                租客管理
                            </span>
                            <span class="stat-item">
                                <i class="fas fa-money-bill-wave"></i>
                                财务管理
                            </span>
                        </div>
                    </div>
                </div>

                <!-- 快速链接 -->
                <div class="col-lg-2 col-md-6 mb-4">
                    <div class="footer-section">
                        <h6 class="footer-subtitle">快速导航</h6>
                        <ul class="footer-links">
                            <li><a href="{{ url_for('dashboard') }}"><i class="fas fa-tachometer-alt"></i> 仪表盘</a>
                            </li>
                            <li><a href="{{ url_for('index5') }}"><i class="fas fa-building"></i> 五楼管理</a></li>
                            <li><a href="{{ url_for('index6') }}"><i class="fas fa-building"></i> 六楼管理</a></li>
                            <li><a href="{{ url_for('system_setting') }}"><i class="fas fa-address-book"></i>
                                系统设置</a></li>
                        </ul>
                    </div>
                </div>

                <!-- 功能模块 -->
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="footer-section">
                        <h6 class="footer-subtitle">主要功能</h6>
                        <ul class="footer-links">
                            <li><a href="{{ url_for('contacts_new') }}"><i class="fas fa-chart-bar"></i> 联系人列表</a>
                            </li>
                            <li><a href="{{ url_for('rooms_new') }}"><i class="fas fa-home"></i> 房间管理</a></li>
                            <li><a href="{{ url_for('contracts_new') }}"><i class="fas fa-file-contract"></i>
                                合同管理</a></li>
                            <li><a href="{{ url_for('rental_new') }}"><i class="fas fa-money-bill"></i> 收费管理</a>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- 系统信息 -->
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="footer-section">
                        <h6 class="footer-subtitle">系统信息</h6>
                        <div class="system-info">
                            <div class="info-item">
                                <i class="fas fa-code"></i>
                                <span>版本: v1.0.0</span>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-calendar"></i>
                                <span>更新: 2024年1月</span>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-server"></i>
                                <span>状态: 运行正常</span>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-clock"></i>
                                <span id="currentTime">--:--:--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 版权信息 -->
            <div class="footer-bottom">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <p class="copyright">
                            <i class="fas fa-copyright"></i>
                            2024 租房管理系统. 保留所有权利.
                        </p>
                    </div>
                    <div class="col-md-6 text-end">
                        <div class="footer-social">
                            <span class="social-text">技术支持:</span>
                            <a href="#" class="social-link" title="技术支持">
                                <i class="fas fa-headset"></i>
                            </a>
                            <a href="#" class="social-link" title="用户手册">
                                <i class="fas fa-book"></i>
                            </a>
                            <a href="#" class="social-link" title="系统设置">
                                <i class="fas fa-cog"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </footer>
</div>


<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // 全局变量
    let isResizing = false;
    let touchStartX = 0;
    let touchStartY = 0;

    // 侧边栏切换功能
    document.getElementById('sidebarToggle').addEventListener('click', function (e) {
        e.preventDefault();
        e.stopPropagation();

        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');

        if (window.innerWidth <= 768) {
            sidebar.classList.toggle('show');
            // 添加/移除body滚动锁定
            if (sidebar.classList.contains('show')) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = '';
            }
        } else {
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('expanded');
        }
    });

    // 响应式处理 - 防抖优化
    function handleResize() {
        if (isResizing) return;
        isResizing = true;

        requestAnimationFrame(() => {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');

            if (window.innerWidth <= 768) {
                sidebar.classList.remove('collapsed');
                mainContent.classList.remove('expanded');
                // 移动端默认隐藏侧边栏
                if (sidebar.classList.contains('show')) {
                    document.body.style.overflow = 'hidden';
                } else {
                    document.body.style.overflow = '';
                }
            } else {
                sidebar.classList.remove('show');
                document.body.style.overflow = '';
            }

            isResizing = false;
        });
    }

    window.addEventListener('resize', handleResize);

    // 点击主内容区域时隐藏移动端侧边栏
    document.getElementById('mainContent').addEventListener('click', function (e) {
        if (window.innerWidth <= 768) {
            const sidebar = document.getElementById('sidebar');
            if (sidebar.classList.contains('show')) {
                sidebar.classList.remove('show');
                document.body.style.overflow = '';
            }
        }
    });

    // 移动端触摸手势支持
    function handleTouchStart(e) {
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
    }

    function handleTouchMove(e) {
        if (!touchStartX || !touchStartY) return;

        const touchEndX = e.touches[0].clientX;
        const touchEndY = e.touches[0].clientY;
        const diffX = touchStartX - touchEndX;
        const diffY = touchStartY - touchEndY;

        // 只在水平滑动距离大于垂直滑动距离时处理
        if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
            const sidebar = document.getElementById('sidebar');

            if (window.innerWidth <= 768) {
                if (diffX > 0 && sidebar.classList.contains('show')) {
                    // 向左滑动，隐藏侧边栏
                    sidebar.classList.remove('show');
                    document.body.style.overflow = '';
                } else if (diffX < 0 && !sidebar.classList.contains('show') && touchStartX < 50) {
                    // 从左边缘向右滑动，显示侧边栏
                    sidebar.classList.add('show');
                    document.body.style.overflow = 'hidden';
                }
            }
        }

        touchStartX = 0;
        touchStartY = 0;
    }

    // 添加触摸事件监听器
    if ('ontouchstart' in window) {
        document.addEventListener('touchstart', handleTouchStart, {passive: true});
        document.addEventListener('touchmove', handleTouchMove, {passive: true});
    }

    // ESC键关闭移动端侧边栏
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape' && window.innerWidth <= 768) {
            const sidebar = document.getElementById('sidebar');
            if (sidebar.classList.contains('show')) {
                sidebar.classList.remove('show');
                document.body.style.overflow = '';
            }
        }
    });

    // 设置当前页面的导航项为活跃状态
    document.addEventListener('DOMContentLoaded', function () {
        const currentPath = window.location.pathname;
        const navLinks = document.querySelectorAll('.nav-link');

        navLinks.forEach(link => {
            if (link.getAttribute('href') === currentPath) {
                link.classList.add('active');
                // 确保活跃项在视口中可见
                link.scrollIntoView({behavior: 'smooth', block: 'nearest'});
            }
        });

        // 为导航链接添加点击时的反馈效果
        navLinks.forEach(link => {
            link.addEventListener('click', function () {
                // 移动端点击导航后自动关闭侧边栏
                if (window.innerWidth <= 768) {
                    const sidebar = document.getElementById('sidebar');
                    setTimeout(() => {
                        sidebar.classList.remove('show');
                        document.body.style.overflow = '';
                    }, 150); // 延迟关闭，让用户看到点击效果
                }
            });
        });

        // 初始化时检查屏幕尺寸
        handleResize();
    });

    // 页面可见性变化时的处理
    document.addEventListener('visibilitychange', function () {
        if (document.hidden) {
            // 页面隐藏时关闭移动端侧边栏
            if (window.innerWidth <= 768) {
                const sidebar = document.getElementById('sidebar');
                if (sidebar.classList.contains('show')) {
                    sidebar.classList.remove('show');
                    document.body.style.overflow = '';
                }
            }
        }
    });

    // 自动应用系统设置
    function applySystemSettings() {
        const savedSettings = localStorage.getItem('systemSettings');
        if (savedSettings) {
            try {
                const settings = JSON.parse(savedSettings);

                // 应用字体大小
                if (settings.fontSize) {
                    document.documentElement.style.setProperty('--system-font-size', settings.fontSize + 'px');
                    document.documentElement.style.fontSize = settings.fontSize + 'px';
                }

                // 应用字体样式
                if (settings.fontFamily) {
                    document.body.style.fontFamily = settings.fontFamily;
                    document.documentElement.style.setProperty('--system-font-family', settings.fontFamily);
                }

                // 应用背景
                if (settings.background) {
                    document.body.style.background = settings.background;
                    document.documentElement.style.setProperty('--system-background', settings.background);

                    // 处理深色模式
                    if (settings.background === '#2c3e50' || settings.background === '#1a1a1a') {
                        document.body.style.color = '#ffffff';
                        document.body.classList.add('dark-mode-text');

                        // 为卡片添加深色模式样式
                        const cards = document.querySelectorAll('.card, .settings-card');
                        cards.forEach(card => {
                            card.classList.add('dark-mode-card');
                        });
                    } else {
                        document.body.style.color = '';
                        document.body.classList.remove('dark-mode-text');

                        const cards = document.querySelectorAll('.card, .settings-card');
                        cards.forEach(card => {
                            card.classList.remove('dark-mode-card');
                        });
                    }
                }
            } catch (e) {
                console.warn('Failed to apply system settings:', e);
            }
        }
    }

    // 页面加载时立即应用设置
    applySystemSettings();

    // 监听 storage 事件，当其他页面修改设置时同步应用
    window.addEventListener('storage', function (e) {
        if (e.key === 'systemSettings') {
            applySystemSettings();
        }
    });

    // 页脚时间更新功能
    function updateCurrentTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('zh-CN', {
            hour12: false,
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });

        const timeElement = document.getElementById('currentTime');
        if (timeElement) {
            timeElement.textContent = timeString;
        }
    }

    // 页面加载完成后启动时间更新
    document.addEventListener('DOMContentLoaded', function () {
        // 立即更新一次时间
        updateCurrentTime();

        // 每秒更新时间
        setInterval(updateCurrentTime, 1000);

        // 页脚链接悬停效果
        const footerLinks = document.querySelectorAll('.footer-links a, .social-link');
        footerLinks.forEach(link => {
            link.addEventListener('mouseenter', function () {
                this.style.transform = 'translateX(5px)';
            });

            link.addEventListener('mouseleave', function () {
                this.style.transform = 'translateX(0)';
            });
        });
    });

    // 管理员功能函数
    function showAdminProfile() {
        // 创建管理员资料模态框
        const modalHtml = `
            <div class="modal fade" id="adminProfileModal" tabindex="-1" aria-labelledby="adminProfileModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title" id="adminProfileModalLabel">
                                <i class="fas fa-user-edit me-2"></i>管理员资料
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-4 text-center">
                                    <div class="admin-avatar-large mb-3">
                                        <i class="fas fa-user-shield"></i>
                                    </div>
                                    <h5>{{ current_admin_name }}</h5>
                                    <p class="text-muted">系统管理员</p>
                                </div>
                                <div class="col-md-8">
                                    <form id="adminProfileForm">
                                        <div class="mb-3">
                                            <label for="adminUsername" class="form-label">用户名</label>
                                            <input type="text" class="form-control" id="adminUsername" value="{{ current_admin_name }}" readonly>
                                        </div>
                                        <div class="mb-3">
                                            <label for="adminEmail" class="form-label">邮箱</label>
                                            <input type="email" class="form-control" id="adminEmail" value="admin@rental.com" placeholder="请输入邮箱">
                                        </div>
                                        <div class="mb-3">
                                            <label for="adminPhone" class="form-label">联系电话</label>
                                            <input type="tel" class="form-control" id="adminPhone" placeholder="请输入联系电话">
                                        </div>
                                        <div class="mb-3">
                                            <label for="adminDescription" class="form-label">个人简介</label>
                                            <textarea class="form-control" id="adminDescription" rows="3" placeholder="请输入个人简介"></textarea>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                            <button type="button" class="btn btn-primary" onclick="saveAdminProfile()">保存修改</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // 移除已存在的模态框
        const existingModal = document.getElementById('adminProfileModal');
        if (existingModal) {
            existingModal.remove();
        }

        // 添加模态框到页面
        document.body.insertAdjacentHTML('beforeend', modalHtml);

        // 显示模态框
        const modal = new bootstrap.Modal(document.getElementById('adminProfileModal'));
        modal.show();
    }

    function changePassword() {
        // 创建修改密码模态框
        const modalHtml = `
            <div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-warning text-dark">
                            <h5 class="modal-title" id="changePasswordModalLabel">
                                <i class="fas fa-key me-2"></i>修改密码
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="changePasswordForm">
                                <div class="mb-3">
                                    <label for="currentPassword" class="form-label">当前密码</label>
                                    <input type="password" class="form-control" id="currentPassword" required>
                                </div>
                                <div class="mb-3">
                                    <label for="newPassword" class="form-label">新密码</label>
                                    <input type="password" class="form-control" id="newPassword" required>
                                    <div class="form-text">密码长度至少6位，建议包含字母和数字</div>
                                </div>
                                <div class="mb-3">
                                    <label for="confirmPassword" class="form-label">确认新密码</label>
                                    <input type="password" class="form-control" id="confirmPassword" required>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                            <button type="button" class="btn btn-warning" onclick="submitPasswordChange()">确认修改</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // 移除已存在的模态框
        const existingModal = document.getElementById('changePasswordModal');
        if (existingModal) {
            existingModal.remove();
        }

        // 添加模态框到页面
        document.body.insertAdjacentHTML('beforeend', modalHtml);

        // 显示模态框
        const modal = new bootstrap.Modal(document.getElementById('changePasswordModal'));
        modal.show();
    }

    function saveAdminProfile() {
        // 这里可以添加保存管理员资料的逻辑
        alert('管理员资料保存成功！');
        const modal = bootstrap.Modal.getInstance(document.getElementById('adminProfileModal'));
        modal.hide();
    }

    function submitPasswordChange() {
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (!currentPassword || !newPassword || !confirmPassword) {
            alert('请填写所有密码字段！');
            return;
        }

        if (newPassword !== confirmPassword) {
            alert('新密码和确认密码不匹配！');
            return;
        }

        if (newPassword.length < 6) {
            alert('新密码长度至少6位！');
            return;
        }

        // 这里可以添加实际的密码修改逻辑
        alert('密码修改成功！');
        const modal = bootstrap.Modal.getInstance(document.getElementById('changePasswordModal'));
        modal.hide();
    }
</script>

{% block extra_js %}{% endblock %}
</body>
</html>