{% extends "base_old.html" %}

{% block title %}äº”æ¥¼ç®¡ç† - æ”¶è´¹è®°å½• - ç§Ÿæˆ¿ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block page_title %}äº”æ¥¼ç®¡ç† - æ”¶è´¹è®°å½•{% endblock %}

{% block breadcrumb %}
    <div class="breadcrumb-container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index5') }}"><i class="fas fa-home"></i> ä¸»é¡µ</a></li>
                <li class="breadcrumb-item active">æ”¶è´¹è®°å½•</li>
            </ol>
        </nav>
    </div>
{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/record.css') }}">
{% endblock %}

{% block content %}
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="records-header-enhanced" data-aos="fade-down">
        <div class="header-content">
            <div class="header-icon-wrapper">
                <i class="fas fa-receipt header-main-icon"></i>
            </div>
            <div class="header-text">
                <h1 class="header-title">
                    <span class="title-gradient">æ”¶è´¹è®°å½•ç®¡ç†</span>
                    <div class="title-underline"></div>
                </h1>
                <p class="header-subtitle">
                    <i class="fas fa-money-bill-wave me-2"></i>
                    äº”æ¥¼æ‰€æœ‰æˆ¿é—´çš„ç¼´è´¹è®°å½•å’Œæ”¶å…¥ç»Ÿè®¡
                </p>
            </div>
        </div>
        <div class="header-decoration">
            <div class="decoration-circle circle-1"></div>
            <div class="decoration-circle circle-2"></div>
            <div class="decoration-circle circle-3"></div>
        </div>
    </div>

    <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
    <div class="row mb-4" data-aos="fade-up" data-aos-delay="100">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card-enhanced" data-aos="zoom-in" data-aos-delay="200">
                <div class="stats-value">{{ rental_records_list|length }}</div>
                <div class="stats-label">æ€»ç¼´è´¹è®°å½•</div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card-enhanced" data-aos="zoom-in" data-aos-delay="300">
                <div class="stats-value">
                    Â¥{{ "%.0f"|format(rental_records_list|sum(attribute='total_rent')|float) }}</div>
                <div class="stats-label">æ€»æ”¶è´¹é‡‘é¢</div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card-enhanced" data-aos="zoom-in" data-aos-delay="400">
                <div class="stats-value">{{ rental_records_list|map(attribute='room_number')|unique|list|length }}</div>
                <div class="stats-label">æ¶‰åŠæˆ¿é—´æ•°</div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card-enhanced" data-aos="zoom-in" data-aos-delay="500">
                <div class="stats-value">
                    Â¥{{ "%.0f"|format((rental_records_list|sum(attribute='total_rent')|float / rental_records_list|length) if rental_records_list|length > 0 else 0) }}</div>
                <div class="stats-label">å¹³å‡ç¼´è´¹é‡‘é¢</div>
            </div>
        </div>
    </div>

    <!-- æœç´¢å’Œç­›é€‰åŒºåŸŸ -->
    <div class="search-filter-section" data-aos="fade-up" data-aos-delay="200">
        <div class="search-filter-header">
            <h3 class="search-filter-title">
                <i class="fas fa-search me-2"></i>
                æœç´¢ä¸ç­›é€‰
            </h3>
            <p class="search-filter-subtitle">å¿«é€ŸæŸ¥æ‰¾ç‰¹å®šçš„ç¼´è´¹è®°å½•</p>
        </div>

        <div class="search-filter-controls">
            <div class="row align-items-end mb-3">
                <!-- æˆ¿å·æœç´¢ -->
                <div class="col-lg-4 col-md-6 mb-3">
                    <label class="form-label search-label">
                        <i class="fas fa-door-closed me-1"></i>
                        æˆ¿å·æœç´¢
                    </label>
                    <div class="search-input-wrapper">
                        <div class="search-icon">
                            <i class="fas fa-search"></i>
                        </div>
                        <input type="text" class="form-control search-input"
                               placeholder="è¾“å…¥æˆ¿å·æœç´¢..."
                               id="roomSearchInput">
                        <div class="search-clear" id="roomSearchClear" style="display: none;">
                            <i class="fas fa-times"></i>
                        </div>
                    </div>
                </div>

                <!-- ç§Ÿå®¢æœç´¢ -->
                <div class="col-lg-4 col-md-6 mb-3">
                    <label class="form-label search-label">
                        <i class="fas fa-user me-1"></i>
                        ç§Ÿå®¢æœç´¢
                    </label>
                    <div class="search-input-wrapper">
                        <div class="search-icon">
                            <i class="fas fa-search"></i>
                        </div>
                        <input type="text" class="form-control search-input"
                               placeholder="è¾“å…¥ç§Ÿå®¢å§“åæœç´¢..."
                               id="tenantSearchInput">
                        <div class="search-clear" id="tenantSearchClear" style="display: none;">
                            <i class="fas fa-times"></i>
                        </div>
                    </div>
                </div>

                <!-- æ“ä½œæŒ‰é’® -->
                <div class="col-lg-4 col-md-12 mb-3">
                    <div class="action-buttons">
                        <button class="btn btn-clear" onclick="clearAllFilters()">
                            <i class="fas fa-eraser me-2"></i>
                            æ¸…é™¤ç­›é€‰
                        </button>
                        <button class="btn btn-export" onclick="exportRecords()">
                            <i class="fas fa-file-excel me-2"></i>
                            å¯¼å‡ºè®°å½•
                        </button>
                        <button class="btn btn-danger" id="batchDeleteBtn" onclick="batchDeleteRecords()"
                                style="display: none;">
                            <i class="fas fa-trash me-2"></i>
                            æ‰¹é‡åˆ é™¤
                        </button>
                    </div>
                </div>
            </div>

            <!-- æ—¥æœŸç­›é€‰ -->
            <div class="date-filter-section">
                <div class="row align-items-end">
                    <div class="col-lg-3 col-md-6 mb-3">
                        <label class="form-label search-label">
                            <i class="fas fa-calendar-alt me-1"></i>
                            æŸ¥è¯¢æ—¥æœŸ
                        </label>
                        <input type="date" class="form-control date-input" id="queryDate">
                    </div>
                </div>
            </div>

            <!-- ç­›é€‰ç»“æœæ˜¾ç¤º -->
            <div class="filter-result">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="result-info">
                            <i class="fas fa-info-circle me-2"></i>
                            æ˜¾ç¤º <strong id="filteredCount">{{ rental_records_list|length }}</strong> æ¡è®°å½•ï¼Œ
                            å…± <strong>{{ rental_records_list|length }}</strong> æ¡è®°å½•
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="filter-tags" id="filterTags"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¼´è´¹è®°å½•è¡¨æ ¼ -->
    <div class="table-enhanced" data-aos="fade-up" data-aos-delay="300">
        {% if rental_records_list %}
            <div class="table-header-enhanced">
                <h3 class="table-title-enhanced">
                    <i class="fas fa-list me-2"></i>
                    ç¼´è´¹è®°å½•è¯¦è§ˆ (å…± {{ rental_records_list|length }} æ¡è®°å½•)
                </h3>
            </div>

            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                    <tr>
                        <th>
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                            <label for="selectAll" class="ms-2">å…¨é€‰</label>
                        </th>
                        <th>åºå·</th>
                        <th>æˆ¿é—´å·</th>
                        <th>ç§Ÿå®¢å§“å</th>
                        <th>ç¼´è´¹é‡‘é¢</th>
                        <th>ç¼´è´¹æ—¥æœŸ</th>
                        <th>è®°å½•æ—¶é—´</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for record in rental_records_list %}
                        <tr class="record-row"
                            data-room="{{ record.room_number }}"
                            data-tenant="{{ record.tenant_name }}"
                            data-payment-date="{{ record.payment_date.strftime('%Y-%m-%d') if record.payment_date else '' }}"
                            data-created-date="{{ record.created_at.strftime('%Y-%m-%d') if record.created_at else '' }}"
                            data-record-id="{{ record.id }}"
                            data-aos="fade-up" data-aos-delay="{{ 400 + loop.index0 * 50 }}">
                            <td>
                                <input type="checkbox" class="record-checkbox" value="{{ record.id }}"
                                       onchange="updateBatchDeleteButton()">
                            </td>
                            <td><strong class="row-index">{{ loop.index }}</strong></td>
                            <td>
                                <div class="room-badge-enhanced">
                                    <i class="fas fa-door-closed"></i>
                                    {{ record.room_number }}
                                </div>
                            </td>
                            <td>
                                <i class="fas fa-user me-2"></i>
                                {{ record.tenant_name }}
                            </td>
                            <td>
                                <div class="amount-enhanced">
                                    <i class="fas fa-money-bill-wave me-1"></i>
                                    Â¥{{ "%.2f"|format(record.total_rent|float) }}
                                </div>
                            </td>
                            <td>
                                {% if record.payment_date %}
                                    <div class="date-enhanced">
                                        <i class="fas fa-calendar-check me-1"></i>
                                        {{ record.payment_date.strftime('%Y-%m-%d') }}
                                    </div>
                                {% else %}
                                    <span class="text-muted">
                                        <i class="fas fa-calendar-times me-1"></i>
                                        æœªè®¾ç½®
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                {% if record.created_at %}
                                    <div class="date-enhanced">
                                        <i class="fas fa-clock me-1"></i>
                                        {{ record.created_at.strftime('%Y-%m-%d %H:%M') }}
                                    </div>
                                {% else %}
                                    <span class="text-muted">æœªçŸ¥</span>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- åˆ†é¡µå¯¼èˆª -->
            <div class="pagination-container" id="paginationContainer">
                <nav aria-label="åˆ†é¡µå¯¼èˆª">
                    <ul class="pagination justify-content-center" id="pagination">
                        <!-- åˆ†é¡µæŒ‰é’®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </ul>
                </nav>
                <div class="pagination-info text-center mt-3">
                    <span id="paginationInfo">æ˜¾ç¤ºç¬¬ 1-10 æ¡ï¼Œå…± {{ rental_records_list|length }} æ¡è®°å½•</span>
                </div>
            </div>
        {% else %}
            <div class="empty-state" data-aos="fade-up" data-aos-delay="300">
                <div class="empty-icon">
                    <i class="fas fa-receipt"></i>
                </div>
                <h3>æš‚æ— ç¼´è´¹è®°å½•</h3>
                <p>è¿˜æ²¡æœ‰ä»»ä½•ç¼´è´¹è®°å½•ï¼Œå¼€å§‹æ·»åŠ ç¬¬ä¸€æ¡ç¼´è´¹è®°å½•å§ï¼</p>
            </div>
        {% endif %}
    </div>
{% endblock %}

{% block extra_js %}
    <!-- AOSåŠ¨ç”»åº“ -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        // åˆå§‹åŒ–AOSåŠ¨ç”»
        AOS.init({
            duration: 800,
            easing: 'ease-in-out',
            once: true,
            offset: 100
        });

        // æ•°å­—åŠ¨ç”»æ•ˆæœ
        document.addEventListener('DOMContentLoaded', function () {
            setTimeout(() => {
                const numberElements = document.querySelectorAll('.stats-value');
                numberElements.forEach(element => {
                    const text = element.textContent;
                    const number = parseFloat(text.replace(/[^0-9.]/g, ''));
                    if (!isNaN(number) && number > 0) {
                        let current = 0;
                        const increment = number / 50;
                        const timer = setInterval(() => {
                            current += increment;
                            if (current >= number) {
                                current = number;
                                clearInterval(timer);
                            }
                            if (text.includes('Â¥')) {
                                element.textContent = 'Â¥' + Math.floor(current);
                            } else {
                                element.textContent = Math.floor(current);
                            }
                        }, 30);
                    }
                });
            }, 500);

            // åˆå§‹åŒ–æœç´¢å’Œç­›é€‰åŠŸèƒ½
            initSearchAndFilter();
        });

        // åˆ†é¡µç›¸å…³å˜é‡
        let currentPage = 1;
        let recordsPerPage = 10;
        let filteredRecords = [];
        let allRecords = [];

        // æœç´¢å’Œç­›é€‰åŠŸèƒ½
        function initSearchAndFilter() {
            const roomSearchInput = document.getElementById('roomSearchInput');
            const tenantSearchInput = document.getElementById('tenantSearchInput');
            const roomSearchClear = document.getElementById('roomSearchClear');
            const tenantSearchClear = document.getElementById('tenantSearchClear');
            const queryDate = document.getElementById('queryDate');

            // åˆå§‹åŒ–è®°å½•æ•°ç»„
            allRecords = Array.from(document.querySelectorAll('.record-row'));
            filteredRecords = [...allRecords];

            // åˆå§‹åŒ–åˆ†é¡µ
            initPagination();

            // æˆ¿å·æœç´¢
            if (roomSearchInput && roomSearchClear) {
                roomSearchInput.addEventListener('input', function () {
                    const value = this.value.trim();
                    roomSearchClear.style.display = value ? 'block' : 'none';
                    applyFilters();
                });

                roomSearchClear.addEventListener('click', function () {
                    roomSearchInput.value = '';
                    this.style.display = 'none';
                    applyFilters();
                    roomSearchInput.focus();
                });
            }

            // ç§Ÿå®¢æœç´¢
            if (tenantSearchInput && tenantSearchClear) {
                tenantSearchInput.addEventListener('input', function () {
                    const value = this.value.trim();
                    tenantSearchClear.style.display = value ? 'block' : 'none';
                    applyFilters();
                });

                tenantSearchClear.addEventListener('click', function () {
                    tenantSearchInput.value = '';
                    this.style.display = 'none';
                    applyFilters();
                    tenantSearchInput.focus();
                });
            }

            // æ—¥æœŸç­›é€‰
            if (queryDate) {
                queryDate.addEventListener('change', applyFilters);
            }

            // é”®ç›˜å¿«æ·é”®
            document.addEventListener('keydown', function (e) {
                if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                    e.preventDefault();
                    roomSearchInput.focus();
                    roomSearchInput.select();
                }
                if (e.key === 'Escape') {
                    clearAllFilters();
                }
            });

            console.log('ğŸ’¡ å¿«æ·é”®æç¤º: Ctrl+Fèšç„¦æœç´¢, ESCæ¸…é™¤æ‰€æœ‰ç­›é€‰');
        }

        // åº”ç”¨ç­›é€‰
        function applyFilters() {
            const roomSearch = document.getElementById('roomSearchInput').value.toLowerCase().trim();
            const tenantSearch = document.getElementById('tenantSearchInput').value.toLowerCase().trim();
            const queryDate = document.getElementById('queryDate').value;

            // ç­›é€‰è®°å½•
            filteredRecords = allRecords.filter(row => {
                const roomNumber = row.getAttribute('data-room').toLowerCase();
                const tenantName = row.getAttribute('data-tenant').toLowerCase();
                const paymentDate = row.getAttribute('data-payment-date');
                const createdDate = row.getAttribute('data-created-date');

                // æˆ¿å·æœç´¢
                if (roomSearch && !roomNumber.includes(roomSearch)) {
                    return false;
                }

                // ç§Ÿå®¢æœç´¢
                if (tenantSearch && !tenantName.includes(tenantSearch)) {
                    return false;
                }

                // æ—¥æœŸç­›é€‰ï¼ˆåŒæ—¶åŒ¹é…ç¼´è´¹æ—¥æœŸå’Œè®°å½•æ—¥æœŸï¼‰
                if (queryDate) {
                    const matchPaymentDate = paymentDate && paymentDate === queryDate;
                    const matchCreatedDate = createdDate && createdDate === queryDate;
                    if (!matchPaymentDate && !matchCreatedDate) {
                        return false;
                    }
                }

                return true;
            });

            // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
            currentPage = 1;

            // æ›´æ–°åˆ†é¡µå’Œæ˜¾ç¤º
            updatePagination();
            displayCurrentPage();

            // æ›´æ–°è®¡æ•°
            updateFilteredCount(filteredRecords.length);

            // æ›´æ–°ç­›é€‰æ ‡ç­¾
            updateFilterTags();
        }

        // æ›´æ–°ç­›é€‰è®¡æ•°
        function updateFilteredCount(count) {
            const filteredCountElement = document.getElementById('filteredCount');
            if (filteredCountElement) {
                filteredCountElement.textContent = count;

                // æ·»åŠ åŠ¨ç”»æ•ˆæœ
                filteredCountElement.style.transform = 'scale(1.1)';
                filteredCountElement.style.color = '#667eea';
                setTimeout(() => {
                    filteredCountElement.style.transform = 'scale(1)';
                    filteredCountElement.style.color = '';
                }, 200);
            }
        }

        // æ›´æ–°ç­›é€‰æ ‡ç­¾
        function updateFilterTags() {
            const filterTags = document.getElementById('filterTags');
            if (!filterTags) return;

            const roomSearch = document.getElementById('roomSearchInput').value.trim();
            const tenantSearch = document.getElementById('tenantSearchInput').value.trim();
            const queryDate = document.getElementById('queryDate').value;

            let tags = [];

            if (roomSearch) {
                tags.push({type: 'room', label: `æˆ¿å·: ${roomSearch}`, value: roomSearch});
            }
            if (tenantSearch) {
                tags.push({type: 'tenant', label: `ç§Ÿå®¢: ${tenantSearch}`, value: tenantSearch});
            }
            if (queryDate) {
                tags.push({type: 'queryDate', label: `æŸ¥è¯¢æ—¥æœŸ: ${queryDate}`, value: queryDate});
            }

            filterTags.innerHTML = tags.map(tag => `
                <span class="filter-tag">
                    ${tag.label}
                    <span class="remove-tag" onclick="removeFilterTag('${tag.type}')">
                        <i class="fas fa-times"></i>
                    </span>
                </span>
            `).join('');
        }

        // ç§»é™¤ç­›é€‰æ ‡ç­¾
        function removeFilterTag(type) {
            switch (type) {
                case 'room':
                    document.getElementById('roomSearchInput').value = '';
                    document.getElementById('roomSearchClear').style.display = 'none';
                    break;
                case 'tenant':
                    document.getElementById('tenantSearchInput').value = '';
                    document.getElementById('tenantSearchClear').style.display = 'none';
                    break;
                case 'queryDate':
                    document.getElementById('queryDate').value = '';
                    break;
            }
            applyFilters();
        }

        // åˆ†é¡µåŠŸèƒ½
        function initPagination() {
            updatePagination();
            displayCurrentPage();
        }

        function updatePagination() {
            const totalRecords = filteredRecords.length;
            const totalPages = Math.ceil(totalRecords / recordsPerPage);
            const pagination = document.getElementById('pagination');

            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let paginationHTML = '';

            // ä¸Šä¸€é¡µæŒ‰é’®
            paginationHTML += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
            `;

            // é¡µç æŒ‰é’®
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, currentPage + 2);

            if (startPage > 1) {
                paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(1)">1</a></li>`;
                if (startPage > 2) {
                    paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                    </li>
                `;
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
                paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${totalPages})">${totalPages}</a></li>`;
            }

            // ä¸‹ä¸€é¡µæŒ‰é’®
            paginationHTML += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            `;

            pagination.innerHTML = paginationHTML;
            updatePaginationInfo();
        }

        function changePage(page) {
            const totalPages = Math.ceil(filteredRecords.length / recordsPerPage);
            if (page < 1 || page > totalPages) return;

            currentPage = page;
            updatePagination();
            displayCurrentPage();
        }

        function displayCurrentPage() {
            // éšè—æ‰€æœ‰è®°å½•
            allRecords.forEach(row => {
                row.style.display = 'none';
                row.classList.add('hidden');
            });

            // è®¡ç®—å½“å‰é¡µçš„è®°å½•èŒƒå›´
            const startIndex = (currentPage - 1) * recordsPerPage;
            const endIndex = startIndex + recordsPerPage;
            const currentPageRecords = filteredRecords.slice(startIndex, endIndex);

            // æ˜¾ç¤ºå½“å‰é¡µçš„è®°å½•å¹¶æ›´æ–°åºå·
            currentPageRecords.forEach((row, index) => {
                row.style.display = '';
                row.classList.remove('hidden');

                // æ›´æ–°åºå·
                const indexCell = row.querySelector('.row-index');
                if (indexCell) {
                    indexCell.textContent = startIndex + index + 1;
                }
            });
        }

        function updatePaginationInfo() {
            const totalRecords = filteredRecords.length;
            const startRecord = totalRecords === 0 ? 0 : (currentPage - 1) * recordsPerPage + 1;
            const endRecord = Math.min(currentPage * recordsPerPage, totalRecords);

            const paginationInfo = document.getElementById('paginationInfo');
            if (paginationInfo) {
                paginationInfo.textContent = `æ˜¾ç¤ºç¬¬ ${startRecord}-${endRecord} æ¡ï¼Œå…± ${totalRecords} æ¡è®°å½•`;
            }
        }

        // æ¸…é™¤æ‰€æœ‰ç­›é€‰
        function clearAllFilters() {
            document.getElementById('roomSearchInput').value = '';
            document.getElementById('tenantSearchInput').value = '';
            document.getElementById('queryDate').value = '';

            document.getElementById('roomSearchClear').style.display = 'none';
            document.getElementById('tenantSearchClear').style.display = 'none';

            applyFilters();

            // æ˜¾ç¤ºæ¸…é™¤æˆåŠŸæç¤º
            showNotification('å·²æ¸…é™¤æ‰€æœ‰ç­›é€‰æ¡ä»¶', 'success');
        }

        // å¯¼å‡ºè®°å½•
        function exportRecords() {
            // è·å–å¯è§çš„è®°å½•
            const visibleRows = document.querySelectorAll('.record-row:not(.hidden)');
            const data = [];

            // è¡¨å¤´
            data.push(['åºå·', 'æˆ¿é—´å·', 'ç§Ÿå®¢å§“å', 'ç¼´è´¹é‡‘é¢', 'ç¼´è´¹æ—¥æœŸ', 'è®°å½•æ—¶é—´']);

            // æ•°æ®è¡Œ
            visibleRows.forEach((row, index) => {
                const cells = row.querySelectorAll('td');
                const rowData = [
                    index + 1,
                    row.getAttribute('data-room'),
                    row.getAttribute('data-tenant'),
                    cells[3].textContent.trim(),
                    row.getAttribute('data-payment-date') || 'æœªè®¾ç½®',
                    row.getAttribute('data-created-date') || 'æœªçŸ¥'
                ];
                data.push(rowData);
            });

            // è½¬æ¢ä¸ºCSV
            const csvContent = data.map(row =>
                row.map(cell => `"${cell}"`).join(',')
            ).join('\n');

            // ä¸‹è½½æ–‡ä»¶
            const blob = new Blob(['\uFEFF' + csvContent], {type: 'text/csv;charset=utf-8;'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ç¼´è´¹è®°å½•_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();

            showNotification(`å·²å¯¼å‡º ${visibleRows.length} æ¡è®°å½•`, 'success');
        }

        // æ‰¹é‡åˆ é™¤åŠŸèƒ½
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.record-checkbox:not([style*="display: none"])');

            checkboxes.forEach(checkbox => {
                if (checkbox.closest('.record-row').style.display !== 'none') {
                    checkbox.checked = selectAll.checked;
                }
            });

            updateBatchDeleteButton();
        }

        function updateBatchDeleteButton() {
            const checkboxes = document.querySelectorAll('.record-checkbox:checked');
            const visibleCheckedBoxes = Array.from(checkboxes).filter(cb =>
                cb.closest('.record-row').style.display !== 'none'
            );
            const batchDeleteBtn = document.getElementById('batchDeleteBtn');
            const selectAll = document.getElementById('selectAll');

            if (visibleCheckedBoxes.length > 0) {
                batchDeleteBtn.style.display = 'inline-block';
                batchDeleteBtn.innerHTML = `
                    <i class="fas fa-trash me-2"></i>
                    æ‰¹é‡åˆ é™¤ (${visibleCheckedBoxes.length})
                `;
            } else {
                batchDeleteBtn.style.display = 'none';
            }

            // æ›´æ–°å…¨é€‰çŠ¶æ€
            const visibleCheckboxes = document.querySelectorAll('.record-checkbox');
            const visibleCheckboxesArray = Array.from(visibleCheckboxes).filter(cb =>
                cb.closest('.record-row').style.display !== 'none'
            );
            const checkedVisibleBoxes = visibleCheckboxesArray.filter(cb => cb.checked);

            if (visibleCheckboxesArray.length === 0) {
                selectAll.indeterminate = false;
                selectAll.checked = false;
            } else if (checkedVisibleBoxes.length === visibleCheckboxesArray.length) {
                selectAll.indeterminate = false;
                selectAll.checked = true;
            } else if (checkedVisibleBoxes.length > 0) {
                selectAll.indeterminate = true;
                selectAll.checked = false;
            } else {
                selectAll.indeterminate = false;
                selectAll.checked = false;
            }
        }

        function batchDeleteRecords() {
            const checkboxes = document.querySelectorAll('.record-checkbox:checked');
            const selectedIds = Array.from(checkboxes)
                .filter(cb => cb.closest('.record-row').style.display !== 'none')
                .map(cb => cb.value);

            if (selectedIds.length === 0) {
                showNotification('è¯·é€‰æ‹©è¦åˆ é™¤çš„è®°å½•', 'warning');
                return;
            }

            if (confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedIds.length} æ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                // è¿™é‡Œåº”è¯¥å‘é€AJAXè¯·æ±‚åˆ°åç«¯åˆ é™¤è®°å½•
                // ç”±äºè¿™æ˜¯å‰ç«¯æ¼”ç¤ºï¼Œæˆ‘ä»¬åªæ˜¯ä»DOMä¸­ç§»é™¤è¿™äº›è®°å½•
                selectedIds.forEach(id => {
                    const row = document.querySelector(`[data-record-id="${id}"]`);
                    if (row) {
                        // ä»allRecordsæ•°ç»„ä¸­ç§»é™¤
                        const index = allRecords.indexOf(row);
                        if (index > -1) {
                            allRecords.splice(index, 1);
                        }
                        // ä»DOMä¸­ç§»é™¤
                        row.remove();
                    }
                });

                // é‡æ–°åº”ç”¨ç­›é€‰å’Œåˆ†é¡µ
                applyFilters();

                // é‡ç½®é€‰æ‹©çŠ¶æ€
                document.getElementById('selectAll').checked = false;
                updateBatchDeleteButton();

                showNotification(`å·²æˆåŠŸåˆ é™¤ ${selectedIds.length} æ¡è®°å½•`, 'success');

                // æ³¨æ„ï¼šåœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥å‘é€AJAXè¯·æ±‚åˆ°åç«¯
                // fetch('/delete_records', {
                //     method: 'POST',
                //     headers: {
                //         'Content-Type': 'application/json',
                //     },
                //     body: JSON.stringify({ids: selectedIds})
                // }).then(response => {
                //     if (response.ok) {
                //         // åˆ é™¤æˆåŠŸåçš„å¤„ç†
                //     }
                // });
            }
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;

            let icon = 'info-circle';
            let background = 'linear-gradient(135deg, #17a2b8, #138496)';

            switch (type) {
                case 'success':
                    icon = 'check-circle';
                    background = 'linear-gradient(135deg, #28a745, #20c997)';
                    break;
                case 'warning':
                    icon = 'exclamation-triangle';
                    background = 'linear-gradient(135deg, #ffc107, #e0a800)';
                    break;
                case 'error':
                    icon = 'times-circle';
                    background = 'linear-gradient(135deg, #dc3545, #c82333)';
                    break;
            }

            notification.innerHTML = `
                <i class="fas fa-${icon} me-2"></i>
                ${message}
            `;

            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${background};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 15px;
                box-shadow: 0 8px 25px rgba(0,0,0,0.2);
                z-index: 9999;
                font-weight: 600;
                animation: slideInRight 0.3s ease;
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease forwards';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
    </script>
{% endblock %}