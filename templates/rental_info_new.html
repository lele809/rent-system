{% extends "base_new.html" %}

{% block title %}ÂÖ≠Ê•ºÁÆ°ÁêÜ - ÁßüÊàø‰ø°ÊÅØ - ÁßüÊàøÁÆ°ÁêÜÁ≥ªÁªü{% endblock %}

{% block page_title %}ÂÖ≠Ê•ºÁÆ°ÁêÜ - ÁßüÊàø‰ø°ÊÅØ{% endblock %}

{% block breadcrumb %}
    <div class="breadcrumb-container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index6') }}"><i class="fas fa-home"></i> ‰∏ªÈ°µ</a></li>
                <li class="breadcrumb-item active">ÁßüÊàø‰ø°ÊÅØ</li>
            </ol>
        </nav>
    </div>
{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/rental.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/info.css') }}">
{% endblock %}

{% block content %}
    <!-- ÂÖ®Â±ÄÂä†ËΩΩÂä®ÁîªË¶ÜÁõñÂ±Ç -->
    <div class="loading-overlay" id="globalLoadingOverlay">
        <div class="loading-spinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Âä†ËΩΩ‰∏≠ÔºåËØ∑Á®çÂÄô...</p>
        </div>
    </div>

    <!-- È°µÈù¢Â§¥ÈÉ® -->
    <div class="rental-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h2><i class="fas fa-info-circle me-3"></i> ÁßüÊàø‰ø°ÊÅØ</h2>
                <p><i class="fas fa-info-circle me-2"></i>Êü•ÁúãÂÖ≠Ê•ºÊâÄÊúâÊàøÈó¥ÁöÑÁßüËµÅËØ¶ÁªÜ‰ø°ÊÅØ</p>
            </div>
            <div class="col-md-4 text-md-end">
                <div class="header-stats">
                    <div class="stat-item">
                        <i class="fas fa-calendar-alt"></i>
                        <span>{{ moment().format('YYYYÂπ¥MMÊúàDDÊó•') if moment else '‰ªäÊó•' }}</span>
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-clock"></i>
                        <span class="current-time" id="currentTime"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ÁªüËÆ°‰ø°ÊÅØ -->
    <div class="row stats-row animate-fade-in">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card animate-scale-in" style="animation-delay: 0.1s;">
                <div class="stats-icon total">
                    <i class="fas fa-home"></i>
                </div>
                <div class="stats-content">
                    <h3>{{ rental_info_list|length }}</h3>
                    <p>ÊÄªÁßüÊàøÊï∞</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card animate-scale-in" style="animation-delay: 0.2s;">
                <div class="stats-icon paid">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stats-content">
                    <h3>{{ rental_info_list|selectattr('rental_status', 'equalto', 1)|list|length }}</h3>
                    <p>Â∑≤Áº¥Ë¥π</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card animate-scale-in" style="animation-delay: 0.3s;">
                <div class="stats-icon unpaid">
                    <i class="fas fa-times-circle"></i>
                </div>
                <div class="stats-content">
                    <h3>{{ rental_info_list|selectattr('rental_status', 'equalto', 2)|list|length }}</h3>
                    <p>Êú™Áº¥Ë¥π</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card animate-scale-in" style="animation-delay: 0.4s;">
                <div class="stats-icon deposit">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                <div class="stats-content">
                    <h3>¬•{{ "%.2f"|format(rental_info_list|sum(attribute='deposit')|float) }}</h3>
                    <p>ÊÄªÊäºÈáë</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Êìç‰ΩúÊ†è -->
    <div class="row mb-4 animate-slide-up">
        <div class="col-lg-6 col-md-12 mb-3 mb-lg-0">
            <div class="search-container">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="ÊêúÁ¥¢ÊàøÂè∑„ÄÅÁßüÂÆ¢ÂßìÂêçÊàñÁîµËØù..."
                           class="form-control search-input">
                    <button class="btn btn-clear" id="clearSearch" title="Ê∏ÖÈô§ÊêúÁ¥¢">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="search-suggestions" id="searchSuggestions" style="display: none;">
                    <!-- ÊêúÁ¥¢Âª∫ËÆÆÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÊ∑ªÂä† -->
                </div>
            </div>
        </div>
        <div class="col-lg-6 col-md-12">
            <div class="action-buttons d-flex flex-wrap gap-2 justify-content-end">
                <div class="btn-group" role="group">
                    <button class="btn export-btn" onclick="exportRentalInfo('all')" title="ÂØºÂá∫ÊâÄÊúâÁßüÊàø‰ø°ÊÅØ">
                        <i class="fas fa-file-excel me-1"></i> ÂØºÂá∫‰ø°ÊÅØ
                    </button>
                    <button type="button" class="btn export-btn dropdown-toggle dropdown-toggle-split"
                            data-bs-toggle="dropdown" aria-expanded="false">
                        <span class="visually-hidden">Êõ¥Â§öÈÄâÈ°π</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" onclick="exportRentalInfo('paid')">
                            <i class="fas fa-check text-success me-2"></i> ÂØºÂá∫Â∑≤Áº¥Ë¥π‰ø°ÊÅØ</a></li>
                        <li><a class="dropdown-item" href="#" onclick="exportRentalInfo('unpaid')">
                            <i class="fas fa-times text-danger me-2"></i> ÂØºÂá∫Êú™Áº¥Ë¥π‰ø°ÊÅØ</a></li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li><a class="dropdown-item" href="#" onclick="showRentalInfoSummary()">
                            <i class="fas fa-chart-bar text-primary me-2"></i> ÁßüÊàø‰ø°ÊÅØÊ±áÊÄª</a></li>
                    </ul>
                </div>
                <button class="btn add-rental-btn" onclick="addRentalInfo()">
                    <i class="fas fa-plus me-1"></i> Ê∑ªÂä†ÁßüÊàø‰ø°ÊÅØ
                </button>
            </div>
        </div>
    </div>

    <!-- Á≠õÈÄâÊåâÈíÆ -->
    <div class="filter-buttons mt-3 animate-fade-in">
        <button class="btn filter-btn active" data-filter="all">
            <i class="fas fa-list"></i> ÂÖ®ÈÉ®
        </button>
        <button class="btn filter-btn" data-filter="paid">
            <i class="fas fa-check-circle"></i> Â∑≤Áº¥Ë¥π
        </button>
        <button class="btn filter-btn" data-filter="unpaid">
            <i class="fas fa-exclamation-circle"></i> Êú™Áº¥Ë¥π
        </button>
    </div>

    <!-- ÁßüÊàø‰ø°ÊÅØË°®Ê†º -->
    <div class="table-responsive rental-info-table animate-fade-in" style="animation-delay: 0.3s;">
        <table class="table table-hover table-striped">
            <thead>
            <tr>
                <th>ÊàøÂè∑</th>
                <th>ÁßüÂÆ¢ÂßìÂêç</th>
                <th>ÁîµËØù</th>
                <th>ÊäºÈáë</th>
                <th>ÂÖ•‰Ωè‰∫∫Êï∞</th>
                <th>ÂÖ•‰ΩèÊó∂Èó¥</th>
                <th>Áº¥Ë¥πÁä∂ÊÄÅ</th>
                <th>Â§áÊ≥®</th>
                <th>Êìç‰Ωú</th>
            </tr>
            </thead>
            <tbody>
            {% for info in rental_info_list %}
                <tr data-rental-info-id="{{ info.id }}"
                    class="rental-info-row {% if info.rental_status == 2 %}unpaid-row{% endif %}">
                    <td>
                        <span class="room-badge">
                            <i class="fas fa-home me-1"></i> {{ info.room_number }}
                        </span>
                    </td>
                    <td>
                        <div class="tenant-info">
                            <i class="fas fa-user me-2"></i>
                            <span class="tenant-name">{{ info.tenant_name }}</span>
                        </div>
                    </td>
                    <td>
                        <div class="phone-info">
                            <i class="fas fa-phone me-2 text-muted"></i>
                            <span>{{ info.phone }}</span>
                        </div>
                    </td>
                    <td class="money-amount amount-positive">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-money-bill me-2 text-muted"></i>
                            <span>¬•{{ "%.2f"|format(info.deposit|float) }}</span>
                        </div>
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            <i class="fas fa-users me-2 text-muted"></i>
                            <span>{{ info.occupant_count }}</span>
                        </div>
                    </td>
                    <td>
                        {% if info.check_in_date %}
                            <span class="date-info">{{ info.check_in_date.strftime('%Y-%m-%d') }}</span>
                        {% else %}
                            <span class="text-muted">Êú™ÂÖ•‰Ωè</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if info.rental_status == 1 %}
                            <span class="payment-status status-paid">
                                <i class="fas fa-check-circle"></i> Â∑≤Áº¥Ë¥π
                            </span>
                        {% else %}
                            <span class="payment-status status-unpaid">
                                <i class="fas fa-exclamation-circle"></i> Êú™Áº¥Ë¥π
                            </span>
                        {% endif %}
                    </td>
                    <td>
                        {% if info.remarks %}
                            <span class="remarks-text" title="{{ info.remarks }}">{{ info.remarks }}</span>
                        {% else %}
                            <span class="text-muted">Êó†</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-action btn-view" onclick="viewRentalInfo({{ info.id }})"
                                    title="Êü•ÁúãËØ¶ÊÉÖ">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-action btn-edit" onclick="editRentalInfo({{ info.id }})"
                                    title="ÁºñËæë‰ø°ÊÅØ">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-action btn-delete" onclick="deleteRentalInfo({{ info.id }})"
                                    title="Âà†Èô§‰ø°ÊÅØ">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            {% else %}
                <tr>
                    <td colspan="9" class="text-center py-5">
                        <div class="empty-state animate-fade-in">
                            <i class="fas fa-info-circle fa-3x mb-3"></i>
                            <h5>ÊöÇÊó†ÁßüÊàø‰ø°ÊÅØ</h5>
                            <p class="text-muted">ÁÇπÂáª"Ê∑ªÂä†ÁßüÊàø‰ø°ÊÅØ"ÊåâÈíÆÂàõÂª∫Êñ∞ÁöÑÁßüÊàø‰ø°ÊÅØËÆ∞ÂΩï</p>
                            <button class="btn btn-primary mt-2" onclick="addRentalInfo()">
                                <i class="fas fa-plus me-1"></i> Ê∑ªÂä†ÁßüÊàø‰ø°ÊÅØ
                            </button>
                        </div>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Ê∑ªÂä†/ÁºñËæëÁßüÊàø‰ø°ÊÅØÊ®°ÊÄÅÊ°Ü -->
    <div class="modal fade animate-modal" id="rentalInfoModal" tabindex="-1" aria-labelledby="rentalInfoModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content animate-scale-in">
                <div class="modal-header bg-gradient-primary text-white">
                    <h5 class="modal-title" id="rentalInfoModalLabel">
                        <i class="fas fa-home me-2"></i>
                        <span id="rentalModalTitle">Ê∑ªÂä†ÁßüÊàø‰ø°ÊÅØ</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="rentalInfoForm" class="needs-validation" novalidate>
                        <input type="hidden" id="rentalInfoId" name="id">

                        <!-- Âü∫Êú¨‰ø°ÊÅØÂç°Áâá -->
                        <div class="form-section-card">
                            <div class="section-header">
                                <i class="fas fa-info-circle"></i>
                                <h6>Âü∫Êú¨‰ø°ÊÅØ</h6>
                            </div>
                            <div class="section-content">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="roomNumber" class="form-label">
                                            <i class="fas fa-door-open text-primary me-2"></i>ÊàøÂè∑
                                            <span class="text-danger">*</span>
                                        </label>
                                        <div class="input-group input-group-lg">
                                            <span class="input-group-text bg-light">
                                                <i class="fas fa-home text-primary"></i>
                                            </span>
                                            <select class="form-select form-select-lg" id="roomNumber" name="roomNumber"
                                                    required>
                                                <option value="">ËØ∑ÈÄâÊã©Á©∫Èó≤ÊàøÈó¥</option>
                                            </select>
                                            <div class="invalid-feedback">
                                                <i class="fas fa-exclamation-triangle me-1"></i>ËØ∑ÈÄâÊã©ÊàøÂè∑
                                            </div>
                                        </div>
                                        <div class="form-text text-muted mt-2">
                                            <i class="fas fa-info-circle me-1"></i>‰ªÖÊòæÁ§∫Á©∫Èó≤Áä∂ÊÄÅÁöÑÊàøÈó¥
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="tenantName" class="form-label">
                                            <i class="fas fa-user text-primary me-2"></i>ÁßüÂÆ¢ÂßìÂêç
                                            <span class="text-danger">*</span>
                                        </label>
                                        <div class="input-group input-group-lg">
                                            <span class="input-group-text bg-light">
                                                <i class="fas fa-user text-primary"></i>
                                            </span>
                                            <input type="text" class="form-control" id="tenantName" name="tenantName"
                                                   placeholder="ËØ∑ËæìÂÖ•ÁßüÂÆ¢ÂßìÂêç" required>
                                            <div class="invalid-feedback">
                                                <i class="fas fa-exclamation-triangle me-1"></i>ËØ∑ËæìÂÖ•ÁßüÂÆ¢ÂßìÂêç
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ËÅîÁ≥ª‰ø°ÊÅØÂç°Áâá -->
                        <div class="form-section-card">
                            <div class="section-header">
                                <i class="fas fa-phone"></i>
                                <h6>ËÅîÁ≥ª‰ø°ÊÅØ</h6>
                            </div>
                            <div class="section-content">
                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <label for="phone" class="form-label">
                                            <i class="fas fa-phone text-primary me-2"></i>ËÅîÁ≥ªÁîµËØù
                                            <span class="text-danger">*</span>
                                        </label>
                                        <div class="input-group input-group-lg">
                                            <span class="input-group-text bg-light">
                                                <i class="fas fa-phone text-primary"></i>
                                            </span>
                                            <input type="tel" class="form-control" id="phone" name="phone"
                                                   placeholder="ËØ∑ËæìÂÖ•ÊâãÊú∫Âè∑Á†Å" pattern="[0-9]{11}" required>
                                            <div class="invalid-feedback">
                                                <i class="fas fa-exclamation-triangle me-1"></i>ËØ∑ËæìÂÖ•Ê≠£Á°ÆÁöÑÊâãÊú∫Âè∑Á†Å
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Ë¥¢Âä°‰ø°ÊÅØÂç°Áâá -->
                        <div class="form-section-card">
                            <div class="section-header">
                                <i class="fas fa-money-bill-wave"></i>
                                <h6>Ë¥¢Âä°‰ø°ÊÅØ</h6>
                            </div>
                            <div class="section-content">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="deposit" class="form-label">
                                            <i class="fas fa-coins text-success me-2"></i>ÊäºÈáëÈáëÈ¢ù
                                            <span class="text-danger">*</span>
                                        </label>
                                        <div class="input-group input-group-lg">
                                            <span class="input-group-text bg-light text-success fw-bold">¬•</span>
                                            <input type="number" class="form-control text-success fw-bold"
                                                   id="deposit" name="deposit" min="0" step="100"
                                                   value="200" placeholder="200.00" required>
                                            <div class="invalid-feedback">
                                                <i class="fas fa-exclamation-triangle me-1"></i>ËØ∑ËæìÂÖ•ÊäºÈáëÈáëÈ¢ù
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="rentalStatus" class="form-label">
                                            <i class="fas fa-check-circle text-info me-2"></i>Áº¥Ë¥πÁä∂ÊÄÅ
                                            <span class="text-danger">*</span>
                                        </label>
                                        <div class="input-group input-group-lg">
                                            <span class="input-group-text bg-light">
                                                <i class="fas fa-info-circle text-info"></i>
                                            </span>
                                            <select class="form-select" id="rentalStatus" required>
                                                <option value="">ÈÄâÊã©Áº¥Ë¥πÁä∂ÊÄÅ</option>
                                                <option value="1" class="text-success">
                                                    <i class="fas fa-check-circle"></i> Â∑≤Áº¥Ë¥π
                                                </option>
                                                <option value="2" class="text-danger">
                                                    <i class="fas fa-exclamation-circle"></i> Êú™Áº¥Ë¥π
                                                </option>
                                            </select>
                                            <div class="invalid-feedback">
                                                <i class="fas fa-exclamation-triangle me-1"></i>ËØ∑ÈÄâÊã©Áº¥Ë¥πÁä∂ÊÄÅ
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ÂÖ•‰Ωè‰ø°ÊÅØÂç°Áâá -->
                        <div class="form-section-card">
                            <div class="section-header">
                                <i class="fas fa-users"></i>
                                <h6>ÂÖ•‰Ωè‰ø°ÊÅØ</h6>
                            </div>
                            <div class="section-content">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="occupantCount" class="form-label">
                                            <i class="fas fa-user-friends text-primary me-2"></i>ÂÖ•‰Ωè‰∫∫Êï∞
                                            <span class="text-danger">*</span>
                                        </label>
                                        <div class="input-group input-group-lg">
                                            <span class="input-group-text bg-light">
                                                <i class="fas fa-users text-primary"></i>
                                            </span>
                                            <input type="number" class="form-control" id="occupantCount"
                                                   name="occupantCount" min="1" max="10" placeholder="1" required>
                                            <span class="input-group-text">‰∫∫</span>
                                            <div class="invalid-feedback">
                                                <i class="fas fa-exclamation-triangle me-1"></i>ËØ∑ËæìÂÖ•ÂÖ•‰Ωè‰∫∫Êï∞
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="checkInDate" class="form-label">
                                            <i class="fas fa-calendar-alt text-primary me-2"></i>ÂÖ•‰ΩèÊó∂Èó¥
                                        </label>
                                        <div class="input-group input-group-lg">
                                            <span class="input-group-text bg-light">
                                                <i class="fas fa-calendar text-primary"></i>
                                            </span>
                                            <input type="date" class="form-control" id="checkInDate"
                                                   name="checkInDate">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Â§áÊ≥®‰ø°ÊÅØÂç°Áâá -->
                        <div class="form-section-card">
                            <div class="section-header">
                                <i class="fas fa-sticky-note"></i>
                                <h6>Â§áÊ≥®‰ø°ÊÅØ</h6>
                            </div>
                            <div class="section-content">
                                <label for="remarks" class="form-label">
                                    <i class="fas fa-edit text-muted me-2"></i>Â§áÊ≥®ËØ¥Êòé
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light">
                                        <i class="fas fa-sticky-note text-muted"></i>
                                    </span>
                                    <textarea class="form-control form-control-lg" id="remarks" name="remarks"
                                              rows="4" placeholder="ËØ∑ËæìÂÖ•Â§áÊ≥®‰ø°ÊÅØÔºàÈÄâÂ°´Ôºâ"></textarea>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>ÂèñÊ∂à
                    </button>
                    <button type="button" class="btn btn-success" id="saveRentalInfo">
                        <i class="fas fa-save me-1"></i>
                        <span id="saveButtonText">‰øùÂ≠ò‰ø°ÊÅØ</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Êü•ÁúãÁßüÊàø‰ø°ÊÅØËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü -->
    <div class="modal fade animate-modal" id="viewRentalInfoModal" tabindex="-1"
         aria-labelledby="viewRentalInfoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content animate-scale-in">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewRentalInfoModalLabel"><i class="fas fa-info-circle me-2"></i>ÁßüÊàø‰ø°ÊÅØËØ¶ÊÉÖ
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="viewRentalInfoBody">
                    <div class="text-center py-5" id="loadingSpinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Âä†ËΩΩ‰∏≠...</p>
                    </div>
                    <div id="rentalInfoDetails" class="animate-fade-in" style="display: none;">
                        <!-- ÁßüÊàø‰ø°ÊÅØËØ¶ÊÉÖÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂ°´ÂÖÖ -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>ÂÖ≥Èó≠
                    </button>
                    <button type="button" class="btn btn-primary" id="editFromView">
                        <i class="fas fa-edit me-1"></i>ÁºñËæë
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Âà†Èô§Á°ÆËÆ§Ê®°ÊÄÅÊ°Ü -->
    <div class="modal fade animate-modal" id="deleteRentalInfoModal" tabindex="-1"
         aria-labelledby="deleteRentalInfoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content animate-scale-in">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteRentalInfoModalLabel"><i
                            class="fas fa-exclamation-triangle me-2"></i>Á°ÆËÆ§Âà†Èô§</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <i class="fas fa-trash-alt text-danger fa-3x mb-3"></i>
                        <p class="lead">Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ÁßüÊàø‰ø°ÊÅØËÆ∞ÂΩïÂêóÔºü</p>
                        <p class="text-muted">Ê≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ</p>
                    </div>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span id="deleteRentalInfoWarning"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>ÂèñÊ∂à
                    </button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteRentalInfo">
                        <i class="fas fa-trash-alt me-1"></i>Á°ÆËÆ§Âà†Èô§
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        // Êõ¥Êñ∞ÂΩìÂâçÊó∂Èó¥
        function updateCurrentTime() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            const timeElement = document.getElementById('currentTime');
            timeElement.textContent = `${hours}:${minutes}:${seconds}`;

            // Ê∑ªÂä†Êó∂Èó¥Êõ¥Êñ∞Âä®Áîª
            timeElement.classList.add('time-update-pulse');
            setTimeout(() => {
                timeElement.classList.remove('time-update-pulse');
            }, 500);
        }

        // ÂàùÂßãÂåñÈ°µÈù¢
        document.addEventListener('DOMContentLoaded', function () {
            // ÊòæÁ§∫Âä†ËΩΩÂä®Áîª
            const loadingOverlay = document.getElementById('globalLoadingOverlay');
            loadingOverlay.classList.add('show');

            // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÈöêËóèÂä†ËΩΩÂä®Áîª
            setTimeout(function () {
                loadingOverlay.classList.remove('show');
            }, 800);

            // Êõ¥Êñ∞Êó∂Èó¥
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);

            // Ê∑ªÂä†Ë°®ÂçïÈ™åËØÅ
            (function () {
                'use strict';

                // Ëé∑ÂèñÊâÄÊúâÈúÄË¶ÅÈ™åËØÅÁöÑË°®Âçï
                const forms = document.querySelectorAll('.needs-validation');

                // Âæ™ÁéØÂπ∂ÈòªÊ≠¢Êèê‰∫§
                Array.from(forms).forEach(form => {
                    form.addEventListener('submit', event => {
                        if (!form.checkValidity()) {
                            event.preventDefault();
                            event.stopPropagation();
                        }

                        form.classList.add('was-validated');
                    }, false);
                });
            })();

            // Á≠õÈÄâÊåâÈíÆ‰∫ã‰ª∂
            document.querySelectorAll('.filter-btn').forEach(button => {
                button.addEventListener('click', function () {
                    // ÁßªÈô§ÊâÄÊúâÊåâÈíÆÁöÑactiveÁ±ª
                    document.querySelectorAll('.filter-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });

                    // Ê∑ªÂä†ÂΩìÂâçÊåâÈíÆÁöÑactiveÁ±ª
                    this.classList.add('active');

                    // Ëé∑ÂèñÁ≠õÈÄâÂÄº
                    const filter = this.getAttribute('data-filter');

                    // Á≠õÈÄâË°®Ê†ºË°å
                    const rows = document.querySelectorAll('.rental-info-row');
                    rows.forEach(row => {
                        if (filter === 'all') {
                            row.style.display = '';
                        } else if (filter === 'paid' && !row.classList.contains('unpaid-row')) {
                            row.style.display = '';
                        } else if (filter === 'unpaid' && row.classList.contains('unpaid-row')) {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                    });
                });
            });

            // ÊêúÁ¥¢ÂäüËÉΩ
            const searchInput = document.getElementById('searchInput');
            const clearSearch = document.getElementById('clearSearch');
            const searchSuggestions = document.getElementById('searchSuggestions');
            let selectedSuggestionIndex = -1;

            // Ëé∑ÂèñÊâÄÊúâÁßüÊàøÊï∞ÊçÆÁî®‰∫éÊêúÁ¥¢Âª∫ËÆÆ
            const rentalData = [];
            document.querySelectorAll('.rental-info-row').forEach(row => {
                const roomNumber = row.querySelector('.room-badge').textContent.trim().replace('üè†', '').trim();
                const tenantName = row.querySelector('.tenant-name').textContent.trim();
                const phone = row.querySelector('.phone-info span').textContent.trim();

                rentalData.push({
                    roomNumber: roomNumber,
                    tenantName: tenantName,
                    phone: phone,
                    element: row
                });
            });

            // Èò≤ÊäñÂáΩÊï∞
            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            // ÊêúÁ¥¢ÂáΩÊï∞
            function performSearch() {
                const searchTerm = searchInput.value.toLowerCase().trim();
                const rows = document.querySelectorAll('.rental-info-row');
                let visibleCount = 0;
                selectedSuggestionIndex = -1;

                if (searchTerm === '') {
                    // Â¶ÇÊûúÊêúÁ¥¢Ê°Ü‰∏∫Á©∫ÔºåÊòæÁ§∫ÊâÄÊúâË°å
                    rows.forEach(row => {
                        row.style.display = '';
                        row.classList.remove('search-highlight');
                        visibleCount++;
                    });
                    searchSuggestions.style.display = 'none';
                    updateSearchResultsInfo(visibleCount, rows.length);
                    return;
                }

                // ÊêúÁ¥¢ÂåπÈÖç
                const suggestions = [];
                rows.forEach(row => {
                    const roomNumber = row.querySelector('.room-badge').textContent.trim().replace(/üè†|\s/g, '').toLowerCase();
                    const tenantName = row.querySelector('.tenant-name').textContent.toLowerCase().trim();
                    const phone = row.querySelector('.phone-info span').textContent.toLowerCase().trim();

                    const isMatch = roomNumber.includes(searchTerm) ||
                        tenantName.includes(searchTerm) ||
                        phone.includes(searchTerm);

                    if (isMatch) {
                        row.style.display = '';
                        row.classList.add('search-highlight');
                        visibleCount++;

                        // È´ò‰∫ÆÂåπÈÖçÁöÑÊñáÊú¨
                        highlightSearchText(row, searchTerm);
                    } else {
                        row.style.display = 'none';
                        row.classList.remove('search-highlight');
                        clearHighlight(row);
                    }
                });

                // ÁîüÊàêÊêúÁ¥¢Âª∫ËÆÆ
                if (searchTerm.length > 0) {
                    generateSearchSuggestions(searchTerm, rentalData, suggestions);
                }

                updateSearchResultsInfo(visibleCount, rows.length);
            }

            // Ê∑ªÂä†Èò≤ÊäñÁöÑÊêúÁ¥¢‰∫ã‰ª∂ÁõëÂê¨
            searchInput.addEventListener('input', debounce(performSearch, 300));

            // ÈîÆÁõòÂØºËà™
            searchInput.addEventListener('keydown', function (e) {
                const suggestionItems = searchSuggestions.querySelectorAll('.search-suggestion-item');

                if (suggestionItems.length === 0) return;

                switch (e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, suggestionItems.length - 1);
                        updateSuggestionSelection(suggestionItems);
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
                        updateSuggestionSelection(suggestionItems);
                        break;
                    case 'Enter':
                        e.preventDefault();
                        if (selectedSuggestionIndex >= 0 && selectedSuggestionIndex < suggestionItems.length) {
                            suggestionItems[selectedSuggestionIndex].click();
                        }
                        break;
                    case 'Escape':
                        searchSuggestions.style.display = 'none';
                        selectedSuggestionIndex = -1;
                        break;
                }
            });

            // Ê∏ÖÈô§ÊêúÁ¥¢
            clearSearch.addEventListener('click', function () {
                searchInput.value = '';
                const rows = document.querySelectorAll('.rental-info-row');
                rows.forEach(row => {
                    row.style.display = '';
                    row.classList.remove('search-highlight');
                    clearHighlight(row);
                });
                searchSuggestions.style.display = 'none';
                selectedSuggestionIndex = -1;
                updateSearchResultsInfo(rows.length, rows.length);
            });

            // ÊêúÁ¥¢Ê°ÜËé∑ÂæóÁÑ¶ÁÇπÊó∂ÊòæÁ§∫ÊêúÁ¥¢ÂéÜÂè≤
            searchInput.addEventListener('focus', function () {
                if (this.value.trim() === '') {
                    const history = getSearchHistory();
                    if (history.length > 0) {
                        let suggestionsHTML = '<div class="search-history-header">ÊúÄËøëÊêúÁ¥¢</div>';
                        history.slice(0, 5).forEach(term => {
                            suggestionsHTML += `
                                <div class="search-suggestion-item search-history-item" data-search-term="${term}">
                                    <i class="fas fa-history me-2 text-muted"></i>
                                    <span class="suggestion-history">${term}</span>
                                    <button class="btn btn-sm btn-link ms-auto p-0 text-muted remove-history" data-term="${term}" title="Âà†Èô§">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            `;
                        });

                        searchSuggestions.innerHTML = suggestionsHTML;
                        searchSuggestions.style.display = 'block';
                        addSuggestionClickEvents();
                        addRemoveHistoryEvents();
                    }
                }
            });

            // Âà†Èô§ÊêúÁ¥¢ÂéÜÂè≤‰∫ã‰ª∂
            function addRemoveHistoryEvents() {
                searchSuggestions.querySelectorAll('.remove-history').forEach(btn => {
                    btn.addEventListener('click', function (e) {
                        e.stopPropagation();
                        const term = this.dataset.term;
                        removeSearchHistory(term);

                        // ÈáçÊñ∞ÊòæÁ§∫ÂéÜÂè≤
                        if (searchInput.value.trim() === '') {
                            searchInput.focus();
                        }
                    });
                });
            }

            // Âà†Èô§ÊêúÁ¥¢ÂéÜÂè≤È°π
            function removeSearchHistory(termToRemove) {
                let history = getSearchHistory();
                history = history.filter(term => term !== termToRemove);
                localStorage.setItem('rentalSearchHistory', JSON.stringify(history));
            }

            // ÁÇπÂáªÂ§ñÈÉ®Êó∂ÈöêËóèÊêúÁ¥¢Âª∫ËÆÆ
            document.addEventListener('click', function (event) {
                if (!event.target.closest('.search-container')) {
                    searchSuggestions.style.display = 'none';
                }
            });

            // È´ò‰∫ÆÊêúÁ¥¢ÊñáÊú¨
            function highlightSearchText(row, searchTerm) {
                const elements = [
                    row.querySelector('.room-badge'),
                    row.querySelector('.tenant-name'),
                    row.querySelector('.phone-info span')
                ];

                elements.forEach(element => {
                    if (element) {
                        const text = element.textContent;
                        const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                        if (regex.test(text)) {
                            element.innerHTML = text.replace(regex, '<mark class="search-match">$1</mark>');
                        }
                    }
                });
            }

            // Ê∏ÖÈô§È´ò‰∫Æ
            function clearHighlight(row) {
                const elements = [
                    row.querySelector('.room-badge'),
                    row.querySelector('.tenant-name'),
                    row.querySelector('.phone-info span')
                ];

                elements.forEach(element => {
                    if (element && element.querySelector('mark')) {
                        element.innerHTML = element.textContent;
                    }
                });
            }

            // ÁîüÊàêÊêúÁ¥¢Âª∫ËÆÆ
            function generateSearchSuggestions(searchTerm, data, suggestions) {
                selectedSuggestionIndex = -1;

                // Ëé∑ÂèñÊô∫ËÉΩÂåπÈÖçÁªìÊûú
                const matches = data.map(item => {
                    const roomScore = getMatchScore(item.roomNumber, searchTerm);
                    const nameScore = getMatchScore(item.tenantName, searchTerm);
                    const phoneScore = getMatchScore(item.phone, searchTerm);
                    const maxScore = Math.max(roomScore, nameScore, phoneScore);

                    return {
                        ...item,
                        score: maxScore,
                        matchType: roomScore === maxScore ? 'room' :
                            nameScore === maxScore ? 'name' : 'phone'
                    };
                }).filter(item => item.score > 0)
                    .sort((a, b) => b.score - a.score)
                    .slice(0, 5);

                // Â¶ÇÊûúÊ≤°ÊúâÂåπÈÖçÈ°πÔºåÊòæÁ§∫ÊêúÁ¥¢ÂéÜÂè≤
                if (matches.length === 0 && searchTerm.length > 0) {
                    const history = getSearchHistory().filter(term =>
                        term.toLowerCase().includes(searchTerm.toLowerCase())
                    ).slice(0, 3);

                    if (history.length > 0) {
                        let suggestionsHTML = '<div class="search-history-header">ÊêúÁ¥¢ÂéÜÂè≤</div>';
                        history.forEach(term => {
                            suggestionsHTML += `
                                <div class="search-suggestion-item search-history-item" data-search-term="${term}">
                                    <i class="fas fa-history me-2 text-muted"></i>
                                    <span class="suggestion-history">${term}</span>
                                </div>
                            `;
                        });

                        searchSuggestions.innerHTML = suggestionsHTML;
                        searchSuggestions.style.display = 'block';
                        addSuggestionClickEvents();
                        return;
                    }
                }

                if (matches.length > 0) {
                    let suggestionsHTML = '';
                    matches.forEach(match => {
                        const highlightClass = match.matchType === 'room' ? 'text-primary' :
                            match.matchType === 'name' ? 'text-success' : 'text-info';

                        suggestionsHTML += `
                            <div class="search-suggestion-item" data-room="${match.roomNumber}" data-tenant="${match.tenantName}" data-phone="${match.phone}">
                                <i class="fas fa-home me-2 ${highlightClass}"></i>
                                <span class="suggestion-room ${match.matchType === 'room' ? highlightClass : ''}">${highlightSearchTerm(match.roomNumber, searchTerm)}</span>
                                <span class="suggestion-tenant ${match.matchType === 'name' ? highlightClass : ''}">${highlightSearchTerm(match.tenantName, searchTerm)}</span>
                                <span class="suggestion-phone text-muted ${match.matchType === 'phone' ? highlightClass : ''}">${highlightSearchTerm(match.phone, searchTerm)}</span>
                            </div>
                        `;
                    });

                    searchSuggestions.innerHTML = suggestionsHTML;
                    searchSuggestions.style.display = 'block';
                    addSuggestionClickEvents();
                } else {
                    searchSuggestions.style.display = 'none';
                }
            }

            // È´ò‰∫ÆÂª∫ËÆÆ‰∏≠ÁöÑÊêúÁ¥¢ËØç
            function highlightSearchTerm(text, searchTerm) {
                if (!searchTerm || searchTerm.length < 1) return text;

                const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                return text.replace(regex, '<strong>$1</strong>');
            }

            // Ê∑ªÂä†Âª∫ËÆÆÈ°πÁÇπÂáª‰∫ã‰ª∂
            function addSuggestionClickEvents() {
                searchSuggestions.querySelectorAll('.search-suggestion-item').forEach(item => {
                    item.addEventListener('click', function () {
                        let searchValue = '';

                        if (this.classList.contains('search-history-item')) {
                            searchValue = this.dataset.searchTerm;
                        } else {
                            // Ê†πÊçÆÂåπÈÖçÁ±ªÂûãÈÄâÊã©ÊêúÁ¥¢ÂÄº
                            const room = this.dataset.room;
                            const tenant = this.dataset.tenant;
                            const phone = this.dataset.phone;

                            // ‰ºòÂÖà‰ΩøÁî®ÁßüÂÆ¢ÂßìÂêçÔºåÂõ†‰∏∫ËøôÊòØÊúÄÂ∏∏Áî®ÁöÑÊêúÁ¥¢ÊñπÂºè
                            searchValue = tenant || room || phone;
                        }

                        searchInput.value = searchValue;
                        saveSearchHistory(searchValue);

                        // Ëß¶ÂèëÊêúÁ¥¢
                        performSearch();
                        searchSuggestions.style.display = 'none';
                        selectedSuggestionIndex = -1;
                    });
                });
            }

            // Êõ¥Êñ∞Âª∫ËÆÆÈÄâÊã©Áä∂ÊÄÅ
            function updateSuggestionSelection(suggestionItems) {
                suggestionItems.forEach((item, index) => {
                    if (index === selectedSuggestionIndex) {
                        item.classList.add('selected');
                        item.scrollIntoView({block: 'nearest'});
                    } else {
                        item.classList.remove('selected');
                    }
                });
            }

            // Êõ¥Êñ∞ÊêúÁ¥¢ÁªìÊûú‰ø°ÊÅØ
            function updateSearchResultsInfo(visibleCount, totalCount) {
                // Âú®ÊêúÁ¥¢Ê°Ü‰∏ãÊñπÊòæÁ§∫ÊêúÁ¥¢ÁªìÊûúÁªüËÆ°
                let resultInfo = document.querySelector('.search-result-info');
                if (!resultInfo) {
                    resultInfo = document.createElement('div');
                    resultInfo.className = 'search-result-info mt-2 text-muted small';
                    searchInput.parentNode.parentNode.appendChild(resultInfo);
                }

                if (searchInput.value.trim() !== '') {
                    resultInfo.textContent = `ÊâæÂà∞ ${visibleCount} Êù°ËÆ∞ÂΩïÔºàÂÖ± ${totalCount} Êù°Ôºâ`;
                    resultInfo.style.display = 'block';
                } else {
                    resultInfo.style.display = 'none';
                }
            }

            // Êô∫ËÉΩÊêúÁ¥¢ÂåπÈÖçÂáΩÊï∞
            function getMatchScore(text, searchTerm) {
                text = text.toLowerCase();
                searchTerm = searchTerm.toLowerCase();

                if (text === searchTerm) return 100;
                if (text.startsWith(searchTerm)) return 80;
                if (text.includes(searchTerm)) return 60;

                // Ê®°Á≥äÂåπÈÖç
                let score = 0;
                let searchIndex = 0;
                for (let i = 0; i < text.length && searchIndex < searchTerm.length; i++) {
                    if (text[i] === searchTerm[searchIndex]) {
                        score++;
                        searchIndex++;
                    }
                }
                return searchIndex === searchTerm.length ? score * 2 : 0;
            }

            // Ëé∑ÂèñÊêúÁ¥¢ÂéÜÂè≤
            function getSearchHistory() {
                const history = localStorage.getItem('rentalSearchHistory');
                return history ? JSON.parse(history) : [];
            }

            // ‰øùÂ≠òÊêúÁ¥¢ÂéÜÂè≤
            function saveSearchHistory(searchTerm) {
                if (searchTerm.trim().length < 2) return;

                let history = getSearchHistory();
                history = history.filter(item => item !== searchTerm);
                history.unshift(searchTerm);
                history = history.slice(0, 10); // ‰øùÁïôÊúÄËøë10Êù°

                localStorage.setItem('rentalSearchHistory', JSON.stringify(history));
            }
        });

        // ‰øùÂ≠òÁßüÊàø‰ø°ÊÅØ
        document.getElementById('saveRentalInfo').addEventListener('click', function () {
            const form = document.getElementById('rentalInfoForm');
            const formData = new FormData(form);
            const id = document.getElementById('rentalInfoId').value;

            // È™åËØÅË°®Âçï
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                return;
            }

            // ÊûÑÂª∫Êï∞ÊçÆÂØπË±°
            const data = {
                room_number: formData.get('roomNumber'),
                tenant_name: formData.get('tenantName'),
                phone: formData.get('phone'),
                deposit: formData.get('deposit'),
                occupant_count: formData.get('occupantCount'),
                check_in_date: formData.get('checkInDate'),
                rental_status: document.getElementById('rentalStatus').value,
                remarks: document.getElementById('remarks').value
            };

            // ÂèëÈÄÅËØ∑Ê±Ç
            const url = id ? `/api/rental_info_new/${id}` : '/api/rental_info_new';
            const method = id ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification(data.message, 'success');
                        // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
                        const modal = bootstrap.Modal.getInstance(document.getElementById('rentalInfoModal'));
                        modal.hide();
                        // Âà∑Êñ∞È°µÈù¢
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    } else {
                        showNotification(data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('‰øùÂ≠òÂ§±Ë¥•:', error);
                    showNotification('‰øùÂ≠òÂ§±Ë¥•: ' + error.message, 'error');
                });
        });

        // ÈÄöÁü•Á≥ªÁªü
        function showNotification(message, type = 'info') {
            // ÂàõÂª∫ÈÄöÁü•ÂÖÉÁ¥†
            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show notification-toast`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 9999;
                min-width: 300px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;

            notification.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-triangle' : 'fa-info-circle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(notification);

            // Ëá™Âä®ÁßªÈô§
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        // Ê∑ªÂä†ÁßüÊàø‰ø°ÊÅØ
        function addRentalInfo() {
            // ÈáçÁΩÆË°®Âçï
            document.getElementById('rentalInfoForm').reset();
            document.getElementById('rentalInfoForm').classList.remove('was-validated');
            document.getElementById('rentalInfoId').value = '';
            document.getElementById('rentalInfoModalLabel').innerHTML = '<i class="fas fa-plus me-2"></i>Ê∑ªÂä†ÁßüÊàø‰ø°ÊÅØ';

            // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
            const modal = new bootstrap.Modal(document.getElementById('rentalInfoModal'));
            modal.show();
        }

        // Êü•ÁúãÁßüÊàø‰ø°ÊÅØËØ¶ÊÉÖ
        function viewRentalInfo(id) {
            const loadingSpinner = document.getElementById('loadingSpinner');
            const rentalInfoDetails = document.getElementById('rentalInfoDetails');

            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            loadingSpinner.style.display = 'block';
            rentalInfoDetails.style.display = 'none';

            // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
            const modal = new bootstrap.Modal(document.getElementById('viewRentalInfoModal'));
            modal.show();

            // ÂèëÈÄÅAJAXËØ∑Ê±ÇËé∑ÂèñËØ¶ÁªÜ‰ø°ÊÅØ
            fetch(`/api/rental_info_new/${id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }

                    // ÊûÑÂª∫ËØ¶ÊÉÖHTML - ÁæéÂåñÁâà
                    const detailsHTML = `
                        <div class="detail-header">
                            <div class="detail-icon">
                                <i class="fas fa-home"></i>
                            </div>
                            <div class="detail-title">
                                <h4>ÊàøÂè∑ ${data.room_number}</h4>
                                <span class="status-badge ${data.rental_status === 1 ? 'status-paid' : 'status-unpaid'}">
                                    ${data.rental_status_text}
                                </span>
                            </div>
                        </div>
                        
                        <div class="detail-cards">
                            <!-- ÁßüÂÆ¢‰ø°ÊÅØÂç°Áâá -->
                            <div class="detail-card">
                                <div class="card-header">
                                    <i class="fas fa-user-circle"></i>
                                    <span>ÁßüÂÆ¢‰ø°ÊÅØ</span>
                                </div>
                                <div class="card-body">
                                    <div class="info-row">
                                        <i class="fas fa-user text-primary"></i>
                                        <span class="label">ÁßüÂÆ¢ÂßìÂêç</span>
                                        <span class="value">${data.tenant_name}</span>
                                    </div>
                                    <div class="info-row">
                                        <i class="fas fa-phone text-success"></i>
                                        <span class="label">ËÅîÁ≥ªÁîµËØù</span>
                                        <span class="value">${data.phone}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Ë¥¢Âä°‰ø°ÊÅØÂç°Áâá -->
                            <div class="detail-card">
                                <div class="card-header">
                                    <i class="fas fa-credit-card"></i>
                                    <span>Ë¥¢Âä°‰ø°ÊÅØ</span>
                                </div>
                                <div class="card-body">
                                    <div class="info-row">
                                        <i class="fas fa-money-bill-wave text-warning"></i>
                                        <span class="label">ÊäºÈáëÈáëÈ¢ù</span>
                                        <span class="value money">¬•${data.deposit.toFixed(2)}</span>
                                    </div>
                                    <div class="info-row">
                                        <i class="fas fa-calendar-check text-info"></i>
                                        <span class="label">ÂÖ•‰ΩèÊó∂Èó¥</span>
                                        <span class="value">${data.check_in_date || 'Êú™ÂÖ•‰Ωè'}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Á≥ªÁªü‰ø°ÊÅØÂç°Áâá -->
                            <div class="detail-card">
                                <div class="card-header">
                                    <i class="fas fa-info-circle"></i>
                                    <span>Á≥ªÁªü‰ø°ÊÅØ</span>
                                </div>
                                <div class="card-body">
                                    <div class="info-row">
                                        <i class="fas fa-users text-secondary"></i>
                                        <span class="label">ÂÖ•‰Ωè‰∫∫Êï∞</span>
                                        <span class="value">${data.occupant_count} ‰∫∫</span>
                                    </div>
                                    <div class="info-row">
                                        <i class="fas fa-clock text-muted"></i>
                                        <span class="label">ÂàõÂª∫Êó∂Èó¥</span>
                                        <span class="value">${data.created_at}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Â§áÊ≥®‰ø°ÊÅØÂç°Áâá -->
                            <div class="detail-card full-width">
                                <div class="card-header">
                                    <i class="fas fa-sticky-note"></i>
                                    <span>Â§áÊ≥®‰ø°ÊÅØ</span>
                                </div>
                                <div class="card-body">
                                    <div class="remarks-content">
                                        <i class="fas fa-quote-left text-muted"></i>
                                        <p>${data.remarks || 'ÊöÇÊó†Â§áÊ≥®‰ø°ÊÅØ'}</p>
                                        <i class="fas fa-quote-right text-muted"></i>
                                    </div>
                                </div>
                            </div>
                        </div>


                    `;

                    rentalInfoDetails.innerHTML = detailsHTML;
                    loadingSpinner.style.display = 'none';
                    rentalInfoDetails.style.display = 'block';
                })
                .catch(error => {
                    console.error('Ëé∑ÂèñÁßüÊàø‰ø°ÊÅØÂ§±Ë¥•:', error);
                    rentalInfoDetails.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Ëé∑ÂèñÁßüÊàø‰ø°ÊÅØÂ§±Ë¥•: ${error.message}
                        </div>
                    `;
                    loadingSpinner.style.display = 'none';
                    rentalInfoDetails.style.display = 'block';
                });

            // ËÆæÁΩÆÁºñËæëÊåâÈíÆÁöÑ‰∫ã‰ª∂
            document.getElementById('editFromView').onclick = function () {
                modal.hide();
                editRentalInfo(id);
            };
        }

        // ÁºñËæëÁßüÊàø‰ø°ÊÅØ
        function editRentalInfo(id) {
            // ÈáçÁΩÆË°®Âçï
            const form = document.getElementById('rentalInfoForm');
            form.reset();
            form.classList.remove('was-validated'); // ÁßªÈô§È™åËØÅÁä∂ÊÄÅ
            document.getElementById('rentalInfoId').value = id;
            document.getElementById('rentalInfoModalLabel').innerHTML = '<i class="fas fa-edit me-2"></i>ÁºñËæëÁßüÊàø‰ø°ÊÅØ';

            // Ëé∑ÂèñÁßüÊàø‰ø°ÊÅØËØ¶ÊÉÖÂπ∂Â°´ÂÖÖË°®Âçï
            fetch(`/api/rental_info_new/${id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }

                    // Â°´ÂÖÖË°®ÂçïÊï∞ÊçÆ
                    document.getElementById('roomNumber').value = data.room_number;
                    document.getElementById('tenantName').value = data.tenant_name;
                    document.getElementById('phone').value = data.phone;
                    document.getElementById('deposit').value = data.deposit;
                    document.getElementById('occupantCount').value = data.occupant_count;
                    document.getElementById('checkInDate').value = data.check_in_date;
                    document.getElementById('rentalStatus').value = data.rental_status;
                    document.getElementById('remarks').value = data.remarks;
                })
                .catch(error => {
                    console.error('Ëé∑ÂèñÁßüÊàø‰ø°ÊÅØÂ§±Ë¥•:', error);
                    showNotification('Ëé∑ÂèñÁßüÊàø‰ø°ÊÅØÂ§±Ë¥•: ' + error.message, 'error');
                });

            // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
            const modal = new bootstrap.Modal(document.getElementById('rentalInfoModal'));
            modal.show();
        }

        // Âà†Èô§ÁßüÊàø‰ø°ÊÅØ
        function deleteRentalInfo(id) {
            document.getElementById('deleteRentalInfoWarning').textContent = 'Âà†Èô§ÁßüÊàø‰ø°ÊÅØÂ∞ÜÂêåÊó∂Âà†Èô§Áõ∏ÂÖ≥ÁöÑÁßüËµÅËÆ∞ÂΩïÂíåÁº¥Ë¥πËÆ∞ÂΩï„ÄÇ';

            // ËÆæÁΩÆÁ°ÆËÆ§ÊåâÈíÆÁöÑ‰∫ã‰ª∂
            document.getElementById('confirmDeleteRentalInfo').onclick = function () {
                // ÂèëÈÄÅÂà†Èô§ËØ∑Ê±Ç
                fetch(`/api/rental_info_new/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showNotification(data.message, 'success');
                            // Âà∑Êñ∞È°µÈù¢
                            setTimeout(() => {
                                location.reload();
                            }, 1000);
                        } else {
                            showNotification(data.message, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Âà†Èô§Â§±Ë¥•:', error);
                        showNotification('Âà†Èô§Â§±Ë¥•: ' + error.message, 'error');
                    });

                // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
                const modal = bootstrap.Modal.getInstance(document.getElementById('deleteRentalInfoModal'));
                modal.hide();
            };

            // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
            const modal = new bootstrap.Modal(document.getElementById('deleteRentalInfoModal'));
            modal.show();
        }

        // ÂØºÂá∫ÁßüÊàø‰ø°ÊÅØ
        function exportRentalInfo(type) {
            alert(`ÂØºÂá∫${type}ÁßüÊàø‰ø°ÊÅØÂäüËÉΩÂ∞öÊú™ÂÆûÁé∞`);
        }

        // ÊòæÁ§∫ÁßüÊàø‰ø°ÊÅØÊ±áÊÄª
        function showRentalInfoSummary() {
            alert('ÁßüÊàø‰ø°ÊÅØÊ±áÊÄªÂäüËÉΩÂ∞öÊú™ÂÆûÁé∞');
        }

        // Âä†ËΩΩÁ©∫Èó≤ÊàøÈó¥ÂàóË°®
        function loadAvailableRooms() {
            fetch('/api/available_rooms_new')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const roomSelect = document.getElementById('roomNumber');
                        // Ê∏ÖÁ©∫Áé∞ÊúâÈÄâÈ°πÔºà‰øùÁïôÈªòËÆ§ÈÄâÈ°πÔºâ
                        roomSelect.innerHTML = '<option value="">ËØ∑ÈÄâÊã©Á©∫Èó≤ÊàøÈó¥</option>';

                        // Ê∑ªÂä†Á©∫Èó≤ÊàøÈó¥ÈÄâÈ°π
                        data.rooms.forEach(room => {
                            const option = document.createElement('option');
                            option.value = room.room_number;
                            option.textContent = `${room.room_number} - ${room.room_type} (Âü∫Á°ÄÁßüÈáë: ¬•${room.base_rent})`;
                            roomSelect.appendChild(option);
                        });
                    } else {
                        console.error('Âä†ËΩΩÁ©∫Èó≤ÊàøÈó¥Â§±Ë¥•:', data.message);
                        showNotification('Âä†ËΩΩÁ©∫Èó≤ÊàøÈó¥Â§±Ë¥•: ' + data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('Âä†ËΩΩÁ©∫Èó≤ÊàøÈó¥Â§±Ë¥•:', error);
                    showNotification('Âä†ËΩΩÁ©∫Èó≤ÊàøÈó¥Â§±Ë¥•: ' + error.message, 'error');
                });
        }

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÊâßË°å
        document.addEventListener('DOMContentLoaded', function () {
            loadAvailableRooms();
        });
    </script>
{% endblock %}